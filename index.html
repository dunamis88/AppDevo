<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bible Note</title>
    <!-- SEO & PWA Meta -->
    <meta name="description" content="Tu compañero diario para el devocional, lectura bíblica y oración. 100% offline.">
    <meta name="theme-color" id="meta-theme-color" content="#2D294D">
    <link rel="manifest" href="manifest.json">

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Poppins:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>

    <style>
        :root {
            /* Light Theme */
            --bg-body: #F8F9FD;
            --bg-card: #FFFFFF;
            --text-main: #2D3250;
            --text-muted: #707793;
            --primary: #6E56CF;
            --secondary: #45AEE9;
            --accent: #f8bb2a;
            --pink: #F04C7D;
            --success: #48BB78;
            --border: #E8EDF5;
            --shadow: 0 10px 25px rgba(110, 86, 207, 0.05);
            --nav-bg: rgba(255, 255, 255, 0.9);
            --radius-lg: 28px;
            --radius-md: 18px;
            --calendar-past: #BDC3C7;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-body: #2D294D;
            --bg-card: #3A355F;
            --text-main: #FFFFFF;
            --text-muted: #A09DB1;
            --border: #4A4475;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            --nav-bg: rgba(45, 41, 77, 0.95);
            --calendar-past: #4A4475;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Allow selection only for user content */
        .oia-card textarea,
        .note-tile,
        .prayer-tile,
        #note-input,
        #p-title,
        #p-details,
        input[type="text"],
        textarea {
            user-select: text;
            -webkit-user-select: text;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1,
        h2,
        h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            margin: 0;
        }

        .glass {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Onboarding */
        #onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-body);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        /* Header */
        header {
            padding: 20px 24px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .avatar-small {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(110, 86, 207, 0.3);
        }

        .avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-small i {
            color: white;
            stroke-width: 2.5;
        }

        .theme-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        /* Main Scroll Area */
        main {
            padding: 10px 24px 120px;
        }

        .view {
            display: none;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .view.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Date Container - Clickable */
        .date-navigator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-card);
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .nav-arrow {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--bg-body);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-arrow:active {
            transform: scale(0.9);
            background: var(--border);
        }

        .nav-arrow:disabled {
            opacity: 0.1;
            cursor: default;
        }

        #date-display-trigger {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            text-transform: capitalize;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 10px;
            transition: 0.2s;
        }

        #date-display-trigger:active {
            background: var(--bg-body);
        }

        /* Forms */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
            resize: none;
            overflow: hidden;
        }

        input:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(110, 86, 207, 0.1);
        }

        .date-picker-placeholder {
            width: 100%;
            padding: 14px 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bible-selector-card {
            background: var(--bg-card);
            padding: 14px 20px;
            border-radius: 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .bible-selector-card:active {
            transform: scale(0.98);
            background: var(--bg-body);
        }

        .bible-selector-card.disabled {
            opacity: 0.5;
            cursor: default;
        }

        .bible-selector-card i {
            color: var(--primary);
            width: 18px;
        }

        .oia-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .oia-card.accent-card {
            border-left: 6px solid var(--accent);
        }

        .oia-card.o-card {
            border-left: 6px solid var(--secondary);
        }

        .oia-card.i-card {
            border-left: 6px solid var(--pink);
        }

        .oia-card.a-card {
            border-left: 6px solid var(--success);
        }

        .oia-card i {
            color: var(--primary);
            margin-bottom: 10px;
            display: block;
        }

        .oia-card.o-card i {
            color: var(--secondary);
        }

        .oia-card.i-card i {
            color: var(--pink);
        }

        .oia-card.a-card i {
            color: var(--success);
        }

        .oia-card.accent-card i {
            color: var(--accent);
        }

        .oia-card h3 {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* Floating Save */
        .devotional-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            margin-bottom: 40px;
        }

        #save-fab,
        #share-fab {
            flex: 1;
            height: 54px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            gap: 10px;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow);
        }

        #save-fab {
            color: white;
            background: var(--primary);
        }

        .fab-unsaved {
            background: var(--secondary) !important;
            transform: scale(1.02);
        }

        .fab-saved {
            background: var(--success) !important;
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.2) !important;
        }

        .fab-disabled {
            background: var(--text-muted) !important;
            opacity: 0.5;
            cursor: default;
            transform: scale(0.95) !important;
            box-shadow: none !important;
        }

        .fab-locked {
            background: var(--accent) !important;
            color: white !important;
        }

        #share-fab {
            background: var(--bg-card);
            color: var(--primary);
            border: 1px solid var(--border);
        }

        #share-fab:active,
        #save-fab:active {
            transform: scale(0.95);
        }

        /* Progress Bar */
        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 30px;
            text-align: center;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .progress-track {
            height: 14px;
            background: var(--bg-body);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            border: 1px solid var(--border);
        }

        .progress-thumb {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: 1s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
        }

        /* Bible List */
        .book-item {
            background: var(--bg-card);
            padding: 16px 20px;
            border-radius: 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: 0.3s;
        }

        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .book-item.completed {
            border-left: 5px solid var(--success);
        }

        .book-item.started {
            border-left: 5px solid var(--secondary);
        }

        .chapter-pill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
            gap: 10px;
            padding-top: 16px;
            display: none;
        }

        .chapter-pill {
            height: 44px;
            border-radius: 14px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .chapter-pill.read {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .complete-book-row {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-body);
            padding: 12px 16px;
            border-radius: 14px;
            margin-bottom: 15px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-main);
            border: 1px solid var(--border);
        }

        .complete-book-row input {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
        }

        /* Prayers */
        .prayer-tile {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: 0.3s;
        }

        .prayer-tile:active {
            transform: scale(0.98);
        }

        .prayer-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            margin-top: 0;
        }

        .prayer-tile.expanded .prayer-body {
            max-height: 1000px;
            /* Large enough */
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border);
        }

        .prayer-tile h3 {
            font-size: 16px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            word-break: break-word;
        }

        .prayer-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .prayer-tile p {
            word-break: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
            margin: 0;
        }

        .prayer-btns {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn {
            border: none;
            padding: 12px 20px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-outline {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-icon {
            padding: 8px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-icon:hover {
            background: var(--border);
            color: var(--primary);
        }

        .btn-full {
            width: 100%;
            padding: 16px;
            border-radius: 18px;
            font-size: 16px;
        }

        .btn-prayed {
            background: var(--success) !important;
            color: white !important;
            border-color: var(--success) !important;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.2);
        }

        .view-locked textarea {
            pointer-events: none;
            background: rgba(0, 0, 0, 0.02);
        }

        /* Notes Section */
        .note-tile {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 12px 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: 0.3s;
        }

        .note-tile:active {
            transform: scale(0.98);
        }

        .note-tile h3 {
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .note-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .note-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-muted);
            margin-top: 0;
        }

        .note-text-content {
            white-space: pre-wrap;
            color: var(--text-main);
        }

        .note-tile.expanded .note-body {
            max-height: 1000px;
            margin-top: 4px;
            padding-top: 4px;
        }

        .note-verse-text {
            font-size: 15px;
            font-style: italic;
            color: white;
            background: var(--primary);
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 4px 12px rgba(110, 86, 207, 0.15);
        }

        .note-verse-text::before {
            content: '“';
            font-size: 30px;
            position: absolute;
            top: -5px;
            left: 5px;
            opacity: 0.2;
            font-family: serif;
        }

        .note-verse-text::after {
            content: '”';
            font-size: 30px;
            position: absolute;
            bottom: -15px;
            right: 5px;
            opacity: 0.2;
            font-family: serif;
        }

        .note-version-tag {
            font-size: 10px;
            background: rgba(110, 86, 207, 0.1);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 6px;
            margin-left: 8px;
            text-transform: uppercase;
            font-weight: 800;
        }

        .sort-group {
            display: flex;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 12px;
            gap: 4px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .sort-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: none;
            border-radius: 9px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .sort-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(110, 86, 207, 0.2);
        }

        .view-locked .bible-selector-card {
            pointer-events: none;
            opacity: 0.7;
        }

        .fab-locked {
            background: var(--bg-card) !important;
            color: var(--primary) !important;
            border: 1px solid var(--border) !important;
            box-shadow: var(--shadow) !important;
        }

        #camera-modal video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            background: #000;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn-capture {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: white;
            border: 5px solid var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: 0.2s;
        }

        .btn-capture:active {
            transform: scale(0.9);
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5000;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 14px 24px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 14px;
            animation: toastIn 0.5s cubic-bezier(0.16, 1, 0.3, 1), toastOut 0.5s 2.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            white-space: nowrap;
        }

        @keyframes toastIn {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes toastOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }

            to {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        /* Bottom Navbar - Anchored */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(64px + env(safe-area-inset-bottom));
            background: var(--nav-bg);
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.1);
            border-top: 1px solid var(--border);
            z-index: 1800;
        }

        .nav-item {
            border: none;
            background: none;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            transition: 0.3s;
            padding: 8px;
            border-radius: 16px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        /* CALENDAR COMPONENT - Matching Image */
        .calendar-card {
            background: var(--bg-body);
            border-radius: 32px 32px 0 0;
            /* Solo arriba */
            padding: 24px 24px 40px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
            animation: slideSheet 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            text-transform: capitalize;
        }

        .calendar-nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 15px;
        }

        .calendar-weekdays span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
            opacity: 0.8;
        }

        .calendar-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-main);
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        .calendar-day.prev-month,
        .calendar-day.next-month {
            opacity: 0.2;
        }

        /* The Bubbles from image */
        .calendar-day.selected::before {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            z-index: -1;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .calendar-day.selected {
            color: white;
            font-weight: 700;
        }

        /* Various colored bubbles for gamification/status */
        .calendar-day.has-content {
            color: var(--accent);
            font-weight: 700;
        }

        .calendar-day.has-content::before {
            content: '';
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            opacity: 0.4;
            z-index: -1;
        }

        .calendar-day.has-content::after {
            content: '';
            position: absolute;
            bottom: 6px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        .calendar-day.today {
            color: var(--primary);
            font-weight: 800;
            text-decoration: underline;
        }

        /* Verses Grid */
        .verse-pill-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .verse-pill {
            height: 44px;
            border-radius: 12px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .verse-pill.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .verse-pill.in-range {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
            opacity: 0.7;
        }

        .calendar-day.disabled {
            cursor: default;
            opacity: 0.05;
        }

        /* Dropdown Selectors for Birthdate */
        .birth-selectors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr;
            gap: 10px;
            margin: 20px 0;
            display: none;
        }

        .birth-selectors-grid select {
            padding: 14px 10px;
            font-size: 14px;
            border-radius: 12px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-family: inherit;
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: flex-end;
            /* Anclado abajo */
            justify-content: center;
            z-index: 2500;
            padding: 0;
        }

        .modal-sheet {
            background: var(--bg-body);
            width: 100%;
            max-width: 500px;
            padding: 24px 24px 40px;
            border-radius: 32px 32px 0 0;
            animation: slideSheet 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideSheet {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes slideSheetOut {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(100%);
            }
        }

        .modal-sheet.closing,
        .calendar-card.closing {
            animation: slideSheetOut 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Profile Photo */
        .photo-picker {
            width: 90px;
            height: 90px;
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 28px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .photo-picker img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            background: var(--primary);
            color: white;
        }

        /* Bible Reader Styles */
        .reader-controls {
            background: var(--bg-card);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .reader-selectors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 12px;
        }

        .reader-selectors select {
            padding: 12px 10px;
            font-size: 14px;
            border-radius: 12px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .reader-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            min-height: 400px;
            line-height: 1.8;
            font-size: 17px;
            text-align: justify;
        }

        .verse-item {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .verse-num-badge {
            font-size: 15px;
            font-weight: 800;
            color: var(--primary);
            min-width: 22px;
            text-align: left;
            margin-top: 2px;
            opacity: 0.9;
            flex-shrink: 0;
        }

        .verse-text {
            flex: 1;
            font-size: 18px;
            line-height: 1.65;
            letter-spacing: -0.01em;
        }

        .reader-nav-btns {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .version-pills-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0 12px;
            scrollbar-width: none;
        }

        .version-pills-container::-webkit-scrollbar {
            display: none;
        }

        .version-pill-item {
            white-space: nowrap;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-muted);
        }

        .version-pill-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(110, 86, 207, 0.2);
        }

        /* Reader Features Styles */
        .verse-item {
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 8px;
            padding: 4px;
            margin-left: -4px;
            margin-right: -4px;
        }

        .verse-item.selected-ui {
            background: rgba(110, 86, 207, 0.15);
            outline: 2px dashed var(--primary);
        }

        .highlight-yellow {
            background: #ffec99;
            color: #5c4000;
        }

        .highlight-green {
            background: #b2f2bb;
            color: #1e4d2b;
        }

        .highlight-blue {
            background: #a5d8ff;
            color: #184c71;
        }

        .highlight-pink {
            background: #ffbcda;
            color: #7a1b3c;
        }

        [data-theme="dark"] .highlight-yellow {
            background: #fcc41966;
            color: #fab005;
        }

        [data-theme="dark"] .highlight-green {
            background: #40c05766;
            color: #51cf66;
        }

        [data-theme="dark"] .highlight-blue {
            background: #228be666;
            color: #339af0;
        }

        [data-theme="dark"] .highlight-pink {
            background: #f0659566;
            color: #ff87b2;
        }

        .verse-has-note::after {
            content: "";
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
        }

        .selection-toolbar {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(50px);
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: none;
            gap: 12px;
            align-items: center;
            z-index: 1000;
            border: 1px solid var(--border);
            transition: transform 0.3s, opacity 0.3s;
            opacity: 0;
        }

        .selection-toolbar.active {
            display: flex;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .color-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dot-none {
            background: transparent;
            border-color: var(--border);
            position: relative;
        }

        .dot-none::after {
            content: "/";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff4757;
            font-weight: bold;
        }

        .toolbar-btn {
            background: none;
            border: none;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            gap: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .toolbar-btn:hover {
            background: var(--bg-body);
        }
    </style>
</head>

<body>

    <!-- ONBOARDING -->
    <div id="onboarding-overlay" style="display:none;">
        <div class="card">
            <div class="avatar-small" style="width: 70px; height: 70px; margin: 0 auto 20px;">
                <i data-lucide="cross"></i>
            </div>
            <h2 style="text-align: center; margin-bottom: 8px;">¡Hola!</h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 24px; font-size: 14px;">Comencemos
                este viaje devocional juntos.</p>

            <div class="photo-picker-group" style="text-align:center; margin-bottom:24px;">
                <div class="photo-picker" id="reg-photo-container">
                    <img id="reg-photo-preview" src="" style="display:none;">
                    <i data-lucide="user" id="reg-photo-icon" style="width:40px; height:40px; opacity:0.5;"></i>
                </div>
                <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
                    <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                        onclick="document.getElementById('reg-photo-input').click()">
                        <i data-lucide="image" style="width:14px;"></i> Galería
                    </button>
                    <button class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;"
                        onclick="openCameraUI('reg')">
                        <i data-lucide="camera" style="width:14px;"></i> Cámara
                    </button>
                </div>
                <input type="file" id="reg-photo-input" hidden accept="image/*" onchange="handleRegPhoto(this)">
            </div>

            <div class="input-group">
                <label>Nombre y Apellido</label>
                <input type="text" id="reg-name" placeholder="Tu nombre">
            </div>
            <div class="input-group">
                <label>Fecha de Nacimiento</label>
                <div class="date-picker-placeholder" onclick="openCalendarPicker('birth')">
                    <span id="reg-birth-display">Seleccionar fecha</span>
                    <i data-lucide="calendar" style="width:18px;"></i>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="finishOnboarding()">
                Comenzar <i data-lucide="arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="profile-trigger" onclick="switchTab('profile')">
            <div class="avatar-small" id="header-avatar">
                <i data-lucide="user"></i>
            </div>
            <div>
                <h3 id="user-greeting" style="font-size: 15px;">Hola</h3>
                <span id="header-date" style="font-size: 11px; color: var(--text-muted);">Cargando...</span>
            </div>
        </div>
        <button class="theme-btn" id="theme-toggle">
            <i data-lucide="moon" id="theme-icon"></i>
        </button>
    </header>

    <div id="toast-container"></div>

    <main>
        <!-- VISTA: DEVOCIONAL -->
        <div id="view-devotional" class="view active">
            <div class="date-navigator">
                <button class="nav-arrow" onclick="changeDate(-1)"><i data-lucide="chevron-left"></i></button>
                <span id="date-display-trigger" onclick="openCalendarPicker('devotional')">Hoy</span>
                <button class="nav-arrow" id="next-date-btn" onclick="changeDate(1)"><i
                        data-lucide="chevron-right"></i></button>
            </div>

            <!-- Selector de Biblia Rediseñado -->
            <div id="bible-selector-container" style="margin-bottom: 24px;">
                <label>Pasaje Bíblico</label>
                <div class="bible-selector-card" onclick="openBibleModal('book')">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <i data-lucide="book"></i>
                        <span id="card-book-text">Seleccionar Libro</span>
                    </div>
                    <i data-lucide="chevron-right" style="width:14px; opacity:0.5;"></i>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="bible-selector-card disabled" id="card-chapter" onclick="openBibleModal('chapter')">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <i data-lucide="layout-grid"></i>
                            <span id="card-chapter-text">Capítulo</span>
                        </div>
                        <i data-lucide="chevron-right" style="width:14px; opacity:0.5;"></i>
                    </div>
                    <div class="bible-selector-card disabled" id="card-verse" onclick="openBibleModal('verse')">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <i data-lucide="hash"></i>
                            <span id="card-verse-text">Versículos</span>
                        </div>
                        <i data-lucide="chevron-right" style="width:14px; opacity:0.5;"></i>
                    </div>
                </div>
            </div>

            <div class="oia-card o-card">
                <h3><i data-lucide="eye" style="width:16px;"></i> OBSERVACIÓN</h3>
                <textarea id="dev-o" rows="3" placeholder="¿Qué dice el texto?"
                    oninput="markUnsaved(); autoResize(this)"></textarea>
            </div>
            <div class="oia-card i-card">
                <h3><i data-lucide="search" style="width:16px;"></i> INTERPRETACIÓN</h3>
                <textarea id="dev-i" rows="3" placeholder="¿Qué significa?"
                    oninput="markUnsaved(); autoResize(this)"></textarea>
            </div>
            <div class="oia-card a-card">
                <h3><i data-lucide="heart" style="width:16px;"></i> APLICACIÓN</h3>
                <textarea id="dev-a" rows="3" placeholder="¿Cómo lo aplico a mi vida?"
                    oninput="markUnsaved(); autoResize(this)"></textarea>
            </div>
            <div class="oia-card accent-card">
                <h3><i data-lucide="message-circle" style="width:16px;"></i> MI ORACIÓN</h3>
                <textarea id="dev-p" rows="3" placeholder="Escribe tu oración de hoy..."
                    oninput="markUnsaved(); autoResize(this)"></textarea>
            </div>

            <div class="devotional-actions">
                <button id="share-fab" onclick="shareDevotional()">
                    <i data-lucide="share-2" style="width:20px;"></i> Compartir
                </button>
                <button id="save-fab" class="fab-saved" onclick="saveDevotional()">
                    <i data-lucide="check" id="save-fab-icon" style="width:20px;"></i> <span
                        id="save-text">Guardado</span>
                </button>
            </div>
        </div>

        <!-- VISTA: NOTAS BÍBLICAS -->
        <div id="view-notes" class="view">
            <h2>Notas Bíblicas</h2>
            <p style="color:var(--text-muted); font-size:13px; margin-bottom:20px;">Consulta tus reflexiones sobre
                versículos específicos.</p>

            <div class="sort-group">
                <button id="sort-date" class="sort-btn active" onclick="setNoteSort('date')">
                    <i data-lucide="calendar"></i> Fecha
                </button>
                <button id="sort-bible" class="sort-btn" onclick="setNoteSort('bible')">
                    <i data-lucide="book"></i> Orden Bíblico
                </button>
            </div>

            <div id="notes-list"></div>
        </div>

        <div id="view-bible" class="view">
            <h2>Registro de Lectura</h2>
            <br>
            <div class="stat-card">
                <h2 style="font-size: 32px;"><span id="total-pct">0</span>%</h2>
                <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Biblia Completa</p>
                <div class="progress-track">
                    <div class="progress-thumb" id="total-progress-bar"></div>
                </div>
            </div>
            <h3 style="margin-bottom: 16px; font-size: 18px;">Antiguo Testamento</h3>
            <div id="ot-container"></div>
            <h3 style="margin: 24px 0 16px; font-size: 18px;">Nuevo Testamento</h3>
            <div id="nt-container"></div>
        </div>

        <!-- VISTA: BIBLIA (LECTOR) -->
        <div id="view-reader" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Santa Biblia</h2>
                <div id="reader-loading" class="tag" style="background: var(--secondary); display:none;">Cargando...
                </div>
            </div>

            <div class="version-pills-container" id="reader-versions">
                <!-- Pills will be injected here -->
            </div>

            <div class="reader-controls">
                <div class="reader-selectors">
                    <select id="reader-book" onchange="readerOnBookChange()"></select>
                    <select id="reader-chapter" onchange="readerOnChapterChange()"></select>
                </div>
                <div class="reader-nav-btns">
                    <button class="btn btn-outline" style="flex:1" onclick="readerNav(-1)">
                        <i data-lucide="chevron-left"></i> Anterior
                    </button>
                    <button class="btn btn-primary" style="flex:1" onclick="readerNav(1)">
                        Siguiente <i data-lucide="chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="reader-content" id="reader-text">
                <div style="text-align:center; padding: 40px; color: var(--text-muted);">
                    <i data-lucide="book-open" style="width:48px; height:48px; margin-bottom:16px; opacity:0.3;"></i>
                    <p>Cargando biblioteca bíblica...</p>
                </div>
            </div>
        </div>

        <!-- VISTA: ORACIONES -->
        <div id="view-prayers" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2>Mis Oraciones</h2>
                <button class="btn btn-primary" onclick="openPrayerModal()"><i data-lucide="plus"></i> Nueva</button>
            </div>
            <div id="prayers-active"></div>
            <h2 style="margin: 32px 0 16px; color: var(--text-muted); font-size: 18px;">Respondidas</h2>
            <div id="prayers-answered"></div>
        </div>

        <!-- VISTA: PERFIL -->
        <div id="view-profile" class="view">
            <h2>Mi Cuenta</h2>
            <br>
            <div class="card" style="max-width: none;">
                <div class="photo-picker-group" style="text-align:center; margin-bottom:24px;">
                    <div class="photo-picker" id="profile-photo-container">
                        <div id="photo-preview"><i data-lucide="user"
                                style="width: 32px; height: 32px; opacity:0.5;"></i></div>
                    </div>
                    <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
                        <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                            onclick="document.getElementById('profile-file').click()">
                            <i data-lucide="image" style="width:14px;"></i> Galería
                        </button>
                        <button class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;"
                            onclick="openCameraUI('profile')">
                            <i data-lucide="camera" style="width:14px;"></i> Cámara
                        </button>
                    </div>
                    <input type="file" id="profile-file" hidden accept="image/*" onchange="previewPhoto(this)">
                </div>
                <div class="input-group">
                    <label>Nombre</label>
                    <input type="text" id="profile-name">
                </div>
                <div class="input-group">
                    <label>Fecha de Nacimiento</label>
                    <div class="date-picker-placeholder" onclick="openCalendarPicker('birthProfile')">
                        <span id="profile-birth-display">Seleccionar</span>
                        <i data-lucide="calendar" style="width:18px;"></i>
                    </div>
                </div>
                <button class="btn btn-primary btn-full" onclick="updateProfile()">Guardar Cambios</button>

                <div style="margin-top: 32px; border-top: 1px solid var(--border); padding-top: 24px;">
                    <h3 style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">SEGURIDAD Y RESPALDO
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button class="btn btn-outline" onclick="exportBackup()">
                            <i data-lucide="download"></i> Exportar
                        </button>
                        <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">
                            <i data-lucide="upload"></i> Importar
                        </button>
                    </div>
                    <input type="file" id="import-file" hidden accept=".json" onchange="importBackup(this)">
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav glass">
        <button class="nav-item" onclick="switchTab('devotional')" id="nav-devotional"><i
                data-lucide="home"></i><span>Inicio</span></button>
        <button class="nav-item" onclick="switchTab('notes')" id="nav-notes"><i
                data-lucide="file-text"></i><span>Notas</span></button>
        <button class="nav-item" onclick="switchTab('reader')" id="nav-reader"><i
                data-lucide="book"></i><span>Biblia</span></button>
        <button class="nav-item" onclick="switchTab('bible')" id="nav-bible"><i
                data-lucide="clipboard-check"></i><span>Registro</span></button>
        <button class="nav-item" onclick="switchTab('prayers')" id="nav-prayers"><i
                data-lucide="sparkles"></i><span>Oraciones</span></button>
    </nav>

    <!-- CALENDAR/SELECTOR MODAL -->
    <div class="modal-overlay" id="calendar-overlay">
        <div class="calendar-card" id="calendar-card">
            <h3 id="selector-modal-title" style="margin-bottom: 20px; text-align: center; font-size: 18px;">Seleccionar
                Fecha</h3>

            <!-- Modo Calendario (Devocional) -->
            <div id="calendar-ui-group">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="navCalendar(-1)"><i
                            data-lucide="chevron-left"></i></button>
                    <div class="calendar-title" id="calendar-month-year" onclick="toggleYearMode()"
                        style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                        <span id="calendar-title-text">Junio 2024</span>
                        <i data-lucide="chevron-down" style="width:14px;"></i>
                    </div>
                    <button class="calendar-nav-btn" onclick="navCalendar(1)"><i
                            data-lucide="chevron-right"></i></button>
                </div>
                <div class="calendar-weekdays">
                    <span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span>
                </div>
                <div class="calendar-days-grid" id="calendar-days"></div>
            </div>

            <!-- Modo Listas Desplegables (Nacimiento) -->
            <div id="birth-ui-group" style="display: none;">
                <div class="birth-selectors-grid">
                    <select id="sel-day"></select>
                    <select id="sel-month">
                        <option value="0">Enero</option>
                        <option value="1">Febrero</option>
                        <option value="2">Marzo</option>
                        <option value="3">Abril</option>
                        <option value="4">Mayo</option>
                        <option value="5">Junio</option>
                        <option value="6">Julio</option>
                        <option value="7">Agosto</option>
                        <option value="8">Septiembre</option>
                        <option value="9">Octubre</option>
                        <option value="10">Noviembre</option>
                        <option value="11">Diciembre</option>
                    </select>
                    <select id="sel-year"></select>
                </div>
                <button class="btn btn-primary btn-full" onclick="confirmBirthDate()">Confirmar Fecha</button>
            </div>

            <button class="btn btn-full btn-outline" style="margin-top: 20px;"
                onclick="closeCalendarPicker()">Cancelar</button>
        </div>
    </div>

    <!-- BIBLE SELECTOR MODAL -->
    <div class="modal-overlay" id="bible-modal">
        <div class="modal-sheet" style="max-height: 80vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="bible-modal-title" style="font-size: 20px;">Seleccionar</h3>
                <button style="background:none; border:none; color:var(--text-muted);" onclick="closeBibleModal()"><i
                        data-lucide="x"></i></button>
            </div>
            <div id="bible-modal-content"></div>
        </div>
    </div>
    <div class="modal-overlay" id="camera-modal">
        <div class="modal-sheet" style="max-height: 90vh;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="font-size: 18px;">Tomar Foto</h3>
                <button style="background:none; border:none; color:var(--text-muted);" onclick="closeCameraUI()"><i
                        data-lucide="x"></i></button>
            </div>
            <div style="aspect-ratio: 1; position: relative; overflow: hidden; border-radius: 20px;">
                <video id="camera-stream" autoplay playsinline></video>
                <canvas id="camera-canvas" style="display:none;"></canvas>
            </div>
            <div class="camera-controls">
                <button class="btn-capture" onclick="capturePhoto()">
                    <i data-lucide="aperture" style="color:var(--primary); width:32px; height:32px;"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="prayer-modal">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="font-size: 20px;">Nueva Oración</h3>
                <button style="background:none; border:none; color:var(--text-muted);" onclick="closePrayerModal()"><i
                        data-lucide="x"></i></button>
            </div>
            <div class="input-group">
                <label>Asunto / Petición</label>
                <input type="text" id="p-title" placeholder="Ej: Por mi familia">
            </div>
            <div class="input-group">
                <label>Detalles</label>
                <textarea id="p-details" rows="3" placeholder="Relátale a Dios tu corazón..."
                    oninput="autoResize(this)"></textarea>
            </div>
            <button class="btn btn-primary btn-full" onclick="addPrayer()">Guardar Petición</button>
        </div>
    </div>



    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-sheet" style="padding-bottom: 30px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div
                    style="width: 60px; height: 60px; background: rgba(255, 71, 87, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <i data-lucide="trash-2" style="color: #ff4757; width: 30px; height: 30px;"></i>
                </div>
                <h3 style="font-size: 20px; margin-bottom: 10px;">¿Eliminar Oración?</h3>
                <p style="color: var(--text-muted); font-size: 14px; line-height: 1.5;">Esta acción no se puede
                    deshacer. La oración será borrada permanentemente.</p>
            </div>
            <div style="display: grid; gap: 12px;">
                <button class="btn btn-primary" style="background: #ff4757; border-color: #ff4757;"
                    id="btn-confirm-delete">Sí, eliminar</button>
                <button class="btn btn-outline" onclick="closeConfirmModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- CONGRATULATIONS MODAL -->
    <div class="modal-overlay" id="congrats-modal">
        <div class="modal-sheet" style="padding-bottom: 40px; text-align: center;">
            <div style="font-size: 60px; margin-bottom: 20px;">🏆</div>
            <h2 style="font-size: 24px; margin-bottom: 10px; color: var(--primary);">¡Felicitaciones!</h2>
            <p id="congrats-text"
                style="color: var(--text-muted); font-size: 16px; line-height: 1.6; margin-bottom: 30px;">
                Has completado la lectura del libro de <strong>Génesis</strong>. ¡Sigue así!
            </p>
            <button class="btn btn-primary btn-full" onclick="closeCongratsModal()">
                ¡Gloria a Dios! 🙏
            </button>
        </div>
    </div>

    <!-- SELECTION TOOLBAR -->
    <div id="reader-toolbar" class="selection-toolbar">
        <div class="color-dot dot-none" onclick="applyReaderHighlight(null)" title="Quitar color"></div>
        <div class="color-dot highlight-yellow" onclick="applyReaderHighlight('yellow')"
            style="background:#ffd43b; border-color:#fab005;"></div>
        <div class="color-dot highlight-green" onclick="applyReaderHighlight('green')"
            style="background:#51cf66; border-color:#40c057;"></div>
        <div class="color-dot highlight-blue" onclick="applyReaderHighlight('blue')"
            style="background:#339af0; border-color:#228be6;"></div>
        <div class="color-dot highlight-pink" onclick="applyReaderHighlight('pink')"
            style="background:#ff87b2; border-color:#f06595;"></div>
        <div style="width:1px; height:24px; background:var(--border); margin:0 4px;"></div>
        <button class="toolbar-btn" onclick="openReaderNoteModal()">
            <i data-lucide="sticky-note" style="width:18px;"></i>
            <span>Nota</span>
        </button>
    </div>

    <!-- READER NOTE MODAL -->
    <div id="reader-note-modal" class="modal-overlay" style="display:none;">
        <div class="modal-sheet" style="max-height: 480px; padding:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 id="reader-note-title" style="font-size: 18px;">Nota en Juan 3:16</h3>
                <button class="btn-icon" onclick="closeReaderNoteModal()"><i data-lucide="x"></i></button>
            </div>
            <textarea id="reader-note-input" rows="6" placeholder="Escribe tu reflexión aquí..."
                oninput="autoResize(this)"
                style="width:100%; padding:12px; border-radius:12px; background:var(--bg-body); border:1px solid var(--border); color:var(--text-main); font-family:inherit; resize:none; font-size: 15px;"></textarea>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn btn-outline btn-full" onclick="closeReaderNoteModal()">Cancelar</button>
                <button class="btn btn-primary btn-full" onclick="saveReaderNote()">Guardar Nota</button>
            </div>
        </div>
    </div>

    <script>
        // --- TEXTAREA AUTO-RESIZE ---
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // --- LOCAL DATE HELPER ---
        // Fixes timezone bug: toISOString() uses UTC which shifts date in negative-offset timezones
        function localDateStr(d) {
            const date = d || new Date();
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        // --- MODAL UTILS ---
        function closeModalWithAnim(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const content = modal.querySelector('.modal-sheet') || modal.querySelector('.calendar-card');
            if (content) {
                content.classList.add('closing');
                setTimeout(() => {
                    modal.style.display = 'none';
                    content.classList.remove('closing');
                }, 350);
            } else {
                modal.style.display = 'none';
            }
        }

        // --- TOAST NOTIFICATIONS ---
        function showToast(msg, icon = 'check-circle') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast glass';
            toast.innerHTML = `<i data-lucide="${icon}" style="width:18px; color:var(--primary);"></i> ${msg}`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 3500);
        }

        // --- CONGRATS MODAL ---
        function showCongrats(bookName) {
            document.getElementById('congrats-text').innerHTML = `Has completado la lectura del libro de <strong>${bookName}</strong>. ¡Sigue así!`;
            document.getElementById('congrats-modal').style.display = 'flex';
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        }
        function closeCongratsModal() { closeModalWithAnim('congrats-modal'); }

        // --- CONNECTION STATUS ---
        window.addEventListener('online', () => showToast('¡Estás en línea! Sincronizando...', 'wifi'));
        window.addEventListener('offline', () => showToast('Modo sin conexión activo 📶', 'wifi-off'));

        // --- BIBLE DATA ---
        const BOOKS = [{ id: 1, n: "Génesis", c: 50, nt: false }, { id: 2, n: "Éxodo", c: 40, nt: false }, { id: 3, n: "Levítico", c: 27, nt: false }, { id: 4, n: "Números", c: 36, nt: false }, { id: 5, n: "Deuteronomio", c: 34, nt: false }, { id: 6, n: "Josué", c: 24, nt: false }, { id: 7, n: "Jueces", c: 21, nt: false }, { id: 8, n: "Rut", c: 4, nt: false }, { id: 9, n: "1 Samuel", c: 31, nt: false }, { id: 10, n: "2 Samuel", c: 24, nt: false }, { id: 11, n: "1 Reyes", c: 22, nt: false }, { id: 12, n: "2 Reyes", c: 25, nt: false }, { id: 13, n: "1 Crónicas", c: 29, nt: false }, { id: 14, n: "2 Crónicas", c: 36, nt: false }, { id: 15, n: "Esdras", c: 10, nt: false }, { id: 16, n: "Nehemías", c: 13, nt: false }, { id: 17, n: "Ester", c: 10, nt: false }, { id: 18, n: "Job", c: 42, nt: false }, { id: 19, n: "Salmos", c: 150, nt: false }, { id: 20, n: "Proverbios", c: 31, nt: false }, { id: 21, n: "Eclesiastés", c: 12, nt: false }, { id: 22, n: "Cantares", c: 8, nt: false }, { id: 23, n: "Isaías", c: 66, nt: false }, { id: 24, n: "Jeremías", c: 52, nt: false }, { id: 25, n: "Lamentaciones", c: 5, nt: false }, { id: 26, n: "Ezequiel", c: 48, nt: false }, { id: 27, n: "Daniel", c: 12, nt: false }, { id: 28, n: "Oseas", c: 14, nt: false }, { id: 29, n: "Joel", c: 3, nt: false }, { id: 30, n: "Amós", c: 9, nt: false }, { id: 31, n: "Abdías", c: 1, nt: false }, { id: 32, n: "Jonás", c: 4, nt: false }, { id: 33, n: "Miqueas", c: 7, nt: false }, { id: 34, n: "Nahúm", c: 3, nt: false }, { id: 35, n: "Habacuc", c: 3, nt: false }, { id: 36, n: "Sofonías", c: 3, nt: false }, { id: 37, n: "Hageo", c: 2, nt: false }, { id: 38, n: "Zacarías", c: 14, nt: false }, { id: 39, n: "Malaquías", c: 4, nt: false }, { id: 40, n: "Mateo", c: 28, nt: true }, { id: 41, n: "Marcos", c: 16, nt: true }, { id: 42, n: "Lucas", c: 24, nt: true }, { id: 43, n: "Juan", c: 21, nt: true }, { id: 44, n: "Hechos", c: 28, nt: true }, { id: 45, n: "Romanos", c: 16, nt: true }, { id: 46, n: "1 Corintios", c: 16, nt: true }, { id: 47, n: "2 Corintios", c: 13, nt: true }, { id: 48, n: "Gálatas", c: 6, nt: true }, { id: 49, n: "Efesios", c: 6, nt: true }, { id: 50, n: "Filipenses", c: 4, nt: true }, { id: 51, n: "Colosenses", c: 4, nt: true }, { id: 52, n: "1 Tesalonicenses", c: 5, nt: true }, { id: 53, n: "2 Tesalonicenses", c: 3, nt: true }, { id: 54, n: "1 Timoteo", c: 6, nt: true }, { id: 55, n: "2 Timoteo", c: 4, nt: true }, { id: 56, n: "Tito", c: 3, nt: true }, { id: 57, n: "Filemón", c: 1, nt: true }, { id: 58, n: "Hebreos", c: 13, nt: true }, { id: 59, n: "Santiago", c: 5, nt: true }, { id: 60, n: "1 Pedro", c: 5, nt: true }, { id: 61, n: "2 Pedro", c: 3, nt: true }, { id: 62, n: "1 Juan", c: 5, nt: true }, { id: 63, n: "2 Juan", c: 1, nt: true }, { id: 64, n: "3 Juan", c: 1, nt: true }, { id: 65, n: "Judas", c: 1, nt: true }, { id: 66, n: "Apocalipsis", c: 22, nt: true }];

        // --- GLOBAL STATE ---
        let appState = {
            user: null,
            theme: 'light',
            viewDate: localDateStr(),
            devotionals: {},
            reading: {},
            prayers: [],
            notes: [],
            noteSortMode: 'date',
            readerLocation: { version: 'RV60', book: 43, chapter: 3, scroll: 0 },
            highlights: {}, // Format: "book-ch-vs": "color"
            calendar: { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), target: 'devotional', selectedDate: '', mode: 'days' }
        };

        const STORAGE_KEY = 'devocional_pro_v6';

        // --- INITIALIZATION ---
        function init() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) appState = JSON.parse(data);

            // Ensure new properties exist
            if (!appState.notes) appState.notes = [];
            if (!appState.noteSortMode) appState.noteSortMode = 'date';
            if (!appState.readerLocation) appState.readerLocation = { version: 'RV60', book: 43, chapter: 3, scroll: 0 };
            if (appState.readerLocation.scroll === undefined) appState.readerLocation.scroll = 0;
            if (!appState.highlights) appState.highlights = {};

            if (!appState.user) {
                document.getElementById('onboarding-overlay').style.display = 'flex';
            } else {
                renderProfile();
            }

            setTheme(appState.theme);
            updateDateUI();
            renderBible();
            renderPrayers();

            // Reader scroll persistence
            const readerView = document.getElementById('view-reader');
            readerView.addEventListener('scroll', () => {
                if (readerView.classList.contains('active')) {
                    appState.readerLocation.scroll = readerView.scrollTop;
                }
            }, { passive: true });

            // Periodic save for scroll position
            setInterval(() => {
                if (document.getElementById('view-reader').classList.contains('active')) save();
            }, 5000);

            lucide.createIcons();
        }

        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }

        // --- BACKUP & SHARING ---
        function exportBackup() {
            const data = JSON.stringify(appState, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `respaldo_devocional_${localDateStr()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("Respaldo exportado correctamente", "download");
        }

        function importBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.user && data.devotionals) {
                        appState = data;
                        save();
                        window.location.reload();
                    } else {
                        showToast("Archivo de respaldo no válido", "alert-triangle");
                    }
                } catch (err) {
                    showToast("Error al leer el archivo", "alert-triangle");
                }
            };
            reader.readAsText(file);
        }

        async function shareDevotional() {
            const d = appState.devotionals[appState.viewDate];
            if (!d || (!d.book && !d.o && !d.i && !d.a && !d.p)) {
                showToast("No hay contenido para compartir hoy", "info");
                return;
            }

            const dateStr = new Date(appState.viewDate + "T12:00:00").toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            let text = `📖 *Bible Note*\n📅 ${dateStr}\n\n`;

            if (d.book) text += `📍 *Pasaje:* ${d.book} ${d.ch}:${d.vs}\n\n`;
            if (d.o) text += `👁️ *Observación:*\n${d.o}\n\n`;
            if (d.i) text += `🔍 *Interpretación:*\n${d.i}\n\n`;
            if (d.a) text += `❤️ *Aplicación:*\n${d.a}\n\n`;
            if (d.p) text += `🙏 *Oración:*\n${d.p}\n\n`;

            text += `Hecho con *Bible Note* ✨`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Bible Note',
                        text: text
                    });
                } catch (err) { }
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    showToast("Copiado al portapapeles para compartir", "clipboard");
                });
            }
        }

        // --- BIBLE NOTES LOGIC ---
        function renderNotes() {
            const list = document.getElementById('notes-list');
            if (!list) return;
            list.innerHTML = '';

            let sorted = [...appState.notes];
            if (appState.noteSortMode === 'date') {
                sorted.sort((a, b) => b.id - a.id);
            } else if (appState.noteSortMode === 'bible') {
                sorted.sort((a, b) => {
                    if (a.bookId !== b.bookId) return a.bookId - b.bookId;
                    if (a.chapter !== b.chapter) return a.chapter - b.chapter;
                    return a.vStart - b.vStart;
                });
            }

            sorted.forEach(n => {
                const card = document.createElement('div');
                card.className = 'note-tile';
                card.id = `note-${n.id}`;
                const dateStr = new Date(n.id).toLocaleDateString();
                const vsText = n.vEnd ? `${n.vStart}-${n.vEnd}` : n.vStart;
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div onclick="toggleNoteExpansion(${n.id})" style="flex:1;">
                            <h3 style="color:var(--primary); display: flex; align-items: center;">
                                <i data-lucide="bookmark" style="width:14px;"></i> 
                                <span style="font-size: 14px; font-weight: 800; opacity: 0.8;">Reflexión</span>
                                ${n.version ? `<span class="note-version-tag">${n.version}</span>` : ''}
                            </h3>
                            <div class="note-date">${dateStr}</div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-icon" onclick="editNoteInModal(${n.id})"><i data-lucide="edit-3" style="width:16px;"></i></button>
                            <button class="btn-icon" onclick="deleteNote(${n.id})" style="color:#ff4757;"><i data-lucide="trash-2" style="width:16px;"></i></button>
                        </div>
                    </div>
                    <div class="note-body" onclick="toggleNoteExpansion(${n.id})">` +
                    (n.vText ? `<div style="font-weight: 700; font-size: 12px; margin-top: 4px; color: var(--primary);">${n.book} ${n.chapter}:${vsText}</div><div class="note-verse-text">"${n.vText}"</div>` : '') +
                    `<div style="margin-top: 4px;"><div style="font-weight: 800; font-size: 10px; text-transform: uppercase; color: var(--text-muted); opacity: 0.7;">Nota:</div><div class="note-text-content">${n.note}</div></div></div>`;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        function toggleNoteExpansion(id) {
            const el = document.getElementById(`note-${id}`);
            el.classList.toggle('expanded');
        }

        let editingNoteFromModalId = null;
        function editNoteInModal(id) {
            const n = appState.notes.find(x => x.id === id);
            if (!n) return;
            editingNoteFromModalId = id;

            document.getElementById('reader-note-title').textContent = `Editar Nota: ${n.book} ${n.chapter}:${n.vStart}`;
            document.getElementById('reader-note-input').value = n.note;
            document.getElementById('reader-note-modal').style.display = 'flex';
            autoResize(document.getElementById('reader-note-input'));
            lucide.createIcons();
        }
        function setNoteSort(mode) {
            appState.noteSortMode = mode;
            const btnDate = document.getElementById('sort-date');
            const btnBible = document.getElementById('sort-bible');
            if (btnDate) btnDate.classList.toggle('active', mode === 'date');
            if (btnBible) btnBible.classList.toggle('active', mode === 'bible');
            save(); renderNotes();
        }

        function addNote() {
            const noteText = document.getElementById('note-input').value.trim();
            if (!noteText || !bibleSelection.book || !bibleSelection.chapter) {
                showToast("Falta pasaje o nota", "alert-circle");
                return;
            }

            if (editingNoteId) {
                const n = appState.notes.find(x => x.id === editingNoteId);
                n.book = bibleSelection.book;
                const bookObj = BOOKS.find(b => b.n === bibleSelection.book);
                n.bookId = bookObj.id;
                n.chapter = bibleSelection.chapter;
                n.vStart = bibleSelection.vStart;
                n.vEnd = bibleSelection.vEnd;
                n.note = noteText;
                editingNoteId = null;
                showToast("Nota actualizada", "check");
                document.getElementById('btn-save-note').innerHTML = '<i data-lucide="plus"></i> Guardar Nota';
                document.getElementById('btn-cancel-note').style.display = 'none';
            } else {
                const bookObj = BOOKS.find(b => b.n === bibleSelection.book);
                const newNote = {
                    id: Date.now(),
                    book: bibleSelection.book,
                    bookId: bookObj.id,
                    chapter: bibleSelection.chapter,
                    vStart: bibleSelection.vStart,
                    vEnd: bibleSelection.vEnd,
                    note: noteText
                };
                appState.notes.push(newNote);
                showToast("Nota guardada", "check");
            }

            save(); renderNotes();

            // Limpiar formulario
            document.getElementById('note-input').value = '';
            document.getElementById('note-input').style.height = 'auto';
            bibleSelection = { book: '', chapter: 0, vStart: 0, vEnd: 0 };
            updateBibleCards();
        }

        function openNoteModal() {
            // Reset form before opening
            bibleSelection = { book: '', chapter: 0, vStart: 0, vEnd: 0 };
            updateBibleCards();
            const ta = document.getElementById('note-input');
            if (ta) { ta.value = ''; ta.style.height = 'auto'; }
            document.getElementById('note-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeNoteModal() { closeModalWithAnim('note-modal'); }

        function deleteNote(id) {
            const modal = document.getElementById('confirm-modal');
            const btn = document.getElementById('btn-confirm-delete');
            document.querySelector('#confirm-modal h3').textContent = '¿Eliminar Nota?';
            document.querySelector('#confirm-modal p').textContent = 'Esta acción no se puede deshacer. La nota será borrada permanentemente.';
            modal.style.display = 'flex';
            btn.onclick = () => {
                appState.notes = appState.notes.filter(n => n.id !== id);
                save();
                renderNotes();
                closeConfirmModal();
                showToast('Nota eliminada', 'trash-2');
            };
        }

        // --- THEME ---
        function setTheme(theme) {
            appState.theme = theme;
            document.body.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-theme', theme);

            // Sincronizar barras del sistema (Status bar y Nav bar)
            const metaTheme = document.getElementById('meta-theme-color');
            const themeColor = theme === 'dark' ? '#2D294D' : '#F8F9FD';
            if (metaTheme) metaTheme.setAttribute('content', themeColor);

            // Aplicar color-scheme para que el navegador adapte elementos UI
            document.documentElement.style.colorScheme = theme;

            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
                lucide.createIcons();
            }
            save();
        }
        document.getElementById('theme-toggle').onclick = () => setTheme(appState.theme === 'light' ? 'dark' : 'light');

        // --- CALENDAR / SELECTOR PICKER LOGIC ---
        function openCalendarPicker(target) {
            appState.calendar.target = target;
            document.getElementById('calendar-overlay').style.display = 'flex';

            if (target === 'birth' || target === 'birthProfile') {
                document.getElementById('calendar-ui-group').style.display = 'none';
                document.getElementById('birth-ui-group').style.display = 'block';
                document.querySelector('.birth-selectors-grid').style.display = 'grid';
                document.getElementById('selector-modal-title').textContent = 'Fecha de Nacimiento';
                populateBirthSelectors();
            } else {
                document.getElementById('calendar-ui-group').style.display = 'block';
                document.getElementById('birth-ui-group').style.display = 'none';
                document.querySelector('.birth-selectors-grid').style.display = 'none';
                document.getElementById('selector-modal-title').textContent = 'Seleccionar Día';

                let initialDate = new Date(appState.viewDate + "T12:00:00");
                appState.calendar.currentMonth = initialDate.getMonth();
                appState.calendar.currentYear = initialDate.getFullYear();
                appState.calendar.mode = 'days';
                renderCalendar();
            }
        }

        function populateBirthSelectors() {
            const selDay = document.getElementById('sel-day');
            const selYear = document.getElementById('sel-year');
            const selMonth = document.getElementById('sel-month');

            selDay.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                const o = document.createElement('option'); o.value = i; o.textContent = i;
                selDay.appendChild(o);
            }

            selYear.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 100; i--) {
                const o = document.createElement('option'); o.value = i; o.textContent = i;
                selYear.appendChild(o);
            }

            // Set current known date if exists
            if (appState.user && appState.user.birth) {
                const d = new Date(appState.user.birth + "T12:00:00");
                selDay.value = d.getDate();
                selMonth.value = d.getMonth();
                selYear.value = d.getFullYear();
            }
        }

        function confirmBirthDate() {
            const d = document.getElementById('sel-day').value;
            const m = parseInt(document.getElementById('sel-month').value) + 1;
            const y = document.getElementById('sel-year').value;
            const dateStr = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

            selectCalendarDate(dateStr);
        }

        function closeCalendarPicker() { closeModalWithAnim('calendar-overlay'); }

        function navCalendar(offset) {
            if (appState.calendar.mode === 'years') {
                appState.calendar.currentYear += offset * 12;
            } else {
                appState.calendar.currentMonth += offset;
                if (appState.calendar.currentMonth < 0) { appState.calendar.currentMonth = 11; appState.calendar.currentYear--; }
                if (appState.calendar.currentMonth > 11) { appState.calendar.currentMonth = 0; appState.calendar.currentYear++; }
            }
            renderCalendar();
        }

        function toggleYearMode() {
            appState.calendar.mode = appState.calendar.mode === 'years' ? 'days' : 'years';
            renderCalendar();
        }

        function selectYear(y) {
            appState.calendar.currentYear = y;
            appState.calendar.mode = 'days';
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-days');
            const titleText = document.getElementById('calendar-title-text');
            const weekDays = document.querySelector('.calendar-weekdays');
            grid.innerHTML = '';

            if (appState.calendar.mode === 'years') {
                weekDays.style.display = 'none';
                const startYear = appState.calendar.currentYear - 6;
                titleText.textContent = `${startYear} - ${startYear + 11}`;
                grid.style.gridTemplateColumns = 'repeat(3, 1fr)';

                for (let i = 0; i < 12; i++) {
                    const y = startYear + i;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.style.height = '60px';
                    dayDiv.textContent = y;
                    if (y === appState.calendar.currentYear) dayDiv.classList.add('selected');
                    dayDiv.onclick = () => selectYear(y);
                    grid.appendChild(dayDiv);
                }
            } else {
                weekDays.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                titleText.textContent = `${monthNames[appState.calendar.currentMonth]} ${appState.calendar.currentYear}`;

                const firstDay = new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1).getDay();
                const daysInMonth = new Date(appState.calendar.currentYear, appState.calendar.currentMonth + 1, 0).getDate();
                const prevDaysInMonth = new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 0).getDate();
                const todayStr = localDateStr();

                for (let i = firstDay; i > 0; i--) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day prev-month';
                    dayDiv.textContent = prevDaysInMonth - i + 1;
                    grid.appendChild(dayDiv);
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    const dateFull = `${appState.calendar.currentYear}-${String(appState.calendar.currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayDiv.className = 'calendar-day';
                    dayDiv.textContent = i;
                    if (dateFull === todayStr) dayDiv.classList.add('today');
                    if (appState.calendar.target === 'devotional' && dateFull > todayStr) {
                        dayDiv.classList.add('disabled');
                    } else {
                        dayDiv.onclick = () => selectCalendarDate(dateFull);
                    }
                    if (appState.calendar.target === 'devotional') {
                        if (appState.viewDate === dateFull) dayDiv.classList.add('selected');
                        if (appState.devotionals[dateFull]) {
                            const dev = appState.devotionals[dateFull];
                            if (dev.o || dev.i || dev.a || dev.p) dayDiv.classList.add('has-content');
                        }
                    } else {
                        if (appState.user && appState.user.birth === dateFull) dayDiv.classList.add('selected');
                    }
                    grid.appendChild(dayDiv);
                }
            }
            lucide.createIcons();
        }

        function selectCalendarDate(date) {
            if (appState.calendar.target === 'devotional') {
                appState.viewDate = date;
                updateDateUI();
            } else if (appState.calendar.target === 'birth') {
                appState.user = appState.user || {};
                appState.user.birth = date;
                document.getElementById('reg-birth-display').textContent = date;
            } else if (appState.calendar.target === 'birthProfile') {
                appState.user.birth = date;
                document.getElementById('profile-birth-display').textContent = date;
            }
            closeCalendarPicker();
        }

        // --- ONBOARDING & PROFILE ---
        let cameraTarget = ''; // 'reg' or 'profile'
        let stream = null;

        function openCameraUI(target) {
            cameraTarget = target;
            document.getElementById('camera-modal').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(s => {
                    stream = s;
                    document.getElementById('camera-stream').srcObject = s;
                })
                .catch(err => {
                    alert('No se pudo acceder a la cámara. Revisa los permisos. 📷');
                    closeCameraUI();
                });
            lucide.createIcons();
        }

        function closeCameraUI() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            closeModalWithAnim('camera-modal');
        }

        function capturePhoto() {
            const video = document.getElementById('camera-stream');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL('image/jpeg');
            if (cameraTarget === 'reg') {
                const img = document.getElementById('reg-photo-preview');
                img.src = dataUrl;
                img.style.display = 'block';
                document.getElementById('reg-photo-icon').style.display = 'none';
            } else if (cameraTarget === 'profile') {
                appState.user.photo = dataUrl;
                renderProfile();
            }

            closeCameraUI();
        }

        function finishOnboarding() {
            const name = document.getElementById('reg-name').value;
            const bD = document.getElementById('reg-birth-display').textContent;
            const photo = document.getElementById('reg-photo-preview').src;
            if (!name || bD === 'Seleccionar fecha') { alert("Por favor completa tu nombre y fecha."); return; }
            appState.user = { name, birth: bD, photo: photo.startsWith('data:') ? photo : null };
            save(); document.getElementById('onboarding-overlay').style.display = 'none';
            renderProfile();
        }

        function handleRegPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('reg-photo-preview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('reg-photo-icon').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderProfile() {
            document.getElementById('user-greeting').textContent = `Hola, ${appState.user.name}`;
            document.getElementById('profile-name').value = appState.user.name;
            document.getElementById('profile-birth-display').textContent = appState.user.birth || 'Seleccionar';

            const avatar = document.getElementById('header-avatar');
            const preview = document.getElementById('photo-preview');
            if (appState.user.photo) {
                const img = `<img src="${appState.user.photo}">`;
                avatar.innerHTML = img; preview.innerHTML = img;
            } else {
                avatar.innerHTML = '<i data-lucide="user"></i>';
                preview.innerHTML = '<i data-lucide="camera" style="width:30px; opacity:0.5;"></i>';
                lucide.createIcons();
            }
        }

        function previewPhoto(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { appState.user.photo = e.target.result; renderProfile(); };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateProfile() {
            appState.user.name = document.getElementById('profile-name').value;
            save(); renderProfile();
            showToast('Perfil actualizado ✨');
            switchTab('devotional');
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            document.getElementById(`nav-${tab}`).classList.add('active');

            // Mostrar/Ocultar el contenedor de acciones solo en devocional
            document.querySelector('.devotional-actions').style.display = tab === 'devotional' ? 'flex' : 'none';

            if (tab === 'devotional') updateDateUI();
            if (tab === 'bible') renderBible();
            if (tab === 'notes') renderNotes();
            if (tab === 'reader') initReader();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }



        // --- DEVOTIONAL BIBLE SELECTOR LOGIC ---
        let bibleSelection = { book: '', chapter: 0, vStart: 0, vEnd: 0 };
        let isEditLocked = false;

        function openBibleModal(type) {
            const isNotesView = document.getElementById('view-notes').classList.contains('active');
            if (isEditLocked && !isNotesView) return;
            if (type === 'chapter' && !bibleSelection.book) return;
            if (type === 'verse' && (!bibleSelection.book || !bibleSelection.chapter)) return;

            const modal = document.getElementById('bible-modal');
            const content = document.getElementById('bible-modal-content');
            const title = document.getElementById('bible-modal-title');
            content.innerHTML = '';
            modal.style.display = 'flex';

            if (type === 'book') {
                title.textContent = 'Seleccionar Libro';
                BOOKS.forEach(b => {
                    const btn = document.createElement('div');
                    btn.className = 'book-item';
                    btn.style.cursor = 'pointer';
                    btn.innerHTML = `<div class="book-header"><strong>${b.n}</strong><span style="font-size:11px; opacity:0.6;">${b.c} caps</span></div>`;
                    btn.onclick = () => selectBibleBook(b);
                    content.appendChild(btn);
                });
            } else if (type === 'chapter') {
                title.textContent = 'Seleccionar Capítulo';
                const book = BOOKS.find(b => b.n === bibleSelection.book);
                const grid = document.createElement('div');
                grid.className = 'chapter-pill-grid';
                grid.style.display = 'grid';
                for (let i = 1; i <= book.c; i++) {
                    const pill = document.createElement('div');
                    pill.className = 'chapter-pill';
                    pill.textContent = i;
                    if (i === bibleSelection.chapter) pill.classList.add('read');
                    pill.onclick = () => selectBibleChapter(i);
                    grid.appendChild(pill);
                }
                content.appendChild(grid);
            } else if (type === 'verse') {
                title.textContent = 'Seleccionar Versículos';
                const grid = document.createElement('div');
                grid.className = 'verse-pill-grid';
                // Most chapters don't exceed 100 verses, showing a safe range.
                for (let i = 1; i <= 100; i++) {
                    const pill = document.createElement('div');
                    pill.className = 'verse-pill';
                    pill.textContent = i;
                    updateVersePillClass(pill, i);
                    pill.onclick = () => selectBibleVerse(i, pill);
                    grid.appendChild(pill);
                }
                content.appendChild(grid);
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn btn-primary btn-full';
                confirmBtn.style.marginTop = '20px';
                confirmBtn.textContent = 'Confirmar Versículos';
                confirmBtn.onclick = () => { closeBibleModal(); updateBibleCards(); };
                content.appendChild(confirmBtn);
            }
            lucide.createIcons();
        }

        function closeBibleModal() { closeModalWithAnim('bible-modal'); }

        function selectBibleBook(book) {
            bibleSelection.book = book.n;
            bibleSelection.chapter = 0;
            bibleSelection.vStart = 0;
            bibleSelection.vEnd = 0;
            updateBibleCards();
            closeBibleModal();
            openBibleModal('chapter');
        }

        function selectBibleChapter(ch) {
            bibleSelection.chapter = ch;
            bibleSelection.vStart = 0;
            bibleSelection.vEnd = 0;
            updateBibleCards();
            closeBibleModal();
            openBibleModal('verse');
        }

        function selectBibleVerse(v, el) {
            if (bibleSelection.vStart === 0 || (bibleSelection.vStart !== 0 && bibleSelection.vEnd !== 0)) {
                bibleSelection.vStart = v;
                bibleSelection.vEnd = 0;
            } else {
                if (v < bibleSelection.vStart) {
                    bibleSelection.vEnd = bibleSelection.vStart;
                    bibleSelection.vStart = v;
                } else {
                    bibleSelection.vEnd = v;
                }
            }
            // Refresh pills highlight
            document.querySelectorAll('.verse-pill').forEach((p, idx) => {
                const vn = idx + 1;
                p.className = 'verse-pill';
                updateVersePillClass(p, vn);
            });
        }

        function updateVersePillClass(p, v) {
            if (v === bibleSelection.vStart || v === bibleSelection.vEnd) p.classList.add('selected');
            else if (bibleSelection.vEnd !== 0 && v > bibleSelection.vStart && v < bibleSelection.vEnd) p.classList.add('in-range');
        }

        function updateBibleCards() {
            // Update Devotional section
            const bookText = document.getElementById('card-book-text');
            const capCard = document.getElementById('card-chapter');
            const capText = document.getElementById('card-chapter-text');
            const vsCard = document.getElementById('card-verse');
            const vsText = document.getElementById('card-verse-text');

            // Update Notes section
            const bookTextN = document.getElementById('card-book-text-notes');
            const capCardN = document.getElementById('card-chapter-notes');
            const capTextN = document.getElementById('card-chapter-text-notes');
            const vsCardN = document.getElementById('card-verse-notes');
            const vsTextN = document.getElementById('card-verse-text-notes');

            const vsShort = bibleSelection.vStart > 0 ? (bibleSelection.vEnd > 0 ? `${bibleSelection.vStart}-${bibleSelection.vEnd}` : `${bibleSelection.vStart}`) : 'Vs';
            const vsLong = bibleSelection.vStart > 0 ? (bibleSelection.vEnd > 0 ? `Vrs ${bibleSelection.vStart}-${bibleSelection.vEnd}` : `Versículo ${bibleSelection.vStart}`) : 'Versículos';

            // Devotional UI
            if (bookText) bookText.textContent = bibleSelection.book || 'Seleccionar Libro';
            if (capCard) {
                if (bibleSelection.book) {
                    capCard.classList.remove('disabled');
                    capText.textContent = bibleSelection.chapter ? `Capítulo ${bibleSelection.chapter}` : 'Capítulo';
                } else {
                    capCard.classList.add('disabled');
                    capText.textContent = 'Capítulo';
                }
            }
            if (vsCard) {
                if (bibleSelection.chapter > 0) {
                    vsCard.classList.remove('disabled');
                    vsText.textContent = vsLong;
                } else {
                    vsCard.classList.add('disabled');
                    vsText.textContent = 'Versículos';
                }
            }

            // Notes UI
            if (bookTextN) bookTextN.textContent = bibleSelection.book || 'Libro';
            if (capCardN) {
                if (bibleSelection.book) {
                    capCardN.classList.remove('disabled');
                    capTextN.textContent = bibleSelection.chapter ? `Cap ${bibleSelection.chapter}` : 'Cap';
                } else {
                    capCardN.classList.add('disabled');
                    capTextN.textContent = 'Cap';
                }
            }
            if (vsCardN) {
                if (bibleSelection.chapter > 0) {
                    vsCardN.classList.remove('disabled');
                    vsTextN.textContent = vsShort;
                } else {
                    vsCardN.classList.add('disabled');
                    vsTextN.textContent = 'Vs';
                }
            }

            validateDevotionalForm();
            lucide.createIcons();
        }

        function changeDate(offset) {
            const d = new Date(appState.viewDate + "T12:00:00");
            d.setDate(d.getDate() + offset);
            const str = localDateStr(d);
            const today = localDateStr();
            if (str > today) return;
            appState.viewDate = str; updateDateUI();
        }

        function updateDateUI() {
            const d = new Date(appState.viewDate + "T12:00:00");
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            const today = localDateStr();
            document.getElementById('header-date').textContent = new Date(localDateStr() + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
            document.getElementById('date-display-trigger').textContent = d.toLocaleDateString('es-ES', options);
            document.getElementById('next-date-btn').disabled = appState.viewDate === today;

            const entry = appState.devotionals[appState.viewDate] || { book: '', ch: '', vs: '', o: '', i: '', a: '', p: '' };

            // Sync with new selection system
            bibleSelection.book = entry.book || '';
            bibleSelection.chapter = parseInt(entry.ch) || 0;
            if (entry.vs) {
                const parts = entry.vs.split('-');
                bibleSelection.vStart = parseInt(parts[0]) || 0;
                bibleSelection.vEnd = parts[1] ? parseInt(parts[1]) : 0;
            } else {
                bibleSelection.vStart = 0; bibleSelection.vEnd = 0;
            }
            updateBibleCards();

            document.getElementById('dev-o').value = entry.o || '';
            document.getElementById('dev-i').value = entry.i || '';
            document.getElementById('dev-a').value = entry.a || '';
            document.getElementById('dev-p').value = entry.p || '';

            // Auto-resize after loading content
            ['dev-o', 'dev-i', 'dev-a', 'dev-p'].forEach(id => autoResize(document.getElementById(id)));

            // Lock logic for old entries
            const hasContent = entry.book || entry.o || entry.i || entry.a || entry.p;
            const isPast = appState.viewDate < today;

            if (isPast && hasContent) {
                setEditLock(true);
            } else {
                setEditLock(false);
            }

            if (!isEditLocked) {
                const fab = document.getElementById('save-fab');
                fab.className = 'fab-saved';
                document.getElementById('save-fab-icon').setAttribute('data-lucide', 'check');
                validateDevotionalForm();
            }
            lucide.createIcons();
        }

        function setEditLock(locked) {
            isEditLocked = locked;
            const view = document.getElementById('view-devotional');
            const saveBtn = document.getElementById('save-fab');
            const shareBtn = document.getElementById('share-fab');
            const saveIcon = document.getElementById('save-fab-icon');
            const saveText = document.getElementById('save-text');

            if (locked) {
                view.classList.add('view-locked');
                saveBtn.className = 'fab-locked';
                saveBtn.disabled = false;
                saveIcon.setAttribute('data-lucide', 'lock');
                if (saveText) saveText.textContent = 'Bloqueado';
                shareBtn.style.display = 'flex'; // Always show share when locked
            } else {
                view.classList.remove('view-locked');
                saveBtn.className = 'fab-unsaved';
                saveIcon.setAttribute('data-lucide', 'save');
                if (saveText) saveText.textContent = 'Guardar';
                shareBtn.style.display = 'flex'; // Always show share when unlocked
                validateDevotionalForm();
            }
            lucide.createIcons();
        }

        function toggleEdit() {
            setEditLock(!isEditLocked);
        }

        function markUnsaved() {
            const fab = document.getElementById('save-fab');
            const icon = document.getElementById('save-fab-icon');
            const text = document.getElementById('save-text');
            fab.className = 'fab-unsaved';
            icon.setAttribute('data-lucide', 'save');
            if (text) text.textContent = 'Guardar';
            lucide.createIcons();
        }

        function validateDevotionalForm() {
            const fab = document.getElementById('save-fab');
            if (!fab) return;
            const isBibleComplete = bibleSelection.book && bibleSelection.chapter > 0 && bibleSelection.vStart > 0;
            const isOIAComplete = document.getElementById('dev-o').value.trim() !== '' &&
                document.getElementById('dev-i').value.trim() !== '' &&
                document.getElementById('dev-a').value.trim() !== '' &&
                document.getElementById('dev-p').value.trim() !== '';

            if (isBibleComplete && isOIAComplete) {
                fab.classList.remove('fab-disabled');
                fab.disabled = false;
            } else {
                fab.classList.add('fab-disabled');
                fab.disabled = true;
            }
        }

        function saveDevotional() {
            if (isEditLocked) {
                toggleEdit();
                return;
            }

            const isBibleComplete = bibleSelection.book && bibleSelection.chapter > 0 && bibleSelection.vStart > 0;
            const isOIAComplete = document.getElementById('dev-o').value.trim() !== '' &&
                document.getElementById('dev-i').value.trim() !== '' &&
                document.getElementById('dev-a').value.trim() !== '' &&
                document.getElementById('dev-p').value.trim() !== '';

            if (!isBibleComplete || !isOIAComplete) {
                alert("Por favor, completa todos los campos antes de guardar. 🙏");
                return;
            }

            const vsStr = bibleSelection.vStart > 0 ? (bibleSelection.vEnd > 0 ? `${bibleSelection.vStart}-${bibleSelection.vEnd}` : `${bibleSelection.vStart}`) : '';
            appState.devotionals[appState.viewDate] = {
                book: bibleSelection.book,
                ch: bibleSelection.chapter,
                vs: vsStr,
                o: document.getElementById('dev-o').value,
                i: document.getElementById('dev-i').value,
                a: document.getElementById('dev-a').value,
                p: document.getElementById('dev-p').value
            };
            save(); updateDateUI();
            if (navigator.vibrate) navigator.vibrate(40);
        }

        // --- BIBLE LOGIC ---
        function renderBible() {
            const ot = document.getElementById('ot-container');
            const nt = document.getElementById('nt-container');
            ot.innerHTML = ''; nt.innerHTML = '';
            let totalRead = 0; const totalChapters = 1189;
            BOOKS.forEach(b => {
                const read = appState.reading[b.id] || [];
                totalRead += read.length;
                const pct = Math.round((read.length / b.c) * 100);
                const card = document.createElement('div');
                card.className = `book-item ${pct === 100 ? 'completed' : pct > 0 ? 'started' : ''}`;
                card.innerHTML = `
                    <div class="book-header" onclick="toggleChapters(${b.id})">
                        <div>
                            <strong style="font-size: 16px;">${b.n}</strong>
                            <div style="font-size: 11px; color: var(--text-muted);">${read.length} / ${b.c} capítulos</div>
                        </div>
                        <span class="tag" style="background: ${pct === 100 ? 'var(--success)' : pct > 0 ? 'var(--secondary)' : 'var(--border)'}">${pct}%</span>
                    </div>
                    <div id="ch-grid-${b.id}" class="chapter-pill-grid">
                        <div class="complete-book-row">
                            <span>Marcar libro como leído</span>
                            <input type="checkbox" ${pct === 100 ? 'checked' : ''} onchange="markWholeBook(${b.id}, this.checked)">
                        </div>
                        ${Array.from({ length: b.c }, (_, i) => { const cn = i + 1; const isR = read.includes(cn); return `<div class="chapter-pill ${isR ? 'read' : ''}" onclick="toggleCh(${b.id}, ${cn})">${cn}</div>`; }).join('')}
                    </div>
                `; (b.nt ? nt : ot).appendChild(card);
            });
            const globPct = Math.round((totalRead / totalChapters) * 100);
            document.getElementById('total-pct').textContent = globPct;
            document.getElementById('total-progress-bar').style.width = globPct + '%';
        }
        function toggleChapters(id) {
            const el = document.getElementById(`ch-grid-${id}`);
            const visible = el.style.display === 'grid';
            document.querySelectorAll('.chapter-pill-grid').forEach(g => g.style.display = 'none');
            el.style.display = visible ? 'none' : 'grid';
        }
        function toggleCh(bid, c) {
            if (!appState.reading[bid]) appState.reading[bid] = [];
            const idx = appState.reading[bid].indexOf(c);
            const book = BOOKS.find(b => b.id === bid);
            const wasCompleted = appState.reading[bid].length === book.c;

            if (idx > -1) appState.reading[bid].splice(idx, 1);
            else appState.reading[bid].push(c);

            save(); renderBible();
            document.getElementById(`ch-grid-${bid}`).style.display = 'grid';

            if (!wasCompleted && appState.reading[bid].length === book.c) {
                showCongrats(book.n);
            }
        }
        function markWholeBook(bid, check) {
            const b = BOOKS.find(x => x.id === bid);
            const wasCompleted = (appState.reading[bid] || []).length === b.c;
            appState.reading[bid] = check ? Array.from({ length: b.c }, (_, i) => i + 1) : [];
            save(); renderBible();
            document.getElementById(`ch-grid-${bid}`).style.display = 'grid';

            if (!wasCompleted && check) {
                showCongrats(b.n);
            }
        }



        // --- BIBLE READER LOGIC ---
        let bibleLibrary = {};
        let readerSQL = null;
        let isReaderLoading = false;

        function cleanReaderText(text, versionType) {
            if (!text) return "";
            let clean = String(text);

            // Reemplazar códigos de acentos RTF antes de quitar etiquetas
            clean = clean.replace(/\\'e1/g, "á").replace(/\\'e9/g, "é").replace(/\\'ed/g, "í")
                .replace(/\\'f3/g, "ó").replace(/\\'fa/g, "ú").replace(/\\'f1/g, "ñ")
                .replace(/\\'d1/g, "Ñ").replace(/\\'c1/g, "Á").replace(/\\'c9/g, "É")
                .replace(/\\'cd/g, "Í").replace(/\\'d3/g, "Ó").replace(/\\'da/g, "Ú");

            if (versionType === "RV60" || versionType === "NVI" || clean.includes('\\')) {
                // Quitar llaves pero mantener el contenido
                clean = clean.replace(/\{|\}/g, "");
                // Quitar etiquetas tipo \par o \f1, pero sin comerse letras siguientes
                // El regex busca \ seguido de letras y opcionalmente números, y un espacio opcional
                clean = clean.replace(/\\[a-z]+[0-9]* ?/g, "");
            }

            // Limpieza general
            clean = clean.replace(/<[^>]*>/g, ""); // HTML
            clean = clean.replace(/\([A-Z0-9]\)/g, "").replace(/\[[A-Z0-9]\]/g, ""); // Referencias

            return clean.replace(/\s+/g, ' ').trim();
        }

        async function initReader() {
            if (Object.keys(bibleLibrary).length > 0) {
                renderReaderContent();
                return;
            }
            if (isReaderLoading) return;
            isReaderLoading = true;

            document.getElementById('reader-loading').style.display = 'block';

            try {
                const config = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` };
                readerSQL = await initSqlJs(config);

                // Sequential loading with retries for better stability
                await loadBibleFile('biblias/RV60.json', 'json', 'RV60');
                await loadBibleFile('biblias/NVI.json', 'json', 'NVI');
                await loadBibleFile('biblias/NTV.mybible', 'sqlite', 'NTV');

                if (Object.keys(bibleLibrary).length === 0) {
                    showToast("Sin biblias. Comprueba la carpeta /biblias", "alert-triangle");
                }

                renderReaderVersions();
                updateReaderBookList();
                renderReaderContent(appState.readerLocation.scroll || 0);

            } catch (err) {
                console.error("Error initReader:", err);
            } finally {
                document.getElementById('reader-loading').style.display = 'none';
                isReaderLoading = false;
            }
        }

        async function loadBibleFile(url, type, name) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                if (type === 'json') {
                    const data = await response.json();
                    let items = Array.isArray(data) ? data : (data.verses || data.data || data.Bible || []);
                    if (!Array.isArray(items) && typeof items === 'object') items = Object.values(items).find(v => Array.isArray(v)) || [];
                    bibleLibrary[name] = { name, type: 'json', data: items };
                } else if (type === 'sqlite') {
                    const buffer = await response.arrayBuffer();
                    const db = new readerSQL.Database(new Uint8Array(buffer));
                    const res = db.exec("SELECT Book, Chapter, Verse, Scripture FROM Bible");
                    if (res && res.length > 0) {
                        const columns = res[0].columns;
                        const values = res[0].values;
                        const items = values.map(row => {
                            let obj = {};
                            columns.forEach((col, i) => obj[col] = row[i]);
                            return obj;
                        });
                        bibleLibrary[name] = { name, type: 'sqlite', data: items };
                    }
                }
            } catch (e) {
                console.error(`Error ${name}:`, e);
                // Detailed error mapping
                let msg = e.message;
                if (msg === 'Failed to fetch') msg = "No se pudo conectar al servidor local";
                showToast(`Error ${name}: ${msg}`, "x-circle");
            }
        }

        function renderReaderVersions() {
            const container = document.getElementById('reader-versions');
            if (!container) return;
            container.innerHTML = Object.keys(bibleLibrary).map(v => `
                <div class="version-pill-item ${v === appState.readerLocation.version ? 'active' : ''}" 
                     onclick="switchReaderVersion('${v}')">${v}</div>
            `).join('');
        }

        function switchReaderVersion(v) {
            appState.readerLocation.version = v;
            save();
            renderReaderVersions();
            renderReaderContent(appState.readerLocation.scroll || 0);
        }

        function updateReaderBookList() {
            const select = document.getElementById('reader-book');
            if (!select) return;
            select.innerHTML = BOOKS.map(b => `<option value="${b.id}" ${b.id === appState.readerLocation.book ? 'selected' : ''}>${b.n}</option>`).join('');
            updateReaderChapterList();
        }

        function updateReaderChapterList() {
            const bookId = parseInt(document.getElementById('reader-book').value);
            const book = BOOKS.find(b => b.id === bookId);
            const select = document.getElementById('reader-chapter');
            if (!select) return;
            select.innerHTML = Array.from({ length: book.c }, (_, i) => i + 1)
                .map(c => `<option value="${c}" ${c === appState.readerLocation.chapter ? 'selected' : ''}>Capítulo ${c}</option>`).join('');
        }

        function readerOnBookChange() {
            appState.readerLocation.book = parseInt(document.getElementById('reader-book').value);
            appState.readerLocation.chapter = 1;
            appState.readerLocation.scroll = 0;
            updateReaderChapterList();
            renderReaderContent(0);
            save();
        }

        function readerOnChapterChange() {
            appState.readerLocation.chapter = parseInt(document.getElementById('reader-chapter').value);
            appState.readerLocation.scroll = 0;
            renderReaderContent(0);
            save();
        }

        function renderReaderContent(targetScroll = 0) {
            const { version, book, chapter } = appState.readerLocation;
            const bible = bibleLibrary[version];
            const textContainer = document.getElementById('reader-text');
            if (!textContainer) return;

            if (!bible) {
                textContainer.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.5;">Versión ${version} no cargada.</div>`;
                return;
            }

            // Map data fields based on type
            const isSqlite = bible.type === 'sqlite';
            const firstVerse = bible.data[0] || {};
            const keys = Object.keys(firstVerse);

            const bKey = isSqlite ? 'Book' : (keys.find(k => /book|libro|id1/i.test(k)) || keys[0]);
            const cKey = isSqlite ? 'Chapter' : (keys.find(k => /chapter|capitulo|id2/i.test(k)) || keys[1]);
            const vKey = isSqlite ? 'Verse' : (keys.find(k => /verse|versiculo|id3/i.test(k)) || keys[4] || keys[2]);
            const tKey = isSqlite ? 'Scripture' : (keys.find(k => /scripture|texto|text|vtext/i.test(k)) || keys[3]);

            const verses = bible.data
                .filter(v => parseInt(v[bKey]) === book && parseInt(v[cKey]) === chapter)
                .sort((a, b) => parseInt(a[vKey]) - parseInt(b[vKey]));

            if (verses.length === 0) {
                textContainer.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.5;">Capítulo no disponible en esta versión.</div>`;
                return;
            }

            textContainer.innerHTML = verses.map(v => {
                const verseNum = parseInt(v[vKey]);
                const text = cleanReaderText(v[tKey], version);
                const highlightKey = `${book}-${chapter}-${verseNum}`;
                const highlightColor = appState.highlights[highlightKey] || "";
                const hasNote = appState.notes.some(n => n.bookId === book && n.chapter === chapter && (n.vStart === verseNum || (n.vStart <= verseNum && n.vEnd >= verseNum)));

                return `
                    <div class="verse-item ${highlightColor ? 'highlight-' + highlightColor : ''} ${hasNote ? 'verse-has-note' : ''}" 
                         onclick="toggleVerseSelection(${book}, ${chapter}, ${verseNum}, this)">
                        <span class="verse-num-badge">${verseNum}</span>
                        <div class="verse-text">${text}</div>
                    </div>`;
            }).join('');

            // Add "Mark as Read" button at the end
            const isRead = (appState.reading[book] || []).includes(chapter);
            const markReadHtml = `
                <div style="margin-top: 40px; padding: 20px; border-top: 1px solid var(--border); text-align: center;">
                    <button class="btn ${isRead ? 'btn-prayed' : 'btn-outline'}" 
                            style="width: 100%; max-width: 250px; margin: 0 auto; gap: 8px;" 
                            onclick="toggleReaderChapterRead()">
                        <i data-lucide="${isRead ? 'check-circle' : 'circle'}"></i>
                        ${isRead ? 'Capítulo Leído' : 'Marcar como Leído'}
                    </button>
                </div>
            `;
            textContainer.innerHTML += markReadHtml;
            lucide.createIcons();

            // Restore scroll position
            const container = document.getElementById('view-reader');
            container.scrollTop = targetScroll;
        }

        function readerNav(dir) {
            let { book: bookId, chapter } = appState.readerLocation;
            const book = BOOKS.find(b => b.id === bookId);

            if (dir === 1) { // Next
                if (chapter < book.c) {
                    appState.readerLocation.chapter++;
                } else if (bookId < 66) {
                    appState.readerLocation.book++;
                    appState.readerLocation.chapter = 1;
                }
            } else { // Prev
                if (chapter > 1) {
                    appState.readerLocation.chapter--;
                } else if (bookId > 1) {
                    appState.readerLocation.book--;
                    const prevBook = BOOKS.find(b => b.id === appState.readerLocation.book);
                    appState.readerLocation.chapter = prevBook.c;
                }
            }

            appState.readerLocation.scroll = 0;
            updateReaderBookList();
            renderReaderContent(0);
            save();
        }

        function toggleReaderChapterRead() {
            const { book, chapter } = appState.readerLocation;
            if (!appState.reading[book]) appState.reading[book] = [];

            const idx = appState.reading[book].indexOf(chapter);
            const bookObj = BOOKS.find(b => b.id === book);
            const wasCompleted = appState.reading[book].length === bookObj.c;

            if (idx > -1) {
                appState.reading[book].splice(idx, 1);
                showToast("Capítulo marcado como no leído");
            } else {
                appState.reading[book].push(chapter);
                showToast("¡Capítulo leído! ✨", "check");
                if (navigator.vibrate) navigator.vibrate(20);
            }

            save();
            renderReaderContent(appState.readerLocation.scroll || 0);
            renderBible(); // Sync the bible view progress

            if (idx === -1 && !wasCompleted && appState.reading[book].length === bookObj.c) {
                showCongrats(bookObj.n);
            }
        }

        // --- PRAYER LOGIC ---
        let editingPrayerId = null;
        function openPrayerModal(editId = null) {
            editingPrayerId = editId;
            const modal = document.getElementById('prayer-modal');
            const titleInput = document.getElementById('p-title');
            const detailsInput = document.getElementById('p-details');
            const modalTitle = document.querySelector('#prayer-modal h3');
            const saveBtn = document.querySelector('#prayer-modal .btn-primary');

            if (editId) {
                const p = appState.prayers.find(x => x.id === editId);
                titleInput.value = p.title;
                detailsInput.value = p.details || '';
                modalTitle.textContent = 'Editar Oración';
                saveBtn.textContent = 'Actualizar Petición';
            } else {
                titleInput.value = '';
                detailsInput.value = '';
                modalTitle.textContent = 'Nueva Oración';
                saveBtn.textContent = 'Guardar Petición';
            }
            modal.style.display = 'flex';
            autoResize(detailsInput);
        }

        function closePrayerModal() { editingPrayerId = null; closeModalWithAnim('prayer-modal'); }

        function addPrayer() {
            const t = document.getElementById('p-title').value;
            const d = document.getElementById('p-details').value;
            if (!t) return;

            if (editingPrayerId) {
                const p = appState.prayers.find(x => x.id === editingPrayerId);
                p.title = t;
                p.details = d;
                editingPrayerId = null;
                showToast("Oración actualizada", "check");
            } else {
                appState.prayers.push({
                    id: Date.now(),
                    title: t,
                    details: d,
                    created: new Date().toISOString(),
                    responded: null,
                    status: 'active'
                });
                showToast("Petición guardada", "check");
            }

            save(); renderPrayers(); closePrayerModal();
        }

        function togglePrayerExpansion(id) {
            const el = document.getElementById(`prayer-${id}`);
            el.classList.toggle('expanded');
        }

        function renderPrayers() {
            const active = document.getElementById('prayers-active'); const done = document.getElementById('prayers-answered');
            active.innerHTML = ''; done.innerHTML = '';
            const todayStr = localDateStr();

            appState.prayers.forEach(p => {
                const card = document.createElement('div');
                card.className = 'prayer-tile';
                card.id = `prayer-${p.id}`;
                const cDate = new Date(p.created).toLocaleDateString();

                if (p.status === 'active') {
                    const prayedToday = p.lastPrayed === todayStr;
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div onclick="togglePrayerExpansion(${p.id})" style="flex:1;">
                                <h3><i data-lucide="circle"></i> ${p.title}</h3>
                                <div class="prayer-meta">Iniciada el ${cDate}</div>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn-icon" onclick="openPrayerModal(${p.id})"><i data-lucide="edit-3" style="width:16px;"></i></button>
                                <button class="btn-icon" onclick="deletePrayer(${p.id})" style="color:#ff4757;"><i data-lucide="trash-2" style="width:16px;"></i></button>
                            </div>
                        </div>
                        <div class="prayer-body" onclick="togglePrayerExpansion(${p.id})">
                            <p style="font-size: 14px; color: var(--text-muted);">${p.details || ''}</p>
                            <div class="prayer-btns">
                                <button class="btn btn-outline ${prayedToday ? 'btn-prayed' : ''}" onclick="event.stopPropagation(); markPrayedToday(${p.id})">
                                    ${prayedToday ? '¡Amén!' : 'Oré hoy'}
                                </button>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); markAnswered(${p.id})">Respondida</button>
                            </div>
                        </div>`;
                    active.prepend(card);
                } else {
                    const days = Math.floor((new Date(p.responded) - new Date(p.created)) / 86400000);
                    card.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div style="flex:1;">
                            <h3><i data-lucide="check-circle" style="color:var(--success)"></i> ${p.title}</h3>
                            <div class="prayer-meta">Respondida después de ${days} días</div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-icon" onclick="restorePrayer(${p.id})"><i data-lucide="rotate-ccw" style="width:18px;"></i></button>
                            <button class="btn-icon" onclick="deletePrayer(${p.id})" style="color:#ff4757;"><i data-lucide="trash-2" style="width:18px;"></i></button>
                        </div>
                    </div>`;
                    done.prepend(card);
                }
            });
            lucide.createIcons();
        }
        function markAnswered(id) { const p = appState.prayers.find(x => x.id === id); p.status = 'answered'; p.responded = new Date().toISOString(); save(); renderPrayers(); }
        function restorePrayer(id) { const p = appState.prayers.find(x => x.id === id); p.status = 'active'; p.responded = null; save(); renderPrayers(); }

        function deletePrayer(id) {
            const modal = document.getElementById('confirm-modal');
            const btn = document.getElementById('btn-confirm-delete');
            modal.style.display = 'flex';
            btn.onclick = () => {
                appState.prayers = appState.prayers.filter(p => p.id !== id);
                save();
                renderPrayers();
                closeConfirmModal();
                showToast("Oración eliminada correctamente", "trash-2");
            };
        }
        function closeConfirmModal() { closeModalWithAnim('confirm-modal'); }

        function markPrayedToday(id) {
            const p = appState.prayers.find(x => x.id === id);
            const todayStr = localDateStr();
            if (p.lastPrayed === todayStr) return; // Already prayed

            p.lastPrayed = todayStr;
            save();
            renderPrayers();
            if (navigator.vibrate) navigator.vibrate([20, 30, 20]);
        }


        // Cerrar modales al hacer clic fuera (en el overlay)
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    if (overlay.id === 'calendar-overlay') closeCalendarPicker();
                    if (overlay.id === 'bible-modal') closeBibleModal();
                    if (overlay.id === 'camera-modal') closeCameraUI();
                    if (overlay.id === 'prayer-modal') closePrayerModal();
                    if (overlay.id === 'confirm-modal') closeConfirmModal();
                    if (overlay.id === 'note-modal') closeNoteModal();
                    if (overlay.id === 'reader-note-modal') closeReaderNoteModal();
                }
            });
        });

        // --- READER FEATURES: HIGHLIGHTS & NOTES ---
        let selectedVerse = null; // { bookId, chapter, verse }

        function toggleVerseSelection(bookId, chapter, verse, element) {
            const id = `${bookId}-${chapter}-${verse}`;

            // Remove previous selection UI
            document.querySelectorAll('.verse-item').forEach(el => el.classList.remove('selected-ui'));

            if (selectedVerse && selectedVerse.id === id) {
                selectedVerse = null;
                hideReaderToolbar();
            } else {
                selectedVerse = { bookId, chapter, verse, id };
                element.classList.add('selected-ui');
                showReaderToolbar();
            }
        }

        function showReaderToolbar() {
            const toolbar = document.getElementById('reader-toolbar');
            toolbar.classList.add('active');
            if (navigator.vibrate) navigator.vibrate(10);
        }

        function hideReaderToolbar() {
            const toolbar = document.getElementById('reader-toolbar');
            toolbar.classList.remove('active');
            document.querySelectorAll('.verse-item').forEach(el => el.classList.remove('selected-ui'));
        }

        function applyReaderHighlight(color) {
            if (!selectedVerse) return;
            if (color) {
                appState.highlights[selectedVerse.id] = color;
            } else {
                delete appState.highlights[selectedVerse.id];
            }
            save();
            renderReaderContent(appState.readerLocation.scroll || 0);
            hideReaderToolbar();
            selectedVerse = null;
        }

        function openReaderNoteModal() {
            editingNoteFromModalId = null; // New note mode
            if (!selectedVerse) return;
            const book = BOOKS.find(b => b.id === selectedVerse.bookId);
            document.getElementById('reader-note-title').textContent = `Nota en ${book.n} ${selectedVerse.chapter}:${selectedVerse.verse}`;

            // Look for existing note for this exact verse to pre-fill
            const existing = appState.notes.find(n => n.bookId === selectedVerse.bookId && n.chapter === selectedVerse.chapter && n.vStart === selectedVerse.verse && n.vEnd === 0);
            document.getElementById('reader-note-input').value = existing ? existing.note : '';

            document.getElementById('reader-note-modal').style.display = 'flex';
            autoResize(document.getElementById('reader-note-input'));
            lucide.createIcons();
        }

        function closeReaderNoteModal() {
            editingNoteFromModalId = null;
            hideReaderToolbar();
            closeModalWithAnim('reader-note-modal');
        }

        function saveReaderNote() {
            const text = document.getElementById('reader-note-input').value.trim();
            if (!text) return;

            let bookStr = "";
            let bookId = 0;
            let chapter = 0;
            let verse = 0;
            let vText = "";
            let version = appState.readerLocation.version;

            if (editingNoteFromModalId) {
                const n = appState.notes.find(x => x.id === editingNoteFromModalId);
                n.note = text;
            } else {
                if (!selectedVerse) return;
                const bookObj = BOOKS.find(b => b.id === selectedVerse.bookId);
                const verseElText = document.querySelector('.verse-item.selected-ui .verse-text')?.textContent || "";

                // Check if note exists for this exact verse to update it
                const existingIdx = appState.notes.findIndex(n => n.bookId === selectedVerse.bookId && n.chapter === selectedVerse.chapter && n.vStart === selectedVerse.verse && n.vEnd === 0);

                if (existingIdx !== -1) {
                    appState.notes[existingIdx].note = text;
                    appState.notes[existingIdx].vText = verseElText;
                    appState.notes[existingIdx].version = version;
                } else {
                    appState.notes.push({
                        id: Date.now(),
                        book: bookObj.n,
                        bookId: bookObj.id,
                        chapter: selectedVerse.chapter,
                        vStart: selectedVerse.verse,
                        vEnd: 0,
                        note: text,
                        vText: verseElText,
                        version: version
                    });
                }
            }

            save();
            if (document.getElementById('view-reader').classList.contains('active')) {
                renderReaderContent(appState.readerLocation.scroll || 0);
            }
            if (document.getElementById('view-notes').classList.contains('active')) {
                renderNotes();
            }
            closeReaderNoteModal();
            showToast("Nota guardada ✨", "check");
            selectedVerse = null;
            editingNoteFromModalId = null;
        }

        init();

        // PWA Service Worker Registration & Auto-Update
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    // Verificación forzada cada vez que se abre la app
                    reg.update();

                    reg.onupdatefound = () => {
                        const newWorker = reg.installing;
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showToast('App actualizada a la última versión ✨', 'refresh-cw');
                                // Recargamos después del toast para que el usuario use la nueva versión
                                setTimeout(() => window.location.reload(), 2000);
                            }
                        };
                    };
                }).catch(err => console.log('SW Failed', err));
            });

            // Detectar cuando el Service Worker toma el control (activación)
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    // No hace falta hacer nada aquí si ya manejamos installed, 
                    // pero asegura que la página se sincronice
                }
            });
        }
    </script>
</body>

</html>