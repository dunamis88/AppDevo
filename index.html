<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bible Note</title>
    <!-- SEO & PWA Meta -->
    <meta name="description" content="Tu compañero diario para el devocional, lectura bíblica y oración. 100% offline.">
    <meta name="theme-color" id="meta-theme-color" content="#2D294D">
    <link rel="manifest" href="manifest.json">

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Poppins:wght@400;500;600&display=swap"
        rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>

    <style>
        :root {
            /* Light Theme */
            --bg-body: #F8F9FD;
            --bg-card: #FFFFFF;
            --text-main: #2D3250;
            --text-muted: #707793;
            --primary: #6E56CF;
            --secondary: #45AEE9;
            --accent: #f8bb2a;
            --pink: #F04C7D;
            --success: #48BB78;
            --border: #E8EDF5;
            --shadow: 0 10px 25px rgba(110, 86, 207, 0.05);
            --nav-bg: rgba(255, 255, 255, 0.9);
            --radius-lg: 28px;
            --radius-md: 18px;
            --calendar-past: #BDC3C7;
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-body: #2D294D;
            --bg-card: #3A355F;
            --text-main: #FFFFFF;
            --text-muted: #A09DB1;
            --border: #4A4475;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            --nav-bg: rgba(45, 41, 77, 0.95);
            --calendar-past: #4A4475;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Allow selection only for user content */
        .oia-card textarea,
        .note-tile,
        .prayer-tile,
        #note-input,
        #p-title,
        #p-details,
        input[type="text"],
        textarea {
            user-select: text;
            -webkit-user-select: text;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1,
        h2,
        h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            margin: 0;
        }

        .glass {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        /* Onboarding */
        #onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-body);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        /* Header */
        header {
            padding: 20px 24px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .avatar-small {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(110, 86, 207, 0.3);
        }

        .avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-small i {
            color: white;
            stroke-width: 2.5;
        }

        .theme-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            box-shadow: var(--shadow);
            cursor: pointer;
        }

        /* Main Scroll Area */
        main {
            padding: 10px 24px 120px;
        }

        .view {
            display: none;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .view.active {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Date Container - Clickable */
        .date-navigator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-card);
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .nav-arrow {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--bg-body);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-arrow:active {
            transform: scale(0.9);
            background: var(--border);
        }

        .nav-arrow:disabled {
            opacity: 0.1;
            cursor: default;
        }

        #date-display-trigger {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
            text-transform: capitalize;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 10px;
            transition: 0.2s;
        }

        #date-display-trigger:active {
            background: var(--bg-body);
        }

        /* Forms */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 14px 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s, box-shadow 0.3s;
            resize: none;
            overflow: hidden;
        }

        input:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(110, 86, 207, 0.1);
        }

        .date-picker-placeholder {
            width: 100%;
            padding: 14px 16px;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-main);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bible-selector-card {
            background: var(--bg-card);
            padding: 14px 20px;
            border-radius: 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .bible-selector-card:active {
            transform: scale(0.98);
            background: var(--bg-body);
        }

        .bible-selector-card.disabled {
            opacity: 0.5;
            cursor: default;
        }

        .bible-selector-card i {
            color: var(--primary);
            width: 18px;
        }

        .oia-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .oia-card.accent-card {
            border-left: 6px solid var(--accent);
        }

        .oia-card.o-card {
            border-left: 6px solid var(--secondary);
        }

        .oia-card.i-card {
            border-left: 6px solid var(--pink);
        }

        .oia-card.a-card {
            border-left: 6px solid var(--success);
        }

        .oia-card i {
            color: var(--primary);
            margin-bottom: 10px;
            display: block;
        }

        .oia-card.o-card i {
            color: var(--secondary);
        }

        .oia-card.i-card i {
            color: var(--pink);
        }

        .oia-card.a-card i {
            color: var(--success);
        }

        .oia-card.accent-card i {
            color: var(--accent);
        }

        .oia-card h3 {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        /* Floating Save */
        .devotional-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            margin-bottom: 40px;
        }

        #save-fab,
        #share-fab {
            flex: 1;
            height: 54px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            gap: 10px;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow);
        }

        #save-fab {
            color: white;
            background: var(--primary);
        }

        .fab-unsaved {
            background: var(--secondary) !important;
            transform: scale(1.02);
        }

        .fab-saved {
            background: var(--success) !important;
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.2) !important;
        }

        .fab-disabled {
            background: var(--text-muted) !important;
            opacity: 0.5;
            cursor: default;
            transform: scale(0.95) !important;
            box-shadow: none !important;
        }

        .fab-locked {
            background: var(--accent) !important;
            color: white !important;
        }

        #share-fab {
            background: var(--bg-card);
            color: var(--primary);
            border: 1px solid var(--border);
        }

        #share-fab:active,
        #save-fab:active {
            transform: scale(0.95);
        }

        /* Progress Bar */
        /* Progress Bar (Gauge) */
        .stat-card {
            background: var(--bg-card);
            padding: 30px 24px 20px;
            border-radius: 30px;
            text-align: center;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .gauge-container {
            width: 220px;
            height: 120px;
            position: relative;
            margin-bottom: 0;
        }

        .gauge-svg {
            width: 100%;
            height: 100%;
        }

        .gauge-track {
            fill: none;
            stroke: var(--bg-body);
            stroke-width: 14;
            stroke-linecap: round;
        }

        .gauge-fill {
            fill: none;
            stroke: url(#gauge-gradient);
            stroke-width: 14;
            stroke-linecap: round;
            stroke-dasharray: 251.32;
            /* PI * 80 */
            stroke-dashoffset: 251.32;
            transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gauge-content {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #total-pct {
            font-size: 38px;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
        }

        .gauge-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
            font-weight: 600;
        }

        /* Bible List */
        .book-item {
            background: var(--bg-card);
            padding: 16px 20px;
            border-radius: 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: 0.3s;
        }

        .book-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .book-item.completed {
            border-left: 5px solid var(--success);
        }

        .book-item.started {
            border-left: 5px solid var(--secondary);
        }

        .chapter-pill-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(44px, 1fr));
            gap: 10px;
            padding-top: 16px;
            display: none;
        }

        .chapter-pill {
            height: 44px;
            border-radius: 14px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .chapter-pill.read {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .complete-book-row {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-body);
            padding: 12px 16px;
            border-radius: 14px;
            margin-bottom: 15px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-main);
            border: 1px solid var(--border);
        }

        .complete-book-row input {
            width: 20px;
            height: 20px;
            margin: 0;
            cursor: pointer;
        }

        /* Achievements */
        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .achievement-tile {
            background: var(--bg-card);
            padding: 20px 15px;
            border-radius: 24px;
            text-align: center;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0.6;
            filter: grayscale(0.8);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .achievement-tile:active {
            transform: scale(0.97);
        }

        .achievement-tile.unlocked {
            opacity: 1;
            filter: grayscale(0);
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(110, 86, 207, 0.05) 100%);
        }

        .achievement-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        .achievement-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 8px;
            display: block;
            line-height: 1.2;
        }

        .achievement-desc {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border);
            width: 100%;
        }

        .achievement-tile.expanded .achievement-desc {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Progress Bar */
        .achievement-progress-container {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 10px;
            margin-top: 12px;
            overflow: hidden;
            position: relative;
        }

        .achievement-progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 10px;
            transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
            width: 0%;
        }

        .achievement-pct-label {
            font-size: 10px;
            font-weight: 800;
            color: var(--primary);
            margin-top: 6px;
        }

        .btn-logros {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 12px 20px;
            border-radius: 18px;
            font-size: 15px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            width: 100%;
        }

        .btn-logros:active {
            transform: scale(0.96);
        }

        /* Achievements Modal Specific */
        #achievements-modal .modal-sheet {
            background: var(--bg-body);
        }

        /* Prayers */
        .prayer-tile {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: 0.3s;
        }

        .prayer-tile:active {
            transform: scale(0.98);
        }

        .prayer-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            margin-top: 0;
        }

        .prayer-tile.expanded .prayer-body {
            max-height: 1000px;
            /* Large enough */
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px dashed var(--border);
        }

        .prayer-tile h3 {
            font-size: 16px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            word-break: break-word;
        }

        .prayer-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .prayer-tile p {
            word-break: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
            margin: 0;
        }

        .prayer-btns {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .btn {
            border: none;
            padding: 12px 20px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-outline {
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
        }

        .btn-icon {
            padding: 8px;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-icon:hover {
            background: var(--border);
            color: var(--primary);
        }

        .btn-full {
            width: 100%;
            padding: 16px;
            border-radius: 18px;
            font-size: 16px;
        }

        .btn-prayed {
            background: var(--success) !important;
            color: white !important;
            border-color: var(--success) !important;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.2);
        }

        .view-locked textarea {
            pointer-events: none;
            background: rgba(0, 0, 0, 0.02);
        }

        /* Notes Section */
        .note-tile {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 12px 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: 0.3s;
        }

        .note-tile:active {
            transform: scale(0.98);
        }

        .note-tile h3 {
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
            color: white;
        }

        .note-header {
            background: var(--primary);
            padding: 12px 16px;
            margin: -12px -16px 12px -16px;
            border-radius: 20px 20px 5px 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(110, 86, 207, 0.2);
        }

        .note-header .btn-icon {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
        }

        .note-header .btn-icon:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .note-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .note-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-muted);
            margin-top: 0;
        }

        .note-text-content {
            white-space: pre-wrap;
            color: var(--text-main);
        }

        .note-tile.expanded .note-body {
            max-height: 1000px;
            margin-top: 4px;
            padding-top: 4px;
        }

        .note-verse-text {
            font-size: 15px;
            font-style: italic;
            color: white;
            background: var(--primary);
            padding: 10px 15px;
            border-radius: 12px;
            margin-bottom: 8px;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 4px 12px rgba(110, 86, 207, 0.15);
        }

        .note-verse-text::before {
            content: '“';
            font-size: 30px;
            position: absolute;
            top: -5px;
            left: 5px;
            opacity: 0.2;
            font-family: serif;
        }

        .note-verse-text::after {
            content: '”';
            font-size: 30px;
            position: absolute;
            bottom: -15px;
            right: 5px;
            opacity: 0.2;
            font-family: serif;
        }

        .note-version-tag {
            font-size: 10px;
            background: rgba(110, 86, 207, 0.1);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 6px;
            margin-left: 8px;
            text-transform: uppercase;
            font-weight: 800;
        }

        .sort-group {
            display: flex;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 12px;
            gap: 4px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .sort-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background: none;
            border-radius: 9px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .sort-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(110, 86, 207, 0.2);
        }

        .view-locked .bible-selector-card {
            pointer-events: none;
            opacity: 0.7;
        }

        .fab-locked {
            background: var(--bg-card) !important;
            color: var(--primary) !important;
            border: 1px solid var(--border) !important;
            box-shadow: var(--shadow) !important;
        }

        #camera-modal video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
            background: #000;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .btn-capture {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: white;
            border: 5px solid var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: 0.2s;
        }

        .btn-capture:active {
            transform: scale(0.9);
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5000;
            pointer-events: none;
        }

        .toast {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 14px 24px;
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 14px;
            animation: toastIn 0.5s cubic-bezier(0.16, 1, 0.3, 1), toastOut 0.5s 2.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            white-space: nowrap;
        }

        @keyframes toastIn {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes toastOut {
            from {
                transform: translateY(0);
                opacity: 1;
            }

            to {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        /* Bottom Navbar - Anchored */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(68px + env(safe-area-inset-bottom));
            background: var(--nav-bg);
            padding-bottom: env(safe-area-inset-bottom);
            display: flex;
            justify-content: space-evenly;
            align-items: center;
            box-shadow: 0 -5px 25px rgba(0, 0, 0, 0.1);
            border-top: 1px solid var(--border);
            z-index: 1800;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .bottom-nav.hide-nav {
            transform: translateY(100%);
        }

        .nav-item {
            border: none;
            background: none;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-width: 0;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
            transition: 0.3s;
            padding: 8px 0;
            border-radius: 16px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        /* CALENDAR COMPONENT - Matching Image */
        .calendar-card {
            background: var(--bg-body);
            border-radius: 32px 32px 0 0;
            /* Solo arriba */
            padding: 24px 24px 40px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 500px;
            border: 1px solid var(--border);
            animation: slideSheet 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .calendar-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
            text-transform: capitalize;
        }

        .calendar-nav-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 5px;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            margin-bottom: 15px;
        }

        .calendar-weekdays span {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-main);
            opacity: 0.8;
        }

        .calendar-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px 0;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-main);
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        .calendar-day.prev-month,
        .calendar-day.next-month {
            opacity: 0.2;
        }

        /* The Bubbles from image */
        .calendar-day.selected::before {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            z-index: -1;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .calendar-day.selected {
            color: white;
            font-weight: 700;
        }

        /* Various colored bubbles for gamification/status */
        .calendar-day.has-content {
            color: var(--accent);
            font-weight: 700;
        }

        .calendar-day.has-content::before {
            content: '';
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            opacity: 0.4;
            z-index: -1;
        }

        .calendar-day.has-content::after {
            content: '';
            position: absolute;
            bottom: 6px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        .calendar-day.today {
            color: var(--primary);
            font-weight: 800;
            text-decoration: underline;
        }

        /* Verses Grid */
        .verse-pill-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .verse-pill {
            height: 44px;
            border-radius: 12px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .verse-pill.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .verse-pill.in-range {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
            opacity: 0.7;
        }

        .calendar-day.disabled {
            cursor: default;
            opacity: 0.05;
        }

        /* Dropdown Selectors for Birthdate */
        .birth-selectors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1.2fr;
            gap: 10px;
            margin: 20px 0;
            display: none;
        }

        .birth-selectors-grid select {
            padding: 14px 10px;
            font-size: 14px;
            border-radius: 12px;
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            font-family: inherit;
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: flex-end;
            /* Anclado abajo */
            justify-content: center;
            z-index: 2500;
            padding: 0;
        }

        .modal-sheet {
            background: var(--bg-body);
            width: 100%;
            max-width: 500px;
            padding: 24px 24px 40px;
            border-radius: 32px 32px 0 0;
            animation: slideSheet 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideSheet {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes slideSheetOut {
            from {
                transform: translateY(0);
            }

            to {
                transform: translateY(100%);
            }
        }

        .modal-sheet.closing,
        .calendar-card.closing {
            animation: slideSheetOut 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Profile Photo */
        .photo-picker {
            width: 90px;
            height: 90px;
            background: var(--bg-card);
            border: 2px dashed var(--border);
            border-radius: 28px;
            margin: 0 auto 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .photo-picker img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            background: var(--primary);
            color: white;
        }

        /* Updated Bible Reader Styles */
        .reader-header {
            position: sticky;
            top: 0;
            background: var(--bg-body);
            padding: 16px 0;
            z-index: 1200;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s;
        }

        .reader-header.hide-header {
            transform: translateY(-100%);
            opacity: 0;
        }

        .reader-selector-pill {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 10px 18px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .reader-selector-pill:active {
            transform: scale(0.96);
        }

        .reader-selector-pill span {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-main);
        }

        .reader-nav-float {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            z-index: 1500;
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s;
        }

        .reader-nav-float.hide-nav {
            transform: translateY(120px);
            opacity: 0;
        }

        .nav-float-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            pointer-events: auto;
            transition: 0.3s;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .nav-float-btn:active {
            transform: scale(0.9);
        }

        .nav-float-btn i {
            width: 24px;
            height: 24px;
        }

        .reader-content {
            padding-bottom: 40px;
            /* Minimal space at the end */
            line-height: 1.8;
            font-size: 17px;
            text-align: justify;
        }

        /* Version selection integrated better */
        .version-pills-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0 16px;
            scrollbar-width: none;
        }

        .version-pills-container::-webkit-scrollbar {
            display: none;
        }

        .version-pill-item {
            padding: 8px 16px;
            border-radius: 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            font-size: 13px;
            font-weight: 700;
            color: var(--text-muted);
            white-space: nowrap;
            transition: 0.3s;
            cursor: pointer;
        }

        .version-pill-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(110, 86, 207, 0.3);
        }

        /* Reader Selector Modal Grid */
        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px 0;
        }

        .selector-item {
            padding: 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .selector-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chapter-circles {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .verse-item {
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 12px;
            padding: 10px 12px;
            margin-left: -8px;
            margin-right: -8px;
            margin-bottom: 8px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .verse-item:active {
            transform: scale(0.99);
        }

        .verse-num-badge {
            font-size: 14px;
            font-weight: 800;
            color: var(--primary);
            min-width: 24px;
            text-align: left;
            margin-top: 3px;
            opacity: 0.8;
            flex-shrink: 0;
        }

        .verse-text {
            flex: 1;
            font-size: var(--reader-font-size, 17px);
            line-height: 1.6;
            letter-spacing: -0.01em;
        }

        .reader-nav-btns {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .version-pills-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0 12px;
            scrollbar-width: none;
        }

        .version-pills-container::-webkit-scrollbar {
            display: none;
        }

        .version-pill-item {
            white-space: nowrap;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            color: var(--text-muted);
        }

        .version-pill-item.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(110, 86, 207, 0.2);
        }

        /* Reader Features Styles */
        .verse-item.selected-ui {
            background: rgba(110, 86, 207, 0.12);
            position: relative;
            z-index: 2;
        }

        .verse-item.selected-ui::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
            border-radius: 4px;
        }

        /* Continuous Highlighting CSS */
        .verse-item[class*="highlight-"],
        .verse-item.selected-ui {
            margin-bottom: 0;
            border-radius: 0;
        }

        .highlight-start,
        .selection-start {
            border-top-left-radius: 14px !important;
            border-top-right-radius: 14px !important;
            margin-top: 8px;
            padding-top: 14px;
        }

        .highlight-end,
        .selection-end {
            border-bottom-left-radius: 14px !important;
            border-bottom-right-radius: 14px !important;
            margin-bottom: 12px !important;
            padding-bottom: 14px;
        }

        .highlight-yellow {
            background: #f8bb2a;
            color: white !important;
        }

        .highlight-green {
            background: #48BB78;
            color: white !important;
        }

        .highlight-blue {
            background: #45AEE9;
            color: white !important;
        }

        .highlight-pink {
            background: #F04C7D;
            color: white !important;
        }

        [data-theme="dark"] .highlight-yellow {
            background: rgba(248, 187, 42, 0.4);
            color: white !important;
        }

        [data-theme="dark"] .highlight-green {
            background: rgba(72, 187, 120, 0.4);
            color: white !important;
        }

        [data-theme="dark"] .highlight-blue {
            background: rgba(69, 174, 233, 0.4);
            color: white !important;
        }

        [data-theme="dark"] .highlight-pink {
            background: rgba(240, 76, 125, 0.4);
            color: white !important;
        }

        [data-theme="dark"] .highlight-pink {
            background: rgba(240, 76, 125, 0.4);
            color: white !important;
        }

        /* Gray Theme */
        [data-theme="gray"] {
            --bg-body: #E5E5E5;
            --bg-card: #f5f5f5;
            --text-main: #2c2c2c;
            --text-muted: #5a5a5a;
            --primary: #4a4a4a;
            --secondary: #718096;
            --border: #d1d1d1;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .verse-has-note::after {
            content: "";
            display: inline-block;
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
        }

        .selection-toolbar {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(50px);
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: none;
            gap: 12px;
            align-items: center;
            z-index: 1000;
            border: 1px solid var(--border);
            transition: transform 0.3s, opacity 0.3s;
            opacity: 0;
        }

        .selection-toolbar.active {
            display: flex;
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .color-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .dot-none {
            background: transparent;
            border-color: var(--border);
            position: relative;
        }

        .dot-none::after {
            content: "/";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff4757;
            font-weight: bold;
        }

        .toolbar-btn {
            background: none;
            border: none;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            gap: 4px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .toolbar-btn:hover {
            background: var(--bg-body);
        }

        /* Reader Settings */
        .reader-settings-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 14px;
            color: var(--text-main);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-sm);
            transition: 0.2s;
        }

        .reader-settings-btn:active {
            transform: scale(0.95);
        }

        .settings-grid {
            display: grid;
            gap: 20px;
            margin-top: 10px;
        }

        .settings-option {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .settings-label {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .theme-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .theme-opt {
            padding: 12px;
            border-radius: 12px;
            border: 2px solid var(--border);
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .theme-opt.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .font-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .font-opt {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .font-opt.active {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary);
        }

        .size-slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg-card);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .size-slider {
            flex: 1;
            accent-color: var(--primary);
        }

        /* Apply reader settings */
        .reader-content.font-serif {
            font-family: 'Crimson Text', Georgia, 'Times New Roman', serif;
        }

        .reader-content.font-sans {
            font-family: 'Poppins', sans-serif;
        }

        .reader-content.font-mono {
            font-family: 'Fira Code', 'Courier New', monospace;
        }
    </style>
</head>

<body>

    <!-- ONBOARDING -->
    <div id="onboarding-overlay" style="display:none;">
        <div class="card">
            <div class="avatar-small" style="width: 70px; height: 70px; margin: 0 auto 20px;">
                <i data-lucide="cross"></i>
            </div>
            <h2 style="text-align: center; margin-bottom: 8px;">¡Hola!</h2>
            <p style="text-align: center; color: var(--text-muted); margin-bottom: 24px; font-size: 14px;">Comencemos
                este viaje devocional juntos.</p>

            <div class="photo-picker-group" style="text-align:center; margin-bottom:24px;">
                <div class="photo-picker" id="reg-photo-container">
                    <img id="reg-photo-preview" src="" style="display:none;">
                    <i data-lucide="user" id="reg-photo-icon" style="width:40px; height:40px; opacity:0.5;"></i>
                </div>
                <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
                    <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                        onclick="document.getElementById('reg-photo-input').click()">
                        <i data-lucide="image" style="width:14px;"></i> Galería
                    </button>
                    <button class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;"
                        onclick="openCameraUI('reg')">
                        <i data-lucide="camera" style="width:14px;"></i> Cámara
                    </button>
                </div>
                <input type="file" id="reg-photo-input" hidden accept="image/*" onchange="handleRegPhoto(this)">
            </div>

            <div class="input-group">
                <label>Nombre y Apellido</label>
                <input type="text" id="reg-name" placeholder="Tu nombre">
            </div>
            <div class="input-group">
                <label>Fecha de Nacimiento</label>
                <div class="date-picker-placeholder" onclick="openCalendarPicker('birth')">
                    <span id="reg-birth-display">Seleccionar fecha</span>
                    <i data-lucide="calendar" style="width:18px;"></i>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="finishOnboarding()">
                Comenzar <i data-lucide="arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="profile-trigger" onclick="switchTab('profile')">
            <div class="avatar-small" id="header-avatar">
                <i data-lucide="user"></i>
            </div>
            <div>
                <h3 id="user-greeting" style="font-size: 15px;">Hola</h3>
                <span id="header-date" style="font-size: 11px; color: var(--text-muted);">Cargando...</span>
            </div>
        </div>
        <button class="theme-btn" id="theme-toggle">
            <i data-lucide="moon" id="theme-icon"></i>
        </button>
    </header>

    <div id="toast-container"></div>

    <main>
        <!-- VISTA: DEVOCIONAL -->
        <div id="view-devotional" class="view">
            <div class="date-navigator">
                <button class="nav-arrow" onclick="changeDate(-1)"><i data-lucide="chevron-left"></i></button>
                <span id="date-display-trigger" onclick="openCalendarPicker('devotional')">Hoy</span>
                <button class="nav-arrow" id="next-date-btn" onclick="changeDate(1)"><i
                        data-lucide="chevron-right"></i></button>
            </div>

            <!-- Selector de Biblia Rediseñado -->
            <div id="bible-selector-container" style="margin-bottom: 24px;">
                <label>Pasaje Bíblico</label>
                <div class="bible-selector-card" onclick="openBibleModal('book')">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <i data-lucide="book"></i>
                        <span id="card-book-text">Seleccionar Libro</span>
                    </div>
                    <i data-lucide="chevron-right" style="width:14px; opacity:0.5;"></i>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="bible-selector-card disabled" id="card-chapter" onclick="openBibleModal('chapter')">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <i data-lucide="layout-grid"></i>
                            <span id="card-chapter-text">Capítulo</span>
                        </div>
                        <i data-lucide="chevron-right" style="width:14px; opacity:0.5;"></i>
                    </div>
                    <div class="bible-selector-card disabled" id="card-verse" onclick="openBibleModal('verse')">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <i data-lucide="hash"></i>
                            <span id="card-verse-text">Versículos</span>
                        </div>
                        <i data-lucide="chevron-right" style="width:14px; opacity:0.5;"></i>
                    </div>
                </div>
            </div>

            <div class="oia-card o-card">
                <h3><i data-lucide="eye" style="width:16px;"></i> OBSERVACIÓN</h3>
                <textarea id="dev-o" rows="3" placeholder="¿Qué dice el texto?"
                    oninput="markUnsaved(); autoResize(this)"></textarea>
            </div>
            <div class="oia-card i-card">
                <h3><i data-lucide="search" style="width:16px;"></i> INTERPRETACIÓN</h3>
                <textarea id="dev-i" rows="3" placeholder="¿Qué significa?"
                    oninput="markUnsaved(); autoResize(this)"></textarea>
            </div>
            <div class="oia-card a-card">
                <h3><i data-lucide="heart" style="width:16px;"></i> APLICACIÓN</h3>
                <textarea id="dev-a" rows="3" placeholder="¿Cómo lo aplico a mi vida?"
                    oninput="markUnsaved(); autoResize(this)"></textarea>
            </div>
            <div class="oia-card accent-card">
                <h3><i data-lucide="flame" style="width:16px;"></i> MI ORACIÓN</h3>
                <textarea id="dev-p" rows="3" placeholder="Escribe tu oración de hoy..."
                    oninput="markUnsaved(); autoResize(this)"></textarea>
            </div>

            <div class="devotional-actions">
                <button id="share-fab" onclick="shareDevotional()">
                    <i data-lucide="share-2" style="width:20px;"></i> Compartir
                </button>
                <button id="save-fab" class="fab-saved" onclick="saveDevotional()">
                    <i data-lucide="check" id="save-fab-icon" style="width:20px;"></i> <span
                        id="save-text">Guardado</span>
                </button>
            </div>
        </div>

        <!-- VISTA: NOTAS BÍBLICAS -->
        <div id="view-notes" class="view">
            <h2>Notas Bíblicas</h2>
            <p style="color:var(--text-muted); font-size:13px; margin-bottom:20px;">Consulta tus reflexiones sobre
                versículos específicos.</p>

            <div class="sort-group">
                <button id="sort-date" class="sort-btn active" onclick="setNoteSort('date')">
                    <i data-lucide="calendar"></i> Fecha
                </button>
                <button id="sort-bible" class="sort-btn" onclick="setNoteSort('bible')">
                    <i data-lucide="book"></i> Orden Bíblico
                </button>
            </div>

            <div id="notes-list"></div>
        </div>

        <div id="view-bible" class="view">
            <h2>Registro de Lectura</h2>
            <br>
            <button class="btn-logros" onclick="openAchievementsModal()">
                <i data-lucide="award"></i> Ver mis Logros
            </button>
            <div class="stat-card">
                <div class="gauge-container">
                    <svg class="gauge-svg" viewBox="0 0 200 120">
                        <defs>
                            <linearGradient id="gauge-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:var(--primary);stop-opacity:1" />
                                <stop offset="100%" style="stop-color:var(--secondary);stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <!-- Arc from (20,100) to (180,100) radius 80 -->
                        <path class="gauge-track" d="M 20 100 A 80 80 0 0 1 180 100" />
                        <path id="total-progress-bar" class="gauge-fill" d="M 20 100 A 80 80 0 0 1 180 100" />
                    </svg>
                    <div class="gauge-content">
                        <h2><span id="total-pct">0</span>%</h2>
                        <span class="gauge-label">Biblia Completa</span>
                    </div>
                </div>
            </div>
            <h3 style="margin-bottom: 16px; font-size: 18px;">Antiguo Testamento</h3>
            <div id="ot-container"></div>
            <h3 style="margin: 24px 0 16px; font-size: 18px;">Nuevo Testamento</h3>
            <div id="nt-container"></div>
        </div>

        <!-- VISTA: BIBLIA (LECTOR) -->
        <div id="view-reader" class="view active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Santa Biblia</h2>
                <div id="reader-loading" class="tag" style="background: var(--secondary); display:none;">Cargando...
                </div>
            </div>

            <div class="reader-header">
                <div class="reader-selector-pill" onclick="openReaderSelector()">
                    <i data-lucide="book-open" style="width:18px; color:var(--primary);"></i>
                    <span id="reader-current-book-ch">Cargando...</span>
                    <i data-lucide="chevron-down" style="width:14px; color:var(--text-muted);"></i>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div id="reader-current-version-tag" class="tag"
                        style="background:var(--secondary); border-radius:12px; padding:6px 12px; font-size:12px;">RV60
                    </div>
                    <button class="reader-settings-btn" onclick="openReaderSettings()">
                        <i data-lucide="settings" style="width:18px;"></i>
                    </button>
                </div>
            </div>

            <div class="version-pills-container" id="reader-versions">
                <!-- Pills injected here -->
            </div>

            <div class="reader-nav-float">
                <button class="nav-float-btn" onclick="readerNav(-1)" title="Capítulo Anterior">
                    <i data-lucide="chevron-left"></i>
                </button>
                <button class="nav-float-btn" onclick="readerNav(1)" title="Capítulo Siguiente">
                    <i data-lucide="chevron-right"></i>
                </button>
            </div>

            <div class="reader-content" id="reader-text">
                <div style="text-align:center; padding: 40px; color: var(--text-muted);">
                    <i data-lucide="book-open" style="width:48px; height:48px; margin-bottom:16px; opacity:0.3;"></i>
                    <p>Cargando biblioteca bíblica...</p>
                </div>
            </div>
        </div>

        <!-- VISTA: ORACIONES -->
        <div id="view-prayers" class="view">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="display: flex; align-items: center; gap: 12px;"><i data-lucide="flame"
                        style="color: var(--primary);"></i> Mis Oraciones</h2>
                <button class="btn btn-primary" onclick="openPrayerModal()"><i data-lucide="plus"></i> Nueva</button>
            </div>
            <div id="prayers-active"></div>
            <h2
                style="margin: 32px 0 16px; color: var(--text-muted); font-size: 18px; display: flex; align-items: center; gap: 10px;">
                <i data-lucide="check-circle" style="width: 20px;"></i> Respondidas
            </h2>
            <div id="prayers-answered"></div>
        </div>

        <!-- VISTA: PERFIL -->
        <div id="view-profile" class="view">
            <h2>Mi Cuenta</h2>
            <br>
            <div class="card" style="max-width: none;">
                <div class="photo-picker-group" style="text-align:center; margin-bottom:24px;">
                    <div class="photo-picker" id="profile-photo-container">
                        <div id="photo-preview"><i data-lucide="user"
                                style="width: 32px; height: 32px; opacity:0.5;"></i></div>
                    </div>
                    <div style="display:flex; justify-content:center; gap:10px; margin-top:12px;">
                        <button class="btn btn-outline" style="padding: 8px 12px; font-size: 12px;"
                            onclick="document.getElementById('profile-file').click()">
                            <i data-lucide="image" style="width:14px;"></i> Galería
                        </button>
                        <button class="btn btn-primary" style="padding: 8px 12px; font-size: 12px;"
                            onclick="openCameraUI('profile')">
                            <i data-lucide="camera" style="width:14px;"></i> Cámara
                        </button>
                    </div>
                    <input type="file" id="profile-file" hidden accept="image/*" onchange="previewPhoto(this)">
                </div>
                <div class="input-group">
                    <label>Nombre</label>
                    <input type="text" id="profile-name">
                </div>
                <div class="input-group">
                    <label>Fecha de Nacimiento</label>
                    <div class="date-picker-placeholder" onclick="openCalendarPicker('birthProfile')">
                        <span id="profile-birth-display">Seleccionar</span>
                        <i data-lucide="calendar" style="width:18px;"></i>
                    </div>
                </div>
                <button class="btn btn-primary btn-full" onclick="updateProfile()">Guardar Cambios</button>

                <div style="margin-top: 32px; border-top: 1px solid var(--border); padding-top: 24px;">
                    <h3 style="font-size: 14px; color: var(--text-muted); margin-bottom: 16px;">SEGURIDAD Y RESPALDO
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button class="btn btn-outline" onclick="exportBackup()">
                            <i data-lucide="download"></i> Exportar
                        </button>
                        <button class="btn btn-outline" onclick="document.getElementById('import-file').click()">
                            <i data-lucide="upload"></i> Importar
                        </button>
                    </div>
                    <input type="file" id="import-file" hidden accept=".json" onchange="importBackup(this)">
                </div>
            </div>
        </div>
    </main>

    <!-- BOTTOM NAV -->
    <nav class="bottom-nav glass">
        <button class="nav-item" onclick="switchTab('devotional')" id="nav-devotional"><i data-lucide="book-open"
                style="width:20px; height:20px;"></i><span>Devocional</span></button>
        <button class="nav-item" onclick="switchTab('notes')" id="nav-notes"><i data-lucide="file-text"
                style="width:20px; height:20px;"></i><span>Notas</span></button>
        <button class="nav-item" onclick="switchTab('reader')" id="nav-reader"><i data-lucide="book"
                style="width:20px; height:20px;"></i><span>Biblia</span></button>
        <button class="nav-item" onclick="switchTab('bible')" id="nav-bible"><i data-lucide="clipboard-check"
                style="width:20px; height:20px;"></i><span>Registro</span></button>
        <button class="nav-item" onclick="switchTab('prayers')" id="nav-prayers">
            <i data-lucide="flame" style="width:20px; height:20px;"></i>
            <span>Oraciones</span>
        </button>
    </nav>

    <!-- CALENDAR/SELECTOR MODAL -->
    <div class="modal-overlay" id="calendar-overlay">
        <div class="calendar-card" id="calendar-card">
            <h3 id="selector-modal-title" style="margin-bottom: 20px; text-align: center; font-size: 18px;">Seleccionar
                Fecha</h3>

            <!-- Modo Calendario (Devocional) -->
            <div id="calendar-ui-group">
                <div class="calendar-header">
                    <button class="calendar-nav-btn" onclick="navCalendar(-1)"><i
                            data-lucide="chevron-left"></i></button>
                    <div class="calendar-title" id="calendar-month-year" onclick="toggleYearMode()"
                        style="cursor:pointer; display:flex; align-items:center; gap:5px;">
                        <span id="calendar-title-text">Junio 2024</span>
                        <i data-lucide="chevron-down" style="width:14px;"></i>
                    </div>
                    <button class="calendar-nav-btn" onclick="navCalendar(1)"><i
                            data-lucide="chevron-right"></i></button>
                </div>
                <div class="calendar-weekdays">
                    <span>D</span><span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span>
                </div>
                <div class="calendar-days-grid" id="calendar-days"></div>
            </div>

            <!-- Modo Listas Desplegables (Nacimiento) -->
            <div id="birth-ui-group" style="display: none;">
                <div class="birth-selectors-grid">
                    <select id="sel-day"></select>
                    <select id="sel-month">
                        <option value="0">Enero</option>
                        <option value="1">Febrero</option>
                        <option value="2">Marzo</option>
                        <option value="3">Abril</option>
                        <option value="4">Mayo</option>
                        <option value="5">Junio</option>
                        <option value="6">Julio</option>
                        <option value="7">Agosto</option>
                        <option value="8">Septiembre</option>
                        <option value="9">Octubre</option>
                        <option value="10">Noviembre</option>
                        <option value="11">Diciembre</option>
                    </select>
                    <select id="sel-year"></select>
                </div>
                <button class="btn btn-primary btn-full" onclick="confirmBirthDate()">Confirmar Fecha</button>
            </div>

            <button class="btn btn-full btn-outline" style="margin-top: 20px;"
                onclick="closeCalendarPicker()">Cancelar</button>
        </div>
    </div>

    <!-- BIBLE SELECTOR MODAL -->
    <div class="modal-overlay" id="bible-modal">
        <div class="modal-sheet" style="max-height: 80vh; overflow-y: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 id="bible-modal-title" style="font-size: 20px;">Seleccionar</h3>
                <button style="background:none; border:none; color:var(--text-muted);" onclick="closeBibleModal()"><i
                        data-lucide="x"></i></button>
            </div>
            <div id="bible-modal-content"></div>
        </div>
    </div>

    <!-- READER SELECTOR MODAL -->
    <div class="modal-overlay" id="reader-selector-modal">
        <div class="modal-sheet" style="max-height: 85vh; overflow-y: auto;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; position: sticky; top: -24px; background: var(--bg-body); z-index: 10; padding: 15px 0;">
                <h3 id="selector-modal-title" style="font-size: 20px;">Seleccionar Libro</h3>
                <button style="background:none; border:none; color:var(--text-muted);"
                    onclick="closeReaderSelector()"><i data-lucide="x"></i></button>
            </div>
            <div id="selector-modal-content"></div>
        </div>
    </div>
    <div class="modal-overlay" id="camera-modal">
        <div class="modal-sheet" style="max-height: 90vh;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="font-size: 18px;">Tomar Foto</h3>
                <button style="background:none; border:none; color:var(--text-muted);" onclick="closeCameraUI()"><i
                        data-lucide="x"></i></button>
            </div>
            <div style="aspect-ratio: 1; position: relative; overflow: hidden; border-radius: 20px;">
                <video id="camera-stream" autoplay playsinline></video>
                <canvas id="camera-canvas" style="display:none;"></canvas>
            </div>
            <div class="camera-controls">
                <button class="btn-capture" onclick="capturePhoto()">
                    <i data-lucide="aperture" style="color:var(--primary); width:32px; height:32px;"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="prayer-modal">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="font-size: 20px; display: flex; align-items: center; gap: 10px;"><i data-lucide="flame"
                        style="color: var(--primary);"></i> Nueva Oración</h3>
                <button style="background:none; border:none; color:var(--text-muted);" onclick="closePrayerModal()"><i
                        data-lucide="x"></i></button>
            </div>
            <div class="input-group">
                <label>Asunto / Petición</label>
                <input type="text" id="p-title" placeholder="Ej: Por mi familia">
            </div>
            <div class="input-group">
                <label>Detalles</label>
                <textarea id="p-details" rows="3" placeholder="Relátale a Dios tu corazón..."
                    oninput="autoResize(this)"></textarea>
            </div>
            <button class="btn btn-primary btn-full" onclick="addPrayer()">Guardar Petición</button>
        </div>
    </div>



    <div class="modal-overlay" id="confirm-modal">
        <div class="modal-sheet" style="padding-bottom: 30px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div
                    style="width: 60px; height: 60px; background: rgba(255, 71, 87, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                    <i data-lucide="trash-2" style="color: #ff4757; width: 30px; height: 30px;"></i>
                </div>
                <h3 style="font-size: 20px; margin-bottom: 10px;">¿Eliminar Oración?</h3>
                <p style="color: var(--text-muted); font-size: 14px; line-height: 1.5;">Esta acción no se puede
                    deshacer. La oración será borrada permanentemente.</p>
            </div>
            <div style="display: grid; gap: 12px;">
                <button class="btn btn-primary" style="background: #ff4757; border-color: #ff4757;"
                    id="btn-confirm-delete">Sí, eliminar</button>
                <button class="btn btn-outline" onclick="closeConfirmModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- CONGRATULATIONS MODAL -->
    <div class="modal-overlay" id="congrats-modal">
        <div class="modal-sheet" style="padding-bottom: 40px; text-align: center;">
            <div style="font-size: 60px; margin-bottom: 20px;">🏆</div>
            <h2 style="font-size: 24px; margin-bottom: 10px; color: var(--primary);">¡Felicitaciones!</h2>
            <p id="congrats-text"
                style="color: var(--text-muted); font-size: 16px; line-height: 1.6; margin-bottom: 30px;">
                Has completado la lectura del libro de <strong>Génesis</strong>. ¡Sigue así!
            </p>
            <button class="btn btn-primary btn-full" onclick="closeCongratsModal()">
                ¡Gloria a Dios! 🙏
            </button>
        </div>
    </div>

    <!-- SELECTION TOOLBAR -->
    <div id="reader-toolbar" class="selection-toolbar">
        <div class="color-dot dot-none" onclick="applyReaderHighlight(null)" title="Quitar color"></div>
        <div class="color-dot highlight-yellow" onclick="applyReaderHighlight('yellow')"
            style="background:#ffd43b; border-color:#fab005;"></div>
        <div class="color-dot highlight-green" onclick="applyReaderHighlight('green')"
            style="background:#51cf66; border-color:#40c057;"></div>
        <div class="color-dot highlight-blue" onclick="applyReaderHighlight('blue')"
            style="background:#339af0; border-color:#228be6;"></div>
        <div class="color-dot highlight-pink" onclick="applyReaderHighlight('pink')"
            style="background:#ff87b2; border-color:#f06595;"></div>
        <div style="width:1px; height:24px; background:var(--border); margin:0 4px;"></div>
        <button class="toolbar-btn" onclick="openReaderNoteModal()">
            <i data-lucide="sticky-note" style="width:18px;"></i>
            <span>Nota</span>
        </button>
        <button class="toolbar-btn" onclick="shareVerse()">
            <i data-lucide="share-2" style="width:18px;"></i>
            <span>Compartir</span>
        </button>
    </div>

    <!-- ACHIEVEMENTS MODAL -->
    <div class="modal-overlay" id="achievements-modal">
        <div class="modal-sheet" style="max-height: 85vh; overflow-y: auto;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; position: sticky; top: -24px; background: var(--bg-body); z-index: 10; padding: 15px 0;">
                <h3 style="font-size: 20px; display: flex; align-items: center; gap: 10px;"><i data-lucide="award"
                        style="color: var(--primary);"></i> Mis Logros</h3>
                <button style="background:none; border:none; color:var(--text-muted);"
                    onclick="closeAchievementsModal()"><i data-lucide="x"></i></button>
            </div>

            <h4
                style="font-size: 14px; color: var(--text-muted); margin: 20px 0 10px; text-transform: uppercase; letter-spacing: 1px;">
                Logros por Porcentaje</h4>
            <div id="achievements-pct-grid" class="achievement-grid" style="margin-bottom: 30px;"></div>

            <h4
                style="font-size: 14px; color: var(--text-muted); margin: 20px 0 10px; text-transform: uppercase; letter-spacing: 1px;">
                Logros por Colecciones</h4>
            <div id="achievements-books-grid" class="achievement-grid"></div>
        </div>
    </div>

    <!-- NEW ACHIEVEMENT POPUP -->
    <div class="modal-overlay" id="achievement-unlocked-modal" style="z-index: 6000;">
        <div class="modal-sheet" style="text-align: center; padding: 40px 24px;">
            <div id="unlock-emoji" style="font-size: 64px; margin-bottom: 20px;">🎖️</div>
            <h2 style="font-size: 24px; margin-bottom: 8px; color: var(--primary);">¡Logro Desbloqueado!</h2>
            <h3 id="unlock-name" style="font-size: 20px; margin-bottom: 12px; font-weight: 800;">Nombre del Logro</h3>
            <p id="unlock-desc"
                style="color: var(--text-muted); font-size: 15px; line-height: 1.6; margin-bottom: 30px;">Descripción
                del logro aquí.</p>
            <button class="btn btn-primary btn-full" onclick="closeUnlockModal()">
                ¡Gloria a Dios! 🙏
            </button>
        </div>
    </div>

    <!-- READER NOTE MODAL -->
    <div id="reader-note-modal" class="modal-overlay" style="display:none;">
        <div class="modal-sheet" style="max-height: 480px; padding:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h3 id="reader-note-title" style="font-size: 18px;">Nota en Juan 3:16</h3>
                <button class="btn-icon" onclick="closeReaderNoteModal()"><i data-lucide="x"></i></button>
            </div>
            <textarea id="reader-note-input" rows="6" placeholder="Escribe tu reflexión aquí..."
                oninput="autoResize(this)"
                style="width:100%; padding:12px; border-radius:12px; background:var(--bg-body); border:1px solid var(--border); color:var(--text-main); font-family:inherit; resize:none; font-size: 15px;"></textarea>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn btn-outline btn-full" onclick="closeReaderNoteModal()">Cancelar</button>
                <button class="btn btn-primary btn-full" onclick="saveReaderNote()">Guardar Nota</button>
            </div>
        </div>
    </div>

    </div>
    </div>

    <!-- READER SETTINGS MODAL -->
    <div class="modal-overlay" id="reader-settings-modal">
        <div class="modal-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h3 style="font-size: 20px; display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="settings" style="color: var(--primary);"></i> Opciones de Lectura
                </h3>
                <button style="background:none; border:none; color:var(--text-muted);" onclick="closeReaderSettings()">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div class="settings-grid">
                <!-- Tema -->
                <div class="settings-option">
                    <span class="settings-label">Tema</span>
                    <div class="theme-selector">
                        <div class="theme-opt" id="theme-light" onclick="setReaderTheme('light')">Claro</div>
                        <div class="theme-opt" id="theme-dark" onclick="setReaderTheme('dark')">Oscuro</div>
                        <div class="theme-opt" id="theme-gray" onclick="setReaderTheme('gray')">Gris</div>
                    </div>
                </div>

                <!-- Fuente -->
                <div class="settings-option">
                    <span class="settings-label">Tipo de Letra</span>
                    <div class="font-selector">
                        <div class="font-opt" id="font-sans" onclick="setReaderFontFamily('sans')"
                            style="font-family: 'Poppins', sans-serif;">Sans</div>
                        <div class="font-opt" id="font-serif" onclick="setReaderFontFamily('serif')"
                            style="font-family: serif;">Serif</div>
                        <div class="font-opt" id="font-mono" onclick="setReaderFontFamily('mono')"
                            style="font-family: monospace;">Mono</div>
                    </div>
                </div>

                <!-- Tamaño -->
                <div class="settings-option">
                    <span class="settings-label">Tamaño de Letra</span>
                    <div class="size-slider-container">
                        <i data-lucide="type" style="width:16px; opacity:0.5;"></i>
                        <input type="range" class="size-slider" id="font-size-slider" min="14" max="32" value="17"
                            oninput="setReaderFontSize(this.value)">
                        <i data-lucide="type" style="width:24px;"></i>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary btn-full" style="margin-top: 30px;"
                onclick="closeReaderSettings()">Listo</button>
        </div>
    </div>

    <script>
        // --- TEXTAREA AUTO-RESIZE ---
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        // --- LOCAL DATE HELPER ---
        // Fixes timezone bug: toISOString() uses UTC which shifts date in negative-offset timezones
        function localDateStr(d) {
            const date = d || new Date();
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        // --- MODAL UTILS ---
        function closeModalWithAnim(modalId) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const content = modal.querySelector('.modal-sheet') || modal.querySelector('.calendar-card');
            if (content) {
                content.classList.add('closing');
                setTimeout(() => {
                    modal.style.display = 'none';
                    content.classList.remove('closing');
                }, 350);
            } else {
                modal.style.display = 'none';
            }
        }

        // --- TOAST NOTIFICATIONS ---
        function showToast(msg, icon = 'check-circle') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast glass';
            toast.innerHTML = `<i data-lucide="${icon}" style="width:18px; color:var(--primary);"></i> ${msg}`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => toast.remove(), 3500);
        }

        // --- CONGRATS MODAL ---
        function showCongrats(bookName) {
            document.getElementById('congrats-text').innerHTML = `Has completado la lectura del libro de <strong>${bookName}</strong>. ¡Sigue así!`;
            document.getElementById('congrats-modal').style.display = 'flex';
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
        }
        function closeCongratsModal() { closeModalWithAnim('congrats-modal'); }

        // --- CONNECTION STATUS ---
        window.addEventListener('online', () => showToast('¡Estás en línea! Sincronizando...', 'wifi'));
        window.addEventListener('offline', () => showToast('Modo sin conexión activo 📶', 'wifi-off'));

        // --- BIBLE DATA ---
        const BOOKS = [{ id: 1, n: "Génesis", c: 50, nt: false }, { id: 2, n: "Éxodo", c: 40, nt: false }, { id: 3, n: "Levítico", c: 27, nt: false }, { id: 4, n: "Números", c: 36, nt: false }, { id: 5, n: "Deuteronomio", c: 34, nt: false }, { id: 6, n: "Josué", c: 24, nt: false }, { id: 7, n: "Jueces", c: 21, nt: false }, { id: 8, n: "Rut", c: 4, nt: false }, { id: 9, n: "1 Samuel", c: 31, nt: false }, { id: 10, n: "2 Samuel", c: 24, nt: false }, { id: 11, n: "1 Reyes", c: 22, nt: false }, { id: 12, n: "2 Reyes", c: 25, nt: false }, { id: 13, n: "1 Crónicas", c: 29, nt: false }, { id: 14, n: "2 Crónicas", c: 36, nt: false }, { id: 15, n: "Esdras", c: 10, nt: false }, { id: 16, n: "Nehemías", c: 13, nt: false }, { id: 17, n: "Ester", c: 10, nt: false }, { id: 18, n: "Job", c: 42, nt: false }, { id: 19, n: "Salmos", c: 150, nt: false }, { id: 20, n: "Proverbios", c: 31, nt: false }, { id: 21, n: "Eclesiastés", c: 12, nt: false }, { id: 22, n: "Cantares", c: 8, nt: false }, { id: 23, n: "Isaías", c: 66, nt: false }, { id: 24, n: "Jeremías", c: 52, nt: false }, { id: 25, n: "Lamentaciones", c: 5, nt: false }, { id: 26, n: "Ezequiel", c: 48, nt: false }, { id: 27, n: "Daniel", c: 12, nt: false }, { id: 28, n: "Oseas", c: 14, nt: false }, { id: 29, n: "Joel", c: 3, nt: false }, { id: 30, n: "Amós", c: 9, nt: false }, { id: 31, n: "Abdías", c: 1, nt: false }, { id: 32, n: "Jonás", c: 4, nt: false }, { id: 33, n: "Miqueas", c: 7, nt: false }, { id: 34, n: "Nahúm", c: 3, nt: false }, { id: 35, n: "Habacuc", c: 3, nt: false }, { id: 36, n: "Sofonías", c: 3, nt: false }, { id: 37, n: "Hageo", c: 2, nt: false }, { id: 38, n: "Zacarías", c: 14, nt: false }, { id: 39, n: "Malaquías", c: 4, nt: false }, { id: 40, n: "Mateo", c: 28, nt: true }, { id: 41, n: "Marcos", c: 16, nt: true }, { id: 42, n: "Lucas", c: 24, nt: true }, { id: 43, n: "Juan", c: 21, nt: true }, { id: 44, n: "Hechos", c: 28, nt: true }, { id: 45, n: "Romanos", c: 16, nt: true }, { id: 46, n: "1 Corintios", c: 16, nt: true }, { id: 47, n: "2 Corintios", c: 13, nt: true }, { id: 48, n: "Gálatas", c: 6, nt: true }, { id: 49, n: "Efesios", c: 6, nt: true }, { id: 50, n: "Filipenses", c: 4, nt: true }, { id: 51, n: "Colosenses", c: 4, nt: true }, { id: 52, n: "1 Tesalonicenses", c: 5, nt: true }, { id: 53, n: "2 Tesalonicenses", c: 3, nt: true }, { id: 54, n: "1 Timoteo", c: 6, nt: true }, { id: 55, n: "2 Timoteo", c: 4, nt: true }, { id: 56, n: "Tito", c: 3, nt: true }, { id: 57, n: "Filemón", c: 1, nt: true }, { id: 58, n: "Hebreos", c: 13, nt: true }, { id: 59, n: "Santiago", c: 5, nt: true }, { id: 60, n: "1 Pedro", c: 5, nt: true }, { id: 61, n: "2 Pedro", c: 3, nt: true }, { id: 62, n: "1 Juan", c: 5, nt: true }, { id: 63, n: "2 Juan", c: 1, nt: true }, { id: 64, n: "3 Juan", c: 1, nt: true }, { id: 65, n: "Judas", c: 1, nt: true }, { id: 66, n: "Apocalipsis", c: 22, nt: true }];

        const ACHIEVEMENTS = {
            BY_PCT: [
                { id: 'pct_5', pct: 5, name: "Primeros Pasos", desc: "Leer el 5% de la Biblia.", emoji: "👣" },
                { id: 'pct_10', pct: 10, name: "Semilla en Tierra Fértil", desc: "Leer el 10% de la Biblia.", emoji: "🌱" },
                { id: 'pct_20', pct: 20, name: "Explorador del Pacto", desc: "Leer el 20% de la Biblia.", emoji: "🧭" },
                { id: 'pct_25', pct: 25, name: "Primer Cuartel", desc: "Leer el 25% de la Biblia.", emoji: "⚓" },
                { id: 'pct_30', pct: 30, name: "Corazón de Levita", desc: "Leer el 30% de la Biblia.", emoji: "🎻" },
                { id: 'pct_40', pct: 40, name: "Cerca de la Cumbre", desc: "Leer el 40% de la Biblia.", emoji: "🏔️" },
                { id: 'pct_50', pct: 50, name: "A Medio Camino", desc: "Leer el 50% de la Biblia.", emoji: "🌓" },
                { id: 'pct_60', pct: 60, name: "Visión Profética", desc: "Leer el 60% de la Biblia.", emoji: "👁️" },
                { id: 'pct_70', pct: 70, name: "Luz en la Senda", desc: "Leer el 70% de la Biblia.", emoji: "🕯️" },
                { id: 'pct_75', pct: 75, name: "Tres Cuartas Partes", desc: "Leer el 75% de la Biblia.", emoji: "🏁" },
                { id: 'pct_80', pct: 80, name: "Obrero Aprobado", desc: "Leer el 80% de la Biblia.", emoji: "👷" },
                { id: 'pct_90', pct: 90, name: "La Recta Final", desc: "Leer el 90% de la Biblia.", emoji: "🏃" },
                { id: 'pct_95', pct: 95, name: "A las Puertas de Sión", desc: "Leer el 95% de la Biblia.", emoji: "🏰" },
                { id: 'pct_100', pct: 100, name: "Alfa y Omega", desc: "Leer la Biblia completa (100%).", emoji: "👑" },
                { id: 'total_2', count: 2, name: "Doble Porción", desc: "Leer la Biblia completa 2 veces.", emoji: "🌪️" },
                { id: 'total_5', count: 5, name: "Discípulo Constante", desc: "Leer la Biblia completa 5 veces.", emoji: "🛡️" },
                { id: 'total_10', count: 10, name: "Maestro de las Escrituras", desc: "Leer la Biblia completa 10 veces.", emoji: "💎" }
            ],
            BY_BOOKS: [
                { id: 'pentateuco', books: [1, 2, 3, 4, 5], name: "Los Cimientos del Mundo", desc: "Leer el Pentateuco completo (Génesis a Deuteronomio).", emoji: "🗺️" },
                { id: 'historicos', books: [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17], name: "Conquistas y Coronas", desc: "Leer todos los Libros Históricos.", emoji: "⚔️" },
                { id: 'poeticos', books: [18, 19, 20, 21, 22], name: "El Corazón y la Mente", desc: "Leer todos los Libros Poéticos.", emoji: "🖋️" },
                { id: 'salmista', books: [19], name: "Maestro Salmista", desc: "Leer los 150 Salmos.", emoji: "🎵" },
                { id: 'profetas_mayores', books: [23, 24, 25, 26, 27], name: "Los Centinelas de Israel", desc: "Leer todos los Profetas Mayores.", emoji: "✨" },
                { id: 'profetas_menores', books: [28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39], name: "Las Doce Voces", desc: "Leer todos los Profetas Menores.", emoji: "📢" },
                { id: 'evangelios', books: [40, 41, 42, 43], name: "Los Cuatro Testigos", desc: "Leer los cuatro Evangelios.", emoji: "👣" },
                { id: 'hechos', books: [44], name: "La Chispa y el Fuego", desc: "Leer el libro de Hechos.", emoji: "🔥" },
                { id: 'paulinas', books: [45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57], name: "El Caminante Incansable", desc: "Leer todas las Cartas Paulinas.", emoji: "👞" },
                { id: 'pastorales', books: [54, 55, 56, 57], name: "Amigo de Pablo", desc: "Leer las Cartas Pastorales (1 y 2 Timoteo, Tito, Filemón).", emoji: "✉️" },
                { id: 'generales', books: [58, 59, 60, 61, 62, 63, 64, 65], name: "Los Pilares de la Fe", desc: "Leer todas las Epístolas Generales.", emoji: "🏛️" },
                { id: 'apocalipsis', books: [66], name: "El Velo Levantado", desc: "Leer el libro de Apocalipsis.", emoji: "🌌" }
            ]
        };

        // --- GLOBAL STATE ---
        let appState = {
            user: null,
            theme: 'light',
            viewDate: localDateStr(),
            devotionals: {},
            reading: {},
            prayers: [],
            notes: [],
            noteSortMode: 'date',
            readerLocation: { version: 'RV60', book: 43, chapter: 3, scroll: 0 },
            readerSettings: { fontSize: 17, fontFamily: 'sans', theme: 'light' },
            currentTab: 'reader',
            highlights: {},
            unlockedAchievements: [],
            totalCompletions: 0,
            calendar: { currentMonth: new Date().getMonth(), currentYear: new Date().getFullYear(), target: 'devotional', selectedDate: '', mode: 'days' }
        };

        const STORAGE_KEY = 'devocional_pro_v6';

        function switchTab(tabId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const view = document.getElementById(`view-${tabId}`);
            if (view) view.classList.add('active');
            const nav = document.getElementById(`nav-${tabId}`);
            if (nav) nav.classList.add('active');

            // Show/Hide devotional actions
            const devActions = document.querySelector('.devotional-actions');
            if (devActions) devActions.style.display = tabId === 'devotional' ? 'flex' : 'none';

            appState.currentTab = tabId;
            save();

            if (tabId === 'calendar') renderCalendar();
            if (tabId === 'bible') renderBible();
            if (tabId === 'prayers') renderPrayers();
            if (tabId === 'devotional') updateDateUI();
            if (tabId === 'notes') renderNotes();
            if (tabId === 'reader') {
                initReader();
            }
            // Ensure bars are visible when switching tabs
            const bottomNav = document.querySelector('.bottom-nav');
            if (bottomNav) bottomNav.classList.remove('hide-nav');
            const readerHeader = document.querySelector('.reader-header');
            if (readerHeader) readerHeader.classList.remove('hide-header');
            const floatNav = document.querySelector('.reader-nav-float');
            if (floatNav) floatNav.classList.remove('hide-nav');

            window.scrollTo(0, 0);
        }

        // --- INITIALIZATION ---
        function init() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) appState = JSON.parse(data);

            // Set initial tab to reader if none exists or for the very first time
            if (!appState.currentTab) appState.currentTab = 'reader';

            // Ensure new properties exist
            if (!appState.notes) appState.notes = [];
            if (!appState.noteSortMode) appState.noteSortMode = 'date';
            if (!appState.readerLocation) appState.readerLocation = { version: 'RV60', book: 43, chapter: 3, scroll: 0 };
            if (appState.readerLocation.scroll === undefined) appState.readerLocation.scroll = 0;
            if (!appState.readerSettings) appState.readerSettings = { fontSize: 17, fontFamily: 'sans', theme: appState.theme || 'light' };
            if (!appState.highlights) appState.highlights = {};
            if (!appState.unlockedAchievements) appState.unlockedAchievements = [];
            if (!appState.totalCompletions) appState.totalCompletions = 0;

            if (!appState.user) {
                document.getElementById('onboarding-overlay').style.display = 'flex';
            } else {
                renderProfile();
            }

            setTheme(appState.theme);
            updateDateUI();
            renderBible();
            renderPrayers();
            initReader();

            // Check for progress-based achievements on startup
            checkAchievements();

            // Set initial view
            switchTab(appState.currentTab);

            // Reader scroll persistence and auto-hide bars (Uses window scroll)
            let lastScroll = 0;
            window.addEventListener('scroll', () => {
                if (appState.currentTab !== 'reader') return;

                const currentScroll = window.scrollY;
                appState.readerLocation.scroll = currentScroll;

                const bottomNav = document.querySelector('.bottom-nav');
                const readerHeader = document.querySelector('.reader-header');
                const floatNav = document.querySelector('.reader-nav-float');

                // Auto-hide bars logic (Like YouVersion)
                if (currentScroll > lastScroll && currentScroll > 80) {
                    // Scrolling down - Hide
                    if (bottomNav) bottomNav.classList.add('hide-nav');
                    if (readerHeader) readerHeader.classList.add('hide-header');
                    if (floatNav) floatNav.classList.add('hide-nav');
                } else if (currentScroll < lastScroll || currentScroll <= 20) {
                    // Scrolling up - Show
                    if (bottomNav) bottomNav.classList.remove('hide-nav');
                    if (readerHeader) readerHeader.classList.remove('hide-header');
                    if (floatNav) floatNav.classList.remove('hide-nav');
                }
                lastScroll = currentScroll;

                // Show bars when at bottom
                const isAtBottom = (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 20;
                if (isAtBottom) {
                    if (bottomNav) bottomNav.classList.remove('hide-nav');
                    if (readerHeader) readerHeader.classList.remove('hide-header');
                    if (floatNav) floatNav.classList.remove('hide-nav');
                }
            }, { passive: true });

            // Periodic save for scroll position
            setInterval(() => {
                if (document.getElementById('view-reader').classList.contains('active')) save();
            }, 5000);

            lucide.createIcons();
        }

        function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }

        // --- BACKUP & SHARING ---
        function exportBackup() {
            const data = JSON.stringify(appState, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `respaldo_devocional_${localDateStr()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("Respaldo exportado correctamente", "download");
        }

        function importBackup(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.user && data.devotionals) {
                        appState = data;
                        save();
                        window.location.reload();
                    } else {
                        showToast("Archivo de respaldo no válido", "alert-triangle");
                    }
                } catch (err) {
                    showToast("Error al leer el archivo", "alert-triangle");
                }
            };
            reader.readAsText(file);
        }

        async function shareDevotional() {
            const d = appState.devotionals[appState.viewDate];
            if (!d || (!d.book && !d.o && !d.i && !d.a && !d.p)) {
                showToast("No hay contenido para compartir hoy", "info");
                return;
            }

            const dateStr = new Date(appState.viewDate + "T12:00:00").toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
            let text = `📖 *Bible Note*\n📅 ${dateStr}\n\n`;

            if (d.book) text += `📍 *Pasaje:* ${d.book} ${d.ch}:${d.vs}\n\n`;
            if (d.o) text += `👁️ *Observación:*\n${d.o}\n\n`;
            if (d.i) text += `🔍 *Interpretación:*\n${d.i}\n\n`;
            if (d.a) text += `❤️ *Aplicación:*\n${d.a}\n\n`;
            if (d.p) text += `🙏 *Oración:*\n${d.p}\n\n`;

            text += `Hecho con *Bible Note* ✨`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Bible Note',
                        text: text
                    });
                } catch (err) { }
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    showToast("Copiado al portapapeles para compartir", "clipboard");
                });
            }
        }

        // --- BIBLE NOTES LOGIC ---
        function renderNotes() {
            const list = document.getElementById('notes-list');
            if (!list) return;
            list.innerHTML = '';

            let sorted = [...appState.notes];
            if (appState.noteSortMode === 'date') {
                sorted.sort((a, b) => b.id - a.id);
            } else if (appState.noteSortMode === 'bible') {
                sorted.sort((a, b) => {
                    if (a.bookId !== b.bookId) return a.bookId - b.bookId;
                    if (a.chapter !== b.chapter) return a.chapter - b.chapter;
                    return a.vStart - b.vStart;
                });
            }

            sorted.forEach(n => {
                const card = document.createElement('div');
                card.className = 'note-tile';
                card.id = `note-${n.id}`;
                const dateStr = new Date(n.id).toLocaleDateString();
                const vsText = n.vEnd ? `${n.vStart}-${n.vEnd}` : n.vStart;
                card.innerHTML = `
                    <div class="note-header">
                        <div onclick="toggleNoteExpansion(${n.id})" style="flex:1;">
                            <h3>
                                <i data-lucide="bookmark" style="width:18px;"></i> 
                                <span style="font-size: 16px; font-weight: 900; letter-spacing: 0.5px;">${n.book.toUpperCase()} ${n.chapter}:${vsText}</span>
                            </h3>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-icon" onclick="editNoteInModal(${n.id})"><i data-lucide="edit-3" style="width:16px;"></i></button>
                            <button class="btn-icon" onclick="deleteNote(${n.id})" style="color: #ff9f9f;"><i data-lucide="trash-2" style="width:16px;"></i></button>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div class="note-date">${dateStr}</div>
                        ${n.version ? `<span class="tag" style="font-size: 10px; opacity: 0.7;">${n.version}</span>` : ''}
                    </div>
                    <div class="note-body" onclick="toggleNoteExpansion(${n.id})">
                        ${n.vText ? `<div style="font-weight: 700; font-size: 12px; margin-top: 4px; color: var(--primary);">${n.book} ${n.chapter}:${vsText}</div><div class="note-verse-text">"${n.vText}"</div>` : ''}
                        <div style="margin-top: 4px;">
                            <div style="font-weight: 800; font-size: 10px; text-transform: uppercase; color: var(--text-muted); opacity: 0.7;">Nota:</div>
                            <div class="note-text-content">${n.note}</div>
                        </div>
                    </div>`;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        function toggleNoteExpansion(id) {
            const el = document.getElementById(`note-${id}`);
            el.classList.toggle('expanded');
        }

        let editingNoteFromModalId = null;
        function editNoteInModal(id) {
            const n = appState.notes.find(x => x.id === id);
            if (!n) return;
            editingNoteFromModalId = id;

            document.getElementById('reader-note-title').textContent = `Editar Nota: ${n.book} ${n.chapter}:${n.vStart} `;
            document.getElementById('reader-note-input').value = n.note;
            document.getElementById('reader-note-modal').style.display = 'flex';
            autoResize(document.getElementById('reader-note-input'));
            lucide.createIcons();
        }
        function setNoteSort(mode) {
            appState.noteSortMode = mode;
            const btnDate = document.getElementById('sort-date');
            const btnBible = document.getElementById('sort-bible');
            if (btnDate) btnDate.classList.toggle('active', mode === 'date');
            if (btnBible) btnBible.classList.toggle('active', mode === 'bible');
            save(); renderNotes();
        }

        function addNote() {
            const noteText = document.getElementById('note-input').value.trim();
            if (!noteText || !bibleSelection.book || !bibleSelection.chapter) {
                showToast("Falta pasaje o nota", "alert-circle");
                return;
            }

            if (editingNoteId) {
                const n = appState.notes.find(x => x.id === editingNoteId);
                n.book = bibleSelection.book;
                const bookObj = BOOKS.find(b => b.n === bibleSelection.book);
                n.bookId = bookObj.id;
                n.chapter = bibleSelection.chapter;
                n.vStart = bibleSelection.vStart;
                n.vEnd = bibleSelection.vEnd;
                n.note = noteText;
                editingNoteId = null;
                showToast("Nota actualizada", "check");
                document.getElementById('btn-save-note').innerHTML = '<i data-lucide="plus"></i> Guardar Nota';
                document.getElementById('btn-cancel-note').style.display = 'none';
            } else {
                const bookObj = BOOKS.find(b => b.n === bibleSelection.book);
                const newNote = {
                    id: Date.now(),
                    book: bibleSelection.book,
                    bookId: bookObj.id,
                    chapter: bibleSelection.chapter,
                    vStart: bibleSelection.vStart,
                    vEnd: bibleSelection.vEnd,
                    note: noteText
                };
                appState.notes.push(newNote);
                showToast("Nota guardada", "check");
            }

            save(); renderNotes();

            // Limpiar formulario
            document.getElementById('note-input').value = '';
            document.getElementById('note-input').style.height = 'auto';
            bibleSelection = { book: '', chapter: 0, vStart: 0, vEnd: 0 };
            updateBibleCards();
        }

        function openNoteModal() {
            // Reset form before opening
            bibleSelection = { book: '', chapter: 0, vStart: 0, vEnd: 0 };
            updateBibleCards();
            const ta = document.getElementById('note-input');
            if (ta) { ta.value = ''; ta.style.height = 'auto'; }
            document.getElementById('note-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeNoteModal() { closeModalWithAnim('note-modal'); }

        function deleteNote(id) {
            const modal = document.getElementById('confirm-modal');
            const btn = document.getElementById('btn-confirm-delete');
            document.querySelector('#confirm-modal h3').textContent = '¿Eliminar Nota?';
            document.querySelector('#confirm-modal p').textContent = 'Esta acción no se puede deshacer. La nota será borrada permanentemente.';
            modal.style.display = 'flex';
            btn.onclick = () => {
                appState.notes = appState.notes.filter(n => n.id !== id);
                save();
                renderNotes();
                closeConfirmModal();
                showToast('Nota eliminada', 'trash-2');
            };
        }

        // --- THEME ---
        function setTheme(theme) {
            appState.theme = theme;
            document.body.setAttribute('data-theme', theme);
            document.documentElement.setAttribute('data-theme', theme);

            // Sincronizar barras del sistema (Status bar y Nav bar)
            const metaTheme = document.getElementById('meta-theme-color');
            let themeColor = '#F8F9FD'; // light
            if (theme === 'dark') themeColor = '#2D294D';
            if (theme === 'gray') themeColor = '#E5E5E5';

            if (metaTheme) metaTheme.setAttribute('content', themeColor);

            // Aplicar color-scheme para que el navegador adapte elementos UI
            document.documentElement.style.colorScheme = theme === 'dark' ? 'dark' : 'light';

            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.setAttribute('data-lucide', theme === 'dark' ? 'sun' : 'moon');
                lucide.createIcons();
            }

            // Actualizar botones de selección en el modal de ajustes si existe
            document.querySelectorAll('.theme-opt').forEach(opt => opt.classList.remove('active'));
            const opt = document.getElementById(`theme-${theme}`);
            if (opt) opt.classList.add('active');

            save();
        }
        document.getElementById('theme-toggle').onclick = () => setTheme(appState.theme === 'light' ? 'dark' : 'light');

        // --- CALENDAR / SELECTOR PICKER LOGIC ---
        function openCalendarPicker(target) {
            appState.calendar.target = target;
            document.getElementById('calendar-overlay').style.display = 'flex';

            if (target === 'birth' || target === 'birthProfile') {
                document.getElementById('calendar-ui-group').style.display = 'none';
                document.getElementById('birth-ui-group').style.display = 'block';
                document.querySelector('.birth-selectors-grid').style.display = 'grid';
                document.getElementById('selector-modal-title').textContent = 'Fecha de Nacimiento';
                populateBirthSelectors();
            } else {
                document.getElementById('calendar-ui-group').style.display = 'block';
                document.getElementById('birth-ui-group').style.display = 'none';
                document.querySelector('.birth-selectors-grid').style.display = 'none';
                document.getElementById('selector-modal-title').textContent = 'Seleccionar Día';

                let initialDate = new Date(appState.viewDate + "T12:00:00");
                appState.calendar.currentMonth = initialDate.getMonth();
                appState.calendar.currentYear = initialDate.getFullYear();
                appState.calendar.mode = 'days';
                renderCalendar();
            }
        }

        function populateBirthSelectors() {
            const selDay = document.getElementById('sel-day');
            const selYear = document.getElementById('sel-year');
            const selMonth = document.getElementById('sel-month');

            selDay.innerHTML = '';
            for (let i = 1; i <= 31; i++) {
                const o = document.createElement('option'); o.value = i; o.textContent = i;
                selDay.appendChild(o);
            }

            selYear.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= currentYear - 100; i--) {
                const o = document.createElement('option'); o.value = i; o.textContent = i;
                selYear.appendChild(o);
            }

            // Set current known date if exists
            if (appState.user && appState.user.birth) {
                const d = new Date(appState.user.birth + "T12:00:00");
                selDay.value = d.getDate();
                selMonth.value = d.getMonth();
                selYear.value = d.getFullYear();
            }
        }

        function confirmBirthDate() {
            const d = document.getElementById('sel-day').value;
            const m = parseInt(document.getElementById('sel-month').value) + 1;
            const y = document.getElementById('sel-year').value;
            const dateStr = `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

            selectCalendarDate(dateStr);
        }

        function closeCalendarPicker() { closeModalWithAnim('calendar-overlay'); }

        function navCalendar(offset) {
            if (appState.calendar.mode === 'years') {
                appState.calendar.currentYear += offset * 12;
            } else {
                appState.calendar.currentMonth += offset;
                if (appState.calendar.currentMonth < 0) { appState.calendar.currentMonth = 11; appState.calendar.currentYear--; }
                if (appState.calendar.currentMonth > 11) { appState.calendar.currentMonth = 0; appState.calendar.currentYear++; }
            }
            renderCalendar();
        }

        function toggleYearMode() {
            appState.calendar.mode = appState.calendar.mode === 'years' ? 'days' : 'years';
            renderCalendar();
        }

        function selectYear(y) {
            appState.calendar.currentYear = y;
            appState.calendar.mode = 'days';
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-days');
            const titleText = document.getElementById('calendar-title-text');
            const weekDays = document.querySelector('.calendar-weekdays');
            grid.innerHTML = '';

            if (appState.calendar.mode === 'years') {
                weekDays.style.display = 'none';
                const startYear = appState.calendar.currentYear - 6;
                titleText.textContent = `${startYear} - ${startYear + 11} `;
                grid.style.gridTemplateColumns = 'repeat(3, 1fr)';

                for (let i = 0; i < 12; i++) {
                    const y = startYear + i;
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    dayDiv.style.height = '60px';
                    dayDiv.textContent = y;
                    if (y === appState.calendar.currentYear) dayDiv.classList.add('selected');
                    dayDiv.onclick = () => selectYear(y);
                    grid.appendChild(dayDiv);
                }
            } else {
                weekDays.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                titleText.textContent = `${monthNames[appState.calendar.currentMonth]} ${appState.calendar.currentYear} `;

                const firstDay = new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 1).getDay();
                const daysInMonth = new Date(appState.calendar.currentYear, appState.calendar.currentMonth + 1, 0).getDate();
                const prevDaysInMonth = new Date(appState.calendar.currentYear, appState.calendar.currentMonth, 0).getDate();
                const todayStr = localDateStr();

                for (let i = firstDay; i > 0; i--) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day prev-month';
                    dayDiv.textContent = prevDaysInMonth - i + 1;
                    grid.appendChild(dayDiv);
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const dayDiv = document.createElement('div');
                    const dateFull = `${appState.calendar.currentYear}-${String(appState.calendar.currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    dayDiv.className = 'calendar-day';
                    dayDiv.textContent = i;
                    if (dateFull === todayStr) dayDiv.classList.add('today');
                    if (appState.calendar.target === 'devotional' && dateFull > todayStr) {
                        dayDiv.classList.add('disabled');
                    } else {
                        dayDiv.onclick = () => selectCalendarDate(dateFull);
                    }
                    if (appState.calendar.target === 'devotional') {
                        if (appState.viewDate === dateFull) dayDiv.classList.add('selected');
                        if (appState.devotionals[dateFull]) {
                            const dev = appState.devotionals[dateFull];
                            if (dev.o || dev.i || dev.a || dev.p) dayDiv.classList.add('has-content');
                        }
                    } else {
                        if (appState.user && appState.user.birth === dateFull) dayDiv.classList.add('selected');
                    }
                    grid.appendChild(dayDiv);
                }
            }
            lucide.createIcons();
        }

        function selectCalendarDate(date) {
            if (appState.calendar.target === 'devotional') {
                appState.viewDate = date;
                updateDateUI();
            } else if (appState.calendar.target === 'birth') {
                appState.user = appState.user || {};
                appState.user.birth = date;
                document.getElementById('reg-birth-display').textContent = date;
            } else if (appState.calendar.target === 'birthProfile') {
                appState.user.birth = date;
                document.getElementById('profile-birth-display').textContent = date;
            }
            closeCalendarPicker();
        }

        // --- ONBOARDING & PROFILE ---
        let cameraTarget = ''; // 'reg' or 'profile'
        let stream = null;

        function openCameraUI(target) {
            cameraTarget = target;
            document.getElementById('camera-modal').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
                .then(s => {
                    stream = s;
                    document.getElementById('camera-stream').srcObject = s;
                })
                .catch(err => {
                    alert('No se pudo acceder a la cámara. Revisa los permisos. 📷');
                    closeCameraUI();
                });
            lucide.createIcons();
        }

        function closeCameraUI() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            closeModalWithAnim('camera-modal');
        }

        function capturePhoto() {
            const video = document.getElementById('camera-stream');
            const canvas = document.getElementById('camera-canvas');
            const context = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            const dataUrl = canvas.toDataURL('image/jpeg');
            if (cameraTarget === 'reg') {
                const img = document.getElementById('reg-photo-preview');
                img.src = dataUrl;
                img.style.display = 'block';
                document.getElementById('reg-photo-icon').style.display = 'none';
            } else if (cameraTarget === 'profile') {
                appState.user.photo = dataUrl;
                renderProfile();
            }

            closeCameraUI();
        }

        function finishOnboarding() {
            const name = document.getElementById('reg-name').value;
            const bD = document.getElementById('reg-birth-display').textContent;
            const photo = document.getElementById('reg-photo-preview').src;
            if (!name || bD === 'Seleccionar fecha') { alert("Por favor completa tu nombre y fecha."); return; }
            appState.user = { name, birth: bD, photo: photo.startsWith('data:') ? photo : null };
            save(); document.getElementById('onboarding-overlay').style.display = 'none';
            renderProfile();
        }

        function handleRegPhoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById('reg-photo-preview');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    document.getElementById('reg-photo-icon').style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderProfile() {
            document.getElementById('user-greeting').textContent = `Hola, ${appState.user.name} `;
            document.getElementById('profile-name').value = appState.user.name;
            document.getElementById('profile-birth-display').textContent = appState.user.birth || 'Seleccionar';

            const avatar = document.getElementById('header-avatar');
            const preview = document.getElementById('photo-preview');
            if (appState.user.photo) {
                const img = `<img src="${appState.user.photo}">`;
                avatar.innerHTML = img; preview.innerHTML = img;
            } else {
                avatar.innerHTML = '<i data-lucide="user"></i>';
                preview.innerHTML = '<i data-lucide="camera" style="width:30px; opacity:0.5;"></i>';
                lucide.createIcons();
            }
        }

        function previewPhoto(input) {
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { appState.user.photo = e.target.result; renderProfile(); };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateProfile() {
            appState.user.name = document.getElementById('profile-name').value;
            save(); renderProfile();
            showToast('Perfil actualizado ✨');
            switchTab('devotional');
        }





        // --- DEVOTIONAL BIBLE SELECTOR LOGIC ---
        let bibleSelection = { book: '', chapter: 0, vStart: 0, vEnd: 0 };
        let isEditLocked = false;

        function openBibleModal(type) {
            const isNotesView = document.getElementById('view-notes').classList.contains('active');
            if (isEditLocked && !isNotesView) return;
            if (type === 'chapter' && !bibleSelection.book) return;
            if (type === 'verse' && (!bibleSelection.book || !bibleSelection.chapter)) return;

            const modal = document.getElementById('bible-modal');
            const content = document.getElementById('bible-modal-content');
            const title = document.getElementById('bible-modal-title');
            content.innerHTML = '';
            modal.style.display = 'flex';

            if (type === 'book') {
                title.textContent = 'Seleccionar Libro';
                BOOKS.forEach(b => {
                    const btn = document.createElement('div');
                    btn.className = 'book-item';
                    btn.style.cursor = 'pointer';
                    btn.innerHTML = `<div class="book-header"><strong>${b.n}</strong><span style="font-size:11px; opacity:0.6;">${b.c} caps</span></div>`;
                    btn.onclick = () => selectBibleBook(b);
                    content.appendChild(btn);
                });
            } else if (type === 'chapter') {
                title.textContent = 'Seleccionar Capítulo';
                const book = BOOKS.find(b => b.n === bibleSelection.book);
                const grid = document.createElement('div');
                grid.className = 'chapter-pill-grid';
                grid.style.display = 'grid';
                for (let i = 1; i <= book.c; i++) {
                    const pill = document.createElement('div');
                    pill.className = 'chapter-pill';
                    pill.textContent = i;
                    if (i === bibleSelection.chapter) pill.classList.add('read');
                    pill.onclick = () => selectBibleChapter(i);
                    grid.appendChild(pill);
                }
                content.appendChild(grid);
            } else if (type === 'verse') {
                title.textContent = 'Seleccionar Versículos';
                const grid = document.createElement('div');
                grid.className = 'verse-pill-grid';
                // Most chapters don't exceed 100 verses, showing a safe range.
                for (let i = 1; i <= 100; i++) {
                    const pill = document.createElement('div');
                    pill.className = 'verse-pill';
                    pill.textContent = i;
                    updateVersePillClass(pill, i);
                    pill.onclick = () => selectBibleVerse(i, pill);
                    grid.appendChild(pill);
                }
                content.appendChild(grid);
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn btn-primary btn-full';
                confirmBtn.style.marginTop = '20px';
                confirmBtn.textContent = 'Confirmar Versículos';
                confirmBtn.onclick = () => { closeBibleModal(); updateBibleCards(); };
                content.appendChild(confirmBtn);
            }
            lucide.createIcons();
        }

        function closeBibleModal() { closeModalWithAnim('bible-modal'); }

        function selectBibleBook(book) {
            bibleSelection.book = book.n;
            bibleSelection.chapter = 0;
            bibleSelection.vStart = 0;
            bibleSelection.vEnd = 0;
            updateBibleCards();
            closeBibleModal();
            openBibleModal('chapter');
        }

        function selectBibleChapter(ch) {
            bibleSelection.chapter = ch;
            bibleSelection.vStart = 0;
            bibleSelection.vEnd = 0;
            updateBibleCards();
            closeBibleModal();
            openBibleModal('verse');
        }

        function selectBibleVerse(v, el) {
            if (bibleSelection.vStart === 0 || (bibleSelection.vStart !== 0 && bibleSelection.vEnd !== 0)) {
                bibleSelection.vStart = v;
                bibleSelection.vEnd = 0;
            } else {
                if (v < bibleSelection.vStart) {
                    bibleSelection.vEnd = bibleSelection.vStart;
                    bibleSelection.vStart = v;
                } else {
                    bibleSelection.vEnd = v;
                }
            }
            // Refresh pills highlight
            document.querySelectorAll('.verse-pill').forEach((p, idx) => {
                const vn = idx + 1;
                p.className = 'verse-pill';
                updateVersePillClass(p, vn);
            });
        }

        function updateVersePillClass(p, v) {
            if (v === bibleSelection.vStart || v === bibleSelection.vEnd) p.classList.add('selected');
            else if (bibleSelection.vEnd !== 0 && v > bibleSelection.vStart && v < bibleSelection.vEnd) p.classList.add('in-range');
        }

        function updateBibleCards() {
            // Update Devotional section
            const bookText = document.getElementById('card-book-text');
            const capCard = document.getElementById('card-chapter');
            const capText = document.getElementById('card-chapter-text');
            const vsCard = document.getElementById('card-verse');
            const vsText = document.getElementById('card-verse-text');

            // Update Notes section
            const bookTextN = document.getElementById('card-book-text-notes');
            const capCardN = document.getElementById('card-chapter-notes');
            const capTextN = document.getElementById('card-chapter-text-notes');
            const vsCardN = document.getElementById('card-verse-notes');
            const vsTextN = document.getElementById('card-verse-text-notes');

            const vsShort = bibleSelection.vStart > 0 ? (bibleSelection.vEnd > 0 ? `${bibleSelection.vStart} -${bibleSelection.vEnd} ` : `${bibleSelection.vStart} `) : 'Vs';
            const vsLong = bibleSelection.vStart > 0 ? (bibleSelection.vEnd > 0 ? `Vrs ${bibleSelection.vStart} -${bibleSelection.vEnd} ` : `Versículo ${bibleSelection.vStart} `) : 'Versículos';

            // Devotional UI
            if (bookText) bookText.textContent = bibleSelection.book || 'Seleccionar Libro';
            if (capCard) {
                if (bibleSelection.book) {
                    capCard.classList.remove('disabled');
                    capText.textContent = bibleSelection.chapter ? `Capítulo ${bibleSelection.chapter} ` : 'Capítulo';
                } else {
                    capCard.classList.add('disabled');
                    capText.textContent = 'Capítulo';
                }
            }
            if (vsCard) {
                if (bibleSelection.chapter > 0) {
                    vsCard.classList.remove('disabled');
                    vsText.textContent = vsLong;
                } else {
                    vsCard.classList.add('disabled');
                    vsText.textContent = 'Versículos';
                }
            }

            // Notes UI
            if (bookTextN) bookTextN.textContent = bibleSelection.book || 'Libro';
            if (capCardN) {
                if (bibleSelection.book) {
                    capCardN.classList.remove('disabled');
                    capTextN.textContent = bibleSelection.chapter ? `Cap ${bibleSelection.chapter} ` : 'Cap';
                } else {
                    capCardN.classList.add('disabled');
                    capTextN.textContent = 'Cap';
                }
            }
            if (vsCardN) {
                if (bibleSelection.chapter > 0) {
                    vsCardN.classList.remove('disabled');
                    vsTextN.textContent = vsShort;
                } else {
                    vsCardN.classList.add('disabled');
                    vsTextN.textContent = 'Vs';
                }
            }

            validateDevotionalForm();
            lucide.createIcons();
        }

        function changeDate(offset) {
            const d = new Date(appState.viewDate + "T12:00:00");
            d.setDate(d.getDate() + offset);
            const str = localDateStr(d);
            const today = localDateStr();
            if (str > today) return;
            appState.viewDate = str; updateDateUI();
        }

        function updateDateUI() {
            const d = new Date(appState.viewDate + "T12:00:00");
            const options = { weekday: 'long', day: 'numeric', month: 'long' };
            const today = localDateStr();
            document.getElementById('header-date').textContent = new Date(localDateStr() + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
            document.getElementById('date-display-trigger').textContent = d.toLocaleDateString('es-ES', options);
            document.getElementById('next-date-btn').disabled = appState.viewDate === today;

            const entry = appState.devotionals[appState.viewDate] || { book: '', ch: '', vs: '', o: '', i: '', a: '', p: '' };

            // Sync with new selection system
            bibleSelection.book = entry.book || '';
            bibleSelection.chapter = parseInt(entry.ch) || 0;
            if (entry.vs) {
                const parts = entry.vs.split('-');
                bibleSelection.vStart = parseInt(parts[0]) || 0;
                bibleSelection.vEnd = parts[1] ? parseInt(parts[1]) : 0;
            } else {
                bibleSelection.vStart = 0; bibleSelection.vEnd = 0;
            }
            updateBibleCards();

            document.getElementById('dev-o').value = entry.o || '';
            document.getElementById('dev-i').value = entry.i || '';
            document.getElementById('dev-a').value = entry.a || '';
            document.getElementById('dev-p').value = entry.p || '';

            // Auto-resize after loading content
            ['dev-o', 'dev-i', 'dev-a', 'dev-p'].forEach(id => autoResize(document.getElementById(id)));

            // Lock logic for old entries
            const hasContent = entry.book || entry.o || entry.i || entry.a || entry.p;
            const isPast = appState.viewDate < today;

            if (isPast && hasContent) {
                setEditLock(true);
            } else {
                setEditLock(false);
            }

            if (!isEditLocked) {
                const fab = document.getElementById('save-fab');
                fab.className = 'fab-saved';
                document.getElementById('save-fab-icon').setAttribute('data-lucide', 'check');
                validateDevotionalForm();
            }
            lucide.createIcons();
        }

        function setEditLock(locked) {
            isEditLocked = locked;
            const view = document.getElementById('view-devotional');
            const saveBtn = document.getElementById('save-fab');
            const shareBtn = document.getElementById('share-fab');
            const saveIcon = document.getElementById('save-fab-icon');
            const saveText = document.getElementById('save-text');

            if (locked) {
                view.classList.add('view-locked');
                saveBtn.className = 'fab-locked';
                saveBtn.disabled = false;
                saveIcon.setAttribute('data-lucide', 'lock');
                if (saveText) saveText.textContent = 'Bloqueado';
                shareBtn.style.display = 'flex'; // Always show share when locked
            } else {
                view.classList.remove('view-locked');
                saveBtn.className = 'fab-unsaved';
                saveIcon.setAttribute('data-lucide', 'save');
                if (saveText) saveText.textContent = 'Guardar';
                shareBtn.style.display = 'flex'; // Always show share when unlocked
                validateDevotionalForm();
            }
            lucide.createIcons();
        }

        function toggleEdit() {
            setEditLock(!isEditLocked);
        }

        function markUnsaved() {
            const fab = document.getElementById('save-fab');
            const icon = document.getElementById('save-fab-icon');
            const text = document.getElementById('save-text');
            fab.className = 'fab-unsaved';
            icon.setAttribute('data-lucide', 'save');
            if (text) text.textContent = 'Guardar';
            lucide.createIcons();
        }

        function validateDevotionalForm() {
            const fab = document.getElementById('save-fab');
            if (!fab) return;
            const isBibleComplete = bibleSelection.book && bibleSelection.chapter > 0 && bibleSelection.vStart > 0;
            const isOIAComplete = document.getElementById('dev-o').value.trim() !== '' &&
                document.getElementById('dev-i').value.trim() !== '' &&
                document.getElementById('dev-a').value.trim() !== '' &&
                document.getElementById('dev-p').value.trim() !== '';

            if (isBibleComplete && isOIAComplete) {
                fab.classList.remove('fab-disabled');
                fab.disabled = false;
            } else {
                fab.classList.add('fab-disabled');
                fab.disabled = true;
            }
        }

        function saveDevotional() {
            if (isEditLocked) {
                toggleEdit();
                return;
            }

            const isBibleComplete = bibleSelection.book && bibleSelection.chapter > 0 && bibleSelection.vStart > 0;
            const isOIAComplete = document.getElementById('dev-o').value.trim() !== '' &&
                document.getElementById('dev-i').value.trim() !== '' &&
                document.getElementById('dev-a').value.trim() !== '' &&
                document.getElementById('dev-p').value.trim() !== '';

            if (!isBibleComplete || !isOIAComplete) {
                alert("Por favor, completa todos los campos antes de guardar. 🙏");
                return;
            }

            const vsStr = bibleSelection.vStart > 0 ? (bibleSelection.vEnd > 0 ? `${bibleSelection.vStart} -${bibleSelection.vEnd} ` : `${bibleSelection.vStart} `) : '';
            appState.devotionals[appState.viewDate] = {
                book: bibleSelection.book,
                ch: bibleSelection.chapter,
                vs: vsStr,
                o: document.getElementById('dev-o').value,
                i: document.getElementById('dev-i').value,
                a: document.getElementById('dev-a').value,
                p: document.getElementById('dev-p').value
            };
            save(); updateDateUI();
            if (navigator.vibrate) navigator.vibrate(40);
        }

        // --- BIBLE LOGIC ---
        function renderBible() {
            const ot = document.getElementById('ot-container');
            const nt = document.getElementById('nt-container');
            ot.innerHTML = ''; nt.innerHTML = '';
            let totalRead = 0; const totalChapters = 1189;
            BOOKS.forEach(b => {
                const read = appState.reading[b.id] || [];
                totalRead += read.length;
                const pct = Math.round((read.length / b.c) * 100);
                const card = document.createElement('div');
                card.className = `book-item ${pct === 100 ? 'completed' : pct > 0 ? 'started' : ''}`;
                card.innerHTML = `
                    <div class="book-header" onclick="toggleChapters(${b.id})">
                        <div>
                            <strong style="font-size: 16px;">${b.n}</strong>
                            <div style="font-size: 11px; color: var(--text-muted);">${read.length} / ${b.c} capítulos</div>
                        </div>
                        <span class="tag" style="background: ${pct === 100 ? 'var(--success)' : pct > 0 ? 'var(--secondary)' : 'var(--border)'}">${pct}%</span>
                    </div>
                    <div id="ch-grid-${b.id}" class="chapter-pill-grid">
                        <div class="complete-book-row">
                            <span>Marcar libro como leído</span>
                            <input type="checkbox" ${pct === 100 ? 'checked' : ''} onchange="markWholeBook(${b.id}, this.checked)">
                        </div>
                        ${Array.from({ length: b.c }, (_, i) => { const cn = i + 1; const isR = read.includes(cn); return `<div class="chapter-pill ${isR ? 'read' : ''}" onclick="toggleCh(${b.id}, ${cn})">${cn}</div>`; }).join('')}
                    </div>
                `; (b.nt ? nt : ot).appendChild(card);
            });
            const globPct = Math.round((totalRead / totalChapters) * 100);
            document.getElementById('total-pct').textContent = globPct;

            // Update Gauge
            const dashArray = 251.32; // PI * 80
            const offset = dashArray - (globPct / 100) * dashArray;
            const bar = document.getElementById('total-progress-bar');
            if (bar) bar.style.strokeDashoffset = offset;
        }
        function toggleChapters(id) {
            const el = document.getElementById(`ch-grid-${id}`);
            const visible = el.style.display === 'grid';
            document.querySelectorAll('.chapter-pill-grid').forEach(g => g.style.display = 'none');
            el.style.display = visible ? 'none' : 'grid';
        }
        function toggleCh(bid, c) {
            if (!appState.reading[bid]) appState.reading[bid] = [];
            const idx = appState.reading[bid].indexOf(c);
            const book = BOOKS.find(b => b.id === bid);
            const wasCompleted = appState.reading[bid].length === book.c;

            if (idx > -1) appState.reading[bid].splice(idx, 1);
            else appState.reading[bid].push(c);

            save(); renderBible();
            const gridEl = document.getElementById(`ch-grid-${bid}`);
            if (gridEl) gridEl.style.display = 'grid';

            if (!wasCompleted && appState.reading[bid].length === book.c) {
                showCongrats(book.n);
            }
            checkAchievements();
        }
        function markWholeBook(bid, check) {
            const b = BOOKS.find(x => x.id === bid);
            const wasCompleted = (appState.reading[bid] || []).length === b.c;
            appState.reading[bid] = check ? Array.from({ length: b.c }, (_, i) => i + 1) : [];
            save(); renderBible();
            const gridEl = document.getElementById(`ch-grid-${bid}`);
            if (gridEl) gridEl.style.display = 'grid';

            if (!wasCompleted && check) {
                showCongrats(b.n);
            }
            checkAchievements();
        }



        // --- BIBLE READER LOGIC ---
        let bibleLibrary = {};
        let readerSQL = null;
        let isReaderLoading = false;

        function cleanReaderText(text, versionType) {
            if (!text) return "";
            let clean = String(text);

            // Reemplazar códigos de acentos RTF antes de quitar etiquetas
            clean = clean.replace(/\\'e1/g, "á").replace(/\\'e9/g, "é").replace(/\\'ed/g, "í")
                .replace(/\\'f3/g, "ó").replace(/\\'fa/g, "ú").replace(/\\'f1/g, "ñ")
                .replace(/\\'d1/g, "Ñ").replace(/\\'c1/g, "Á").replace(/\\'c9/g, "É")
                .replace(/\\'cd/g, "Í").replace(/\\'d3/g, "Ó").replace(/\\'da/g, "Ú");

            if (versionType === "RV60" || versionType === "NVI" || clean.includes('\\')) {
                // Quitar llaves pero mantener el contenido
                clean = clean.replace(/\{|\}/g, "");
                // Quitar etiquetas tipo \par o \f1, pero sin comerse letras siguientes
                // El regex busca \ seguido de letras y opcionalmente números, y un espacio opcional
                clean = clean.replace(/\\[a-z]+[0-9]* ?/g, "");
            }

            // Limpieza general
            clean = clean.replace(/<[^>]*>/g, ""); // HTML
            clean = clean.replace(/\([A-Z0-9]\)/g, "").replace(/\[[A-Z0-9]\]/g, ""); // Referencias

            return clean.replace(/\s+/g, ' ').trim();
        }

        async function initReader() {
            // Sync the header version tag immediately from saved state (before async load)
            const savedVersion = appState.readerLocation.version;
            const tag = document.getElementById('reader-current-version-tag');
            if (tag && savedVersion) tag.textContent = savedVersion;

            if (Object.keys(bibleLibrary).length > 0) {
                renderReaderVersions();
                renderReaderContent();
                return;
            }
            if (isReaderLoading) return;
            isReaderLoading = true;

            document.getElementById('reader-loading').style.display = 'block';

            try {
                const config = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` };
                readerSQL = await initSqlJs(config);

                // Sequential loading with retries for better stability
                await loadBibleFile('biblias/RV60.json', 'json', 'RV60');
                await loadBibleFile('biblias/NVI.json', 'json', 'NVI');
                await loadBibleFile('biblias/NTV.mybible', 'sqlite', 'NTV');

                if (Object.keys(bibleLibrary).length === 0) {
                    showToast("Sin biblias. Comprueba la carpeta /biblias", "alert-triangle");
                }

                renderReaderVersions();
                renderReaderContent(appState.readerLocation.scroll || 0);

            } catch (err) {
                console.error("Error initReader:", err);
            } finally {
                document.getElementById('reader-loading').style.display = 'none';
                isReaderLoading = false;
            }
        }

        async function loadBibleFile(url, type, name) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                if (type === 'json') {
                    const data = await response.json();
                    let items = Array.isArray(data) ? data : (data.verses || data.data || data.Bible || []);
                    if (!Array.isArray(items) && typeof items === 'object') items = Object.values(items).find(v => Array.isArray(v)) || [];
                    bibleLibrary[name] = { name, type: 'json', data: items };
                } else if (type === 'sqlite') {
                    const buffer = await response.arrayBuffer();
                    const db = new readerSQL.Database(new Uint8Array(buffer));
                    const res = db.exec("SELECT Book, Chapter, Verse, Scripture FROM Bible");
                    if (res && res.length > 0) {
                        const columns = res[0].columns;
                        const values = res[0].values;
                        const items = values.map(row => {
                            let obj = {};
                            columns.forEach((col, i) => obj[col] = row[i]);
                            return obj;
                        });
                        bibleLibrary[name] = { name, type: 'sqlite', data: items };
                    }
                }
            } catch (e) {
                console.error(`Error ${name}:`, e);
                // Detailed error mapping
                let msg = e.message;
                if (msg === 'Failed to fetch') msg = "No se pudo conectar al servidor local";
                showToast(`Error ${name}: ${msg}`, "x-circle");
            }
        }

        function renderReaderVersions() {
            const container = document.getElementById('reader-versions');
            if (!container) return;
            container.innerHTML = Object.keys(bibleLibrary).map(v => `
                <div class="version-pill-item ${v === appState.readerLocation.version ? 'active' : ''}" 
                     onclick="switchReaderVersion('${v}')">${v}</div>
            `).join('');

            // Sync header tag
            const tag = document.getElementById('reader-current-version-tag');
            if (tag) tag.textContent = appState.readerLocation.version;
        }

        function switchReaderVersion(v) {
            appState.readerLocation.version = v;
            save();
            renderReaderVersions();

            // Sync header tag
            const tag = document.getElementById('reader-current-version-tag');
            if (tag) tag.textContent = v;

            renderReaderContent(appState.readerLocation.scroll || 0);
        }

        // --- NEW READER SELECTOR LOGIC ---
        function openReaderSelector() {
            renderReaderSelectorBooks();
            document.getElementById('reader-selector-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeReaderSelector() { closeModalWithAnim('reader-selector-modal'); }

        function renderReaderSelectorBooks() {
            const content = document.getElementById('selector-modal-content');
            const title = document.getElementById('selector-modal-title');
            title.textContent = "Seleccionar Libro";

            content.innerHTML = `
                <div class="selector-grid">
                    ${BOOKS.map(b => `
                        <div class="selector-item ${b.id === appState.readerLocation.book ? 'active' : ''}" 
                             onclick="selectReaderBook(${b.id})">
                            ${b.n}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function selectReaderBook(id) {
            const book = BOOKS.find(b => b.id === id);
            renderReaderSelectorChapters(book);
        }

        function renderReaderSelectorChapters(book) {
            const content = document.getElementById('selector-modal-content');
            const title = document.getElementById('selector-modal-title');
            title.textContent = `${book.n}: Seleccionar Capítulo`;

            content.innerHTML = `
                <div style="margin-bottom:20px;">
                    <button class="btn btn-outline" onclick="renderReaderSelectorBooks()" style="padding:8px 12px; font-size:12px;">
                        <i data-lucide="chevron-left" style="width:14px;"></i> Volver a libros
                    </button>
                </div>
                <div class="chapter-circles">
                    ${Array.from({ length: book.c }, (_, i) => i + 1).map(c => `
                        <div class="chapter-pill ${c === appState.readerLocation.chapter && book.id === appState.readerLocation.book ? 'read' : ''}" 
                             onclick="selectReaderChapter(${book.id}, ${c})">
                            ${c}
                        </div>
                    `).join('')}
                </div>
            `;
            lucide.createIcons();
        }

        function selectReaderChapter(bookId, chapter) {
            appState.readerLocation.book = bookId;
            appState.readerLocation.chapter = chapter;
            appState.readerLocation.scroll = 0;
            save();
            closeReaderSelector();
            renderReaderContent(0);
        }

        function renderReaderContent(targetScroll = 0) {
            const { version, book, chapter } = appState.readerLocation;
            const bible = bibleLibrary[version];
            const settings = appState.readerSettings || { fontSize: 17, fontFamily: 'sans', theme: 'light' };

            // Update Header Display
            const bookObj = BOOKS.find(b => b.id === book);
            const headerDisplay = document.getElementById('reader-current-book-ch');
            if (headerDisplay && bookObj) {
                headerDisplay.textContent = `${bookObj.n} ${chapter}`;
            }

            const textContainer = document.getElementById('reader-text');
            if (!textContainer) return;

            // Apply settings
            textContainer.style.setProperty('--reader-font-size', settings.fontSize + 'px');
            textContainer.classList.remove('font-sans', 'font-serif', 'font-mono');
            textContainer.classList.add(`font-${settings.fontFamily}`);

            if (!bible) {
                textContainer.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.5;">Versión ${version} no cargada.</div>`;
                return;
            }

            // Map data fields based on type
            const isSqlite = bible.type === 'sqlite';
            const firstVerse = bible.data[0] || {};
            const keys = Object.keys(firstVerse);

            const bKey = isSqlite ? 'Book' : (keys.find(k => /book|libro|id1/i.test(k)) || keys[0]);
            const cKey = isSqlite ? 'Chapter' : (keys.find(k => /chapter|capitulo|id2/i.test(k)) || keys[1]);
            const vKey = isSqlite ? 'Verse' : (keys.find(k => /verse|versiculo|id3/i.test(k)) || keys[4] || keys[2]);
            const tKey = isSqlite ? 'Scripture' : (keys.find(k => /scripture|texto|text|vtext/i.test(k)) || keys[3]);

            const verses = bible.data
                .filter(v => parseInt(v[bKey]) === book && parseInt(v[cKey]) === chapter)
                .sort((a, b) => parseInt(a[vKey]) - parseInt(b[vKey]));

            if (verses.length === 0) {
                textContainer.innerHTML = `<div style="text-align:center; padding:40px; opacity:0.5;">Capítulo no disponible en esta versión.</div>`;
                return;
            }

            textContainer.innerHTML = verses.map((v, idx) => {
                const verseNum = parseInt(v[vKey]);
                const text = cleanReaderText(v[tKey], version);
                const highlightKey = `${version}-${book}-${chapter}-${verseNum}`;
                const highlightColor = appState.highlights[highlightKey] || "";

                // Block continuity logic
                const prevV = verses[idx - 1];
                const nextV = verses[idx + 1];
                const prevH = prevV ? appState.highlights[`${version}-${book}-${chapter}-${parseInt(prevV[vKey])}`] : null;
                const nextH = nextV ? appState.highlights[`${version}-${book}-${chapter}-${parseInt(nextV[vKey])}`] : null;

                let blockClass = "";
                if (highlightColor) {
                    if (highlightColor !== prevH) blockClass += " highlight-start";
                    if (highlightColor !== nextH) blockClass += " highlight-end";
                }

                const hasNote = appState.notes.some(n => n.bookId === book && n.chapter === chapter && (n.vStart === verseNum || (n.vStart <= verseNum && n.vEnd >= verseNum)));

                const currentSelection = selectedVersesByVersion[version] || [];
                const isSelected = currentSelection.some(sv => sv.verse === verseNum);
                let selClass = isSelected ? "selected-ui" : "";

                if (isSelected) {
                    const sortedSel = [...currentSelection].sort((a, b) => a.verse - b.verse);
                    const selIdx = sortedSel.findIndex(sv => sv.verse === verseNum);
                    const prevSel = selIdx > 0 && sortedSel[selIdx - 1].verse === verseNum - 1;
                    const nextSel = selIdx < sortedSel.length - 1 && sortedSel[selIdx + 1].verse === verseNum + 1;
                    if (!prevSel) selClass += " selection-start";
                    if (!nextSel) selClass += " selection-end";
                }

                return `
                    <div class="verse-item ${highlightColor ? 'highlight-' + highlightColor : ''} ${blockClass} ${hasNote ? 'verse-has-note' : ''} ${selClass}" 
                         data-verse="${verseNum}"
                         onclick="toggleVerseSelection(${book}, ${chapter}, ${verseNum}, this)">
                        <span class="verse-num-badge">${verseNum}</span>
                        <div class="verse-text">${text}</div>
                    </div>`;
            }).join('');

            // Add "Mark as Read" button at the end
            const isRead = (appState.reading[book] || []).includes(chapter);
            const markReadHtml = `
                <div style="margin-top: 40px; padding: 20px; border-top: 1px solid var(--border); text-align: center;">
                    <button class="btn ${isRead ? 'btn-prayed' : 'btn-outline'}" 
                            style="width: 100%; max-width: 250px; margin: 0 auto; gap: 8px;" 
                            onclick="toggleReaderChapterRead()">
                        <i data-lucide="${isRead ? 'check-circle' : 'circle'}"></i>
                        ${isRead ? 'Capítulo Leído' : 'Marcar como Leído'}
                    </button>
                </div>
            `;
            textContainer.innerHTML += markReadHtml;
            lucide.createIcons();

            // Restore scroll position
            const container = document.getElementById('view-reader');
            container.scrollTop = targetScroll;
        }

        function readerNav(dir) {
            let { book: bookId, chapter } = appState.readerLocation;
            const book = BOOKS.find(b => b.id === bookId);

            if (dir === 1) { // Next
                if (chapter < book.c) {
                    appState.readerLocation.chapter++;
                } else if (bookId < 66) {
                    appState.readerLocation.book++;
                    appState.readerLocation.chapter = 1;
                }
            } else { // Prev
                if (chapter > 1) {
                    appState.readerLocation.chapter--;
                } else if (bookId > 1) {
                    appState.readerLocation.book--;
                    const prevBook = BOOKS.find(b => b.id === appState.readerLocation.book);
                    appState.readerLocation.chapter = prevBook.c;
                }
            }

            appState.readerLocation.scroll = 0;
            renderReaderContent(0);
            save();
        }

        function toggleReaderChapterRead() {
            const { book, chapter } = appState.readerLocation;
            if (!appState.reading[book]) appState.reading[book] = [];

            const idx = appState.reading[book].indexOf(chapter);
            const bookObj = BOOKS.find(b => b.id === book);
            const wasCompleted = appState.reading[book].length === bookObj.c;

            if (idx > -1) {
                appState.reading[book].splice(idx, 1);
                showToast("Capítulo marcado como no leído");
            } else {
                appState.reading[book].push(chapter);
                showToast("¡Capítulo leído! ✨", "check");
                if (navigator.vibrate) navigator.vibrate(20);
            }

            save();
            renderReaderContent(appState.readerLocation.scroll || 0);
            renderBible(); // Sync the bible view progress

            if (idx === -1 && !wasCompleted && appState.reading[book].length === bookObj.c) {
                showCongrats(bookObj.n);
            }
            checkAchievements();
        }

        // --- PRAYER LOGIC ---
        let editingPrayerId = null;
        function openPrayerModal(editId = null) {
            editingPrayerId = editId;
            const modal = document.getElementById('prayer-modal');
            const titleInput = document.getElementById('p-title');
            const detailsInput = document.getElementById('p-details');
            const modalTitle = document.querySelector('#prayer-modal h3');
            const saveBtn = document.querySelector('#prayer-modal .btn-primary');

            if (editId) {
                const p = appState.prayers.find(x => x.id === editId);
                titleInput.value = p.title;
                detailsInput.value = p.details || '';
                modalTitle.textContent = 'Editar Oración';
                saveBtn.textContent = 'Actualizar Petición';
            } else {
                titleInput.value = '';
                detailsInput.value = '';
                modalTitle.textContent = 'Nueva Oración';
                saveBtn.textContent = 'Guardar Petición';
            }
            modal.style.display = 'flex';
            autoResize(detailsInput);
        }

        function closePrayerModal() { editingPrayerId = null; closeModalWithAnim('prayer-modal'); }

        function addPrayer() {
            const t = document.getElementById('p-title').value;
            const d = document.getElementById('p-details').value;
            if (!t) return;

            if (editingPrayerId) {
                const p = appState.prayers.find(x => x.id === editingPrayerId);
                p.title = t;
                p.details = d;
                editingPrayerId = null;
                showToast("Oración actualizada", "check");
            } else {
                appState.prayers.push({
                    id: Date.now(),
                    title: t,
                    details: d,
                    created: new Date().toISOString(),
                    responded: null,
                    status: 'active'
                });
                showToast("Petición guardada", "check");
            }

            save(); renderPrayers(); closePrayerModal();
        }

        function togglePrayerExpansion(id) {
            const el = document.getElementById(`prayer-${id}`);
            el.classList.toggle('expanded');
        }

        function renderPrayers() {
            const active = document.getElementById('prayers-active'); const done = document.getElementById('prayers-answered');
            active.innerHTML = ''; done.innerHTML = '';
            const todayStr = localDateStr();

            appState.prayers.forEach(p => {
                const card = document.createElement('div');
                card.className = 'prayer-tile';
                card.id = `prayer-${p.id}`;
                const cDate = new Date(p.created).toLocaleDateString();

                if (p.status === 'active') {
                    const prayedToday = p.lastPrayed === todayStr;
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div onclick="togglePrayerExpansion(${p.id})" style="flex:1;">
                                <h3><i data-lucide="flame"></i> ${p.title}</h3>
                                <div class="prayer-meta">Iniciada el ${cDate}</div>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn-icon" onclick="openPrayerModal(${p.id})"><i data-lucide="edit-3" style="width:16px;"></i></button>
                                <button class="btn-icon" onclick="deletePrayer(${p.id})" style="color:#ff4757;"><i data-lucide="trash-2" style="width:16px;"></i></button>
                            </div>
                        </div>
                        <div class="prayer-body" onclick="togglePrayerExpansion(${p.id})">
                            <p style="font-size: 14px; color: var(--text-muted);">${p.details || ''}</p>
                            <div class="prayer-btns">
                                <button class="btn btn-outline ${prayedToday ? 'btn-prayed' : ''}" onclick="event.stopPropagation(); markPrayedToday(${p.id})">
                                    ${prayedToday ? '¡Amén!' : 'Oré hoy'}
                                </button>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); markAnswered(${p.id})">Respondida</button>
                            </div>
                        </div>`;
                    active.prepend(card);
                } else {
                    const days = Math.floor((new Date(p.responded) - new Date(p.created)) / 86400000);
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div onclick="togglePrayerExpansion(${p.id})" style="flex:1;">
                                <h3><i data-lucide="check-circle" style="color:var(--success)"></i> ${p.title}</h3>
                                <div class="prayer-meta">Respondida después de ${days} días</div>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn-icon" onclick="restorePrayer(${p.id})"><i data-lucide="rotate-ccw" style="width:18px;"></i></button>
                                <button class="btn-icon" onclick="deletePrayer(${p.id})" style="color:#ff4757;"><i data-lucide="trash-2" style="width:16px;"></i></button>
                            </div>
                        </div>
                        <div class="prayer-body" onclick="togglePrayerExpansion(${p.id})">
                            <p style="font-size: 14px; color: var(--text-muted);">${p.details || ''}</p>
                            <div class="prayer-meta" style="margin-top: 12px; opacity: 0.7;">Iniciada el ${cDate}</div>
                        </div>`;
                    done.prepend(card);
                }
            });
            lucide.createIcons();
        }
        function markAnswered(id) { const p = appState.prayers.find(x => x.id === id); p.status = 'answered'; p.responded = new Date().toISOString(); save(); renderPrayers(); }
        function restorePrayer(id) { const p = appState.prayers.find(x => x.id === id); p.status = 'active'; p.responded = null; save(); renderPrayers(); }

        function deletePrayer(id) {
            const modal = document.getElementById('confirm-modal');
            const btn = document.getElementById('btn-confirm-delete');
            modal.style.display = 'flex';
            btn.onclick = () => {
                appState.prayers = appState.prayers.filter(p => p.id !== id);
                save();
                renderPrayers();
                closeConfirmModal();
                showToast("Oración eliminada correctamente", "trash-2");
            };
        }
        function closeConfirmModal() { closeModalWithAnim('confirm-modal'); }

        function markPrayedToday(id) {
            const p = appState.prayers.find(x => x.id === id);
            const todayStr = localDateStr();
            if (p.lastPrayed === todayStr) return; // Already prayed

            p.lastPrayed = todayStr;
            save();
            renderPrayers();
            if (navigator.vibrate) navigator.vibrate([20, 30, 20]);
        }


        // Cerrar modales al hacer clic fuera (en el overlay)
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    if (overlay.id === 'calendar-overlay') closeCalendarPicker();
                    if (overlay.id === 'bible-modal') closeBibleModal();
                    if (overlay.id === 'camera-modal') closeCameraUI();
                    if (overlay.id === 'prayer-modal') closePrayerModal();
                    if (overlay.id === 'confirm-modal') closeConfirmModal();
                    if (overlay.id === 'note-modal') closeNoteModal();
                    if (overlay.id === 'reader-note-modal') closeReaderNoteModal();
                    if (overlay.id === 'achievements-modal') closeAchievementsModal();
                    if (overlay.id === 'achievement-unlocked-modal') closeUnlockModal();
                    if (overlay.id === 'reader-selector-modal') closeReaderSelector();
                    if (overlay.id === 'reader-settings-modal') closeReaderSettings();
                }
            });
        });

        // --- READER FEATURES: HIGHLIGHTS & NOTES ---
        let selectedVersesByVersion = {}; // Version-indexed arrays of { bookId, chapter, verse, id }

        function toggleVerseSelection(bookId, chapter, verse, element) {
            const version = appState.readerLocation.version;
            if (!selectedVersesByVersion[version]) selectedVersesByVersion[version] = [];
            const selectedVerses = selectedVersesByVersion[version];

            const id = `${version}-${bookId}-${chapter}-${verse}`;
            const index = selectedVerses.findIndex(v => v.id === id);

            if (index > -1) {
                selectedVerses.splice(index, 1);
            } else {
                if (selectedVerses.length > 0 && (selectedVerses[0].bookId !== bookId || selectedVerses[0].chapter !== chapter)) {
                    selectedVersesByVersion[version] = [];
                }
                selectedVersesByVersion[version].push({ bookId, chapter, verse, id });
            }

            // Redraw content to update classes (start/end logic is complex to do via direct DOM manipulation accurately)
            renderReaderContent(appState.readerLocation.scroll || 0);

            if (selectedVersesByVersion[version].length > 0) {
                showReaderToolbar();
            } else {
                hideReaderToolbar();
            }
        }

        function showReaderToolbar() {
            const toolbar = document.getElementById('reader-toolbar');
            toolbar.classList.add('active');
            if (navigator.vibrate) navigator.vibrate(10);
        }

        function hideReaderToolbar() {
            const toolbar = document.getElementById('reader-toolbar');
            toolbar.classList.remove('active');
            const version = appState.readerLocation.version;
            selectedVersesByVersion[version] = [];
            renderReaderContent(appState.readerLocation.scroll || 0);
        }

        function applyReaderHighlight(color) {
            const version = appState.readerLocation.version;
            const selectedVerses = selectedVersesByVersion[version] || [];
            if (selectedVerses.length === 0) return;
            selectedVerses.forEach(v => {
                if (color) {
                    appState.highlights[v.id] = color;
                } else {
                    delete appState.highlights[v.id];
                }
            });
            save();
            renderReaderContent(appState.readerLocation.scroll || 0);
            hideReaderToolbar();
        }

        async function shareVerse() {
            const version = appState.readerLocation.version;
            const selectedVerses = selectedVersesByVersion[version] || [];
            if (selectedVerses.length === 0) return;

            selectedVerses.sort((a, b) => a.verse - b.verse);
            const bookObj = BOOKS.find(b => b.id === selectedVerses[0].bookId);
            const chapter = selectedVerses[0].chapter;

            let texts = [];
            let verseNums = [];

            selectedVerses.forEach(v => {
                const el = document.querySelector(`.verse-item[onclick*="${v.verse}, this"] .verse-text`);
                if (el) {
                    texts.push(el.textContent);
                    verseNums.push(v.verse);
                }
            });

            let verseStr = "";
            if (verseNums.length > 0) {
                const min = Math.min(...verseNums);
                const max = Math.max(...verseNums);
                if (max - min === verseNums.length - 1) {
                    verseStr = min === max ? `${min}` : `${min}-${max}`;
                } else {
                    verseStr = verseNums.join(', ');
                }
            }

            const shareText = `"${texts.join(' ')}"\n\n${bookObj.n.toUpperCase()} ${chapter}:${verseStr} - ${version}`;

            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Compartir Versículos',
                        text: shareText
                    });
                } catch (err) { }
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    showToast("Copiado al portapapeles", "clipboard");
                });
            }
            hideReaderToolbar();
        }

        function openReaderNoteModal() {
            editingNoteFromModalId = null;
            const version = appState.readerLocation.version;
            const selectedVerses = selectedVersesByVersion[version] || [];
            if (selectedVerses.length === 0) return;

            selectedVerses.sort((a, b) => a.verse - b.verse);
            const vStart = selectedVerses[0].verse;
            const vEnd = selectedVerses.length > 1 ? selectedVerses[selectedVerses.length - 1].verse : 0;
            const book = BOOKS.find(b => b.id === selectedVerses[0].bookId);
            const chapter = selectedVerses[0].chapter;

            let verseStr = vEnd ? `${vStart}-${vEnd}` : vStart;
            document.getElementById('reader-note-title').textContent = `Nota en ${book.n} ${chapter}:${verseStr}`;

            const existing = appState.notes.find(n => n.bookId === book.id && n.chapter === chapter && n.vStart === vStart && n.vEnd === vEnd);
            document.getElementById('reader-note-input').value = existing ? existing.note : '';

            document.getElementById('reader-note-modal').style.display = 'flex';
            autoResize(document.getElementById('reader-note-input'));
            lucide.createIcons();
        }

        function closeReaderNoteModal() {
            editingNoteFromModalId = null;
            hideReaderToolbar();
            closeModalWithAnim('reader-note-modal');
        }

        function saveReaderNote() {
            const text = document.getElementById('reader-note-input').value.trim();
            if (!text) return;

            if (editingNoteFromModalId) {
                const n = appState.notes.find(x => x.id === editingNoteFromModalId);
                n.note = text;
            } else {
                const version = appState.readerLocation.version;
                const selectedVerses = selectedVersesByVersion[version] || [];
                if (selectedVerses.length === 0) return;
                selectedVerses.sort((a, b) => a.verse - b.verse);
                const bookObj = BOOKS.find(b => b.id === selectedVerses[0].bookId);
                const chapter = selectedVerses[0].chapter;
                const vStart = selectedVerses[0].verse;
                const vEnd = selectedVerses.length > 1 ? selectedVerses[selectedVerses.length - 1].verse : 0;

                let texts = [];
                selectedVerses.forEach(v => {
                    const el = document.querySelector(`.verse-item[onclick*="${v.verse}, this"] .verse-text`);
                    if (el) texts.push(el.textContent);
                });
                const combinedVerseText = texts.join(' ');

                const existingIdx = appState.notes.findIndex(n => n.bookId === bookObj.id && n.chapter === chapter && n.vStart === vStart && n.vEnd === vEnd);

                if (existingIdx !== -1) {
                    appState.notes[existingIdx].note = text;
                    appState.notes[existingIdx].vText = combinedVerseText;
                } else {
                    appState.notes.push({
                        id: Date.now(),
                        book: bookObj.n,
                        bookId: bookObj.id,
                        chapter: chapter,
                        vStart: vStart,
                        vEnd: vEnd,
                        note: text,
                        vText: combinedVerseText,
                        version: version
                    });
                }
            }

            save();
            if (document.getElementById('view-reader').classList.contains('active')) {
                renderReaderContent(appState.readerLocation.scroll || 0);
            }
            if (document.getElementById('view-notes').classList.contains('active')) {
                renderNotes();
            }
            closeReaderNoteModal();
            showToast("Nota guardada ✨", "check");
            const version = appState.readerLocation.version;
            selectedVersesByVersion[version] = [];
            editingNoteFromModalId = null;
        }

        // --- ACHIEVEMENT LOGIC ---
        function checkAchievements() {
            let newlyUnlocked = [];
            const globalRead = Object.values(appState.reading).reduce((acc, val) => acc + val.length, 0);
            const totalChapters = 1189;
            const globPct = (globalRead / totalChapters) * 100;

            if (!appState.unlockedAchievements) appState.unlockedAchievements = [];
            if (!appState.totalCompletions) appState.totalCompletions = 0;

            // Check Percentages
            ACHIEVEMENTS.BY_PCT.forEach(ach => {
                if (ach.pct !== undefined) {
                    if (globPct >= ach.pct && !appState.unlockedAchievements.includes(ach.id)) {
                        appState.unlockedAchievements.push(ach.id);
                        newlyUnlocked.push(ach);
                        if (ach.id === 'pct_100') {
                            appState.totalCompletions++;
                        }
                    }
                } else if (ach.count !== undefined) {
                    if (appState.totalCompletions >= ach.count && !appState.unlockedAchievements.includes(ach.id)) {
                        appState.unlockedAchievements.push(ach.id);
                        newlyUnlocked.push(ach);
                    }
                }
            });

            // Check Book Collections
            ACHIEVEMENTS.BY_BOOKS.forEach(ach => {
                const allCompleted = ach.books.every(bid => {
                    const book = BOOKS.find(b => b.id === bid);
                    return (appState.reading[bid] || []).length === book.c;
                });
                if (allCompleted && !appState.unlockedAchievements.includes(ach.id)) {
                    appState.unlockedAchievements.push(ach.id);
                    newlyUnlocked.push(ach);
                }
            });

            if (newlyUnlocked.length > 0) {
                save();
                // Show popups one by one with a small delay
                newlyUnlocked.forEach((ach, index) => {
                    setTimeout(() => showAchievementPopup(ach), index * 1000);
                });
            }
        }

        function showAchievementPopup(ach) {
            document.getElementById('unlock-emoji').textContent = ach.emoji;
            document.getElementById('unlock-name').textContent = ach.name;
            document.getElementById('unlock-desc').textContent = ach.desc;
            document.getElementById('achievement-unlocked-modal').style.display = 'flex';
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        }

        function closeUnlockModal() { closeModalWithAnim('achievement-unlocked-modal'); }

        function openAchievementsModal() {
            renderAchievements();
            document.getElementById('achievements-modal').style.display = 'flex';
            lucide.createIcons();
        }

        function closeAchievementsModal() { closeModalWithAnim('achievements-modal'); }

        function renderAchievements() {
            const pctGrid = document.getElementById('achievements-pct-grid');
            const booksGrid = document.getElementById('achievements-books-grid');
            if (!pctGrid || !booksGrid) return;

            const globalRead = Object.values(appState.reading).reduce((acc, val) => acc + val.length, 0);
            const totalChapters = 1189;
            const globPct = (globalRead / totalChapters) * 100;

            pctGrid.innerHTML = ACHIEVEMENTS.BY_PCT.map(ach => {
                const isUnlocked = appState.unlockedAchievements.includes(ach.id);
                let progress = 0;
                if (ach.pct !== undefined) {
                    progress = Math.min(100, (globPct / ach.pct) * 100);
                } else if (ach.count !== undefined) {
                    progress = Math.min(100, (appState.totalCompletions / ach.count) * 100);
                }

                return `
                    <div class="achievement-tile ${isUnlocked ? 'unlocked' : ''}" onclick="this.classList.toggle('expanded')">
                        <span class="achievement-icon">${ach.emoji}</span>
                        <span class="achievement-name">${ach.name}</span>
                        
                        <div class="achievement-progress-container">
                            <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <span class="achievement-pct-label">${Math.round(progress)}%</span>

                        <span class="achievement-desc">${ach.desc}</span>
                    </div>
                `;
            }).join('');

            booksGrid.innerHTML = ACHIEVEMENTS.BY_BOOKS.map(ach => {
                const isUnlocked = appState.unlockedAchievements.includes(ach.id);
                const collectionTotal = ach.books.length;
                const collectionDone = ach.books.filter(bid => {
                    const book = BOOKS.find(b => b.id === bid);
                    return (appState.reading[bid] || []).length === book.c;
                }).length;
                const progress = (collectionDone / collectionTotal) * 100;

                return `
                    <div class="achievement-tile ${isUnlocked ? 'unlocked' : ''}" onclick="this.classList.toggle('expanded')">
                        <span class="achievement-icon">${ach.emoji}</span>
                        <span class="achievement-name">${ach.name}</span>

                        <div class="achievement-progress-container">
                            <div class="achievement-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        <span class="achievement-pct-label">${collectionDone}/${collectionTotal} Libros</span>

                        <span class="achievement-desc">${ach.desc}</span>
                    </div>
                `;
            }).join('');
        }

        // --- READER SETTINGS LOGIC ---
        function openReaderSettings() {
            document.getElementById('reader-settings-modal').style.display = 'flex';
            // Sync UI
            const settings = appState.readerSettings || { fontSize: 17, fontFamily: 'sans', theme: 'light' };
            document.getElementById('font-size-slider').value = settings.fontSize;

            document.querySelectorAll('.theme-opt').forEach(opt => opt.classList.remove('active'));
            const themeOpt = document.getElementById(`theme-${appState.theme}`);
            if (themeOpt) themeOpt.classList.add('active');

            document.querySelectorAll('.font-opt').forEach(opt => opt.classList.remove('active'));
            const fontOpt = document.getElementById(`font-${settings.fontFamily}`);
            if (fontOpt) fontOpt.classList.add('active');

            lucide.createIcons();
        }

        function closeReaderSettings() { closeModalWithAnim('reader-settings-modal'); }

        function setReaderFontSize(size) {
            if (!appState.readerSettings) appState.readerSettings = { fontSize: 17, fontFamily: 'sans' };
            appState.readerSettings.fontSize = size;
            const content = document.getElementById('reader-text');
            if (content) content.style.setProperty('--reader-font-size', size + 'px');
            save();
        }

        function setReaderFontFamily(family) {
            if (!appState.readerSettings) appState.readerSettings = { fontSize: 17, fontFamily: 'sans' };
            appState.readerSettings.fontFamily = family;

            const content = document.getElementById('reader-text');
            if (content) {
                content.classList.remove('font-sans', 'font-serif', 'font-mono');
                content.classList.add(`font-${family}`);
            }

            document.querySelectorAll('.font-opt').forEach(opt => opt.classList.remove('active'));
            const opt = document.getElementById(`font-${family}`);
            if (opt) opt.classList.add('active');
            save();
        }

        function setReaderTheme(theme) {
            setTheme(theme);
        }

        init();

        // PWA Service Worker Registration & Auto-Update
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(reg => {
                    // Verificación forzada cada vez que se abre la app
                    reg.update();

                    reg.onupdatefound = () => {
                        const newWorker = reg.installing;
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showToast('App actualizada a la última versión ✨', 'refresh-cw');
                                // Recargamos después del toast para que el usuario use la nueva versión
                                setTimeout(() => window.location.reload(), 2000);
                            }
                        };
                    };
                }).catch(err => console.log('SW Failed', err));
            });

            // Detectar cuando el Service Worker toma el control (activación)
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    // No hace falta hacer nada aquí si ya manejamos installed, 
                    // pero asegura que la página se sincronice
                }
            });
        }
    </script>
</body>

</html>